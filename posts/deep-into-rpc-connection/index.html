<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.148.2"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Joway"><meta property="og:url" content="https://blog.joway.io/posts/deep-into-rpc-connection/"><link rel=canonical href=https://blog.joway.io/posts/deep-into-rpc-connection/><link rel=dns-prefetch href=https://cdn.jsdelivr.net/gh/joway/blog><link rel=apple-touch-icon href=/logo.png><link rel=icon href=/logo.png><link rel=shortcut href=/logo.png><link rel=alternate type=application/atom+xml href=https://blog.joway.io/index.xml title="Random Thoughts"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.joway.io\/"},"articleSection":"posts","name":"RPC æ¼«è°ˆï¼š è¿æ¥é—®é¢˜","headline":"RPC æ¼«è°ˆï¼š è¿æ¥é—®é¢˜","description":"ä»€ä¹ˆæ˜¯è¿æ¥ åœ¨ç‰©ç†ä¸–ç•Œå¹¶ä¸å­˜åœ¨è¿æ¥è¿™ä¹ˆä¸€è¯´ï¼Œæ•°æ®è½¬æ¢ä¸ºå…‰\/ç”µä¿¡å·åï¼Œä»ä¸€å°æœºå™¨å‘å¾€å¦ä¸€å°æœºå™¨ï¼Œä¸­é—´è®¾å¤‡é€šè¿‡ä¿¡å·è§£æå‡ºç›®çš„ä¿¡æ¯æ¥ç¡®å®šå¦‚ä½•è½¬å‘åŒ…ã€‚æˆ‘ä»¬æ—¥å¸¸æ‰€è°“çš„ã€Œè¿æ¥ã€çº¯ç²¹æ˜¯ä¸€ä¸ªäººä¸ºæŠ½è±¡çš„æ¦‚å¿µï¼Œç›®çš„æ˜¯å°†ä¼ è¾“è¿›æ¥çš„æ— çŠ¶æ€æ•°æ®é€šè¿‡æŸä¸ªå›ºå®šå­—æ®µä½œä¸ºæ ‡è¯†ï¼Œåˆ†ç±»ä¸ºä¸åŒæœ‰çŠ¶æ€ä¼šè¯ï¼Œä»è€Œæ–¹ä¾¿åœ¨ä¼ è¾“å±‚å»å®ç°ä¸€äº›ä¾èµ–çŠ¶æ€çš„äº‹æƒ…ã€‚\nä»¥ TCP ä¸ºä¾‹ï¼Œä¸€å¼€å§‹çš„ä¸‰æ¬¡æ¡æ‰‹ç”¨æ¥åœ¨åŒæ–¹ç¡®è®¤ä¸€ä¸ªåˆå§‹åºåˆ—å·ï¼ˆInitial Sequence Numbersï¼ŒISNï¼‰ï¼Œè¿™ä¸ª ISN æ ‡å¿—äº†ä¸€ä¸ª TCP ä¼šè¯ï¼Œå¹¶ä¸”è¿™ä¸ªä¼šè¯æœ‰ä¸€ä¸ªç‹¬å çš„äº”å…ƒç»„ï¼ˆæº IP åœ°å€ï¼Œæºç«¯å£ï¼Œç›®çš„ IP åœ°å€ï¼Œç›®çš„ç«¯å£ï¼Œä¼ è¾“å±‚åè®®ï¼‰ã€‚åœ¨ç‰©ç†æ„ä¹‰ä¸Šï¼Œä¸€ä¸ª TCP ä¼šè¯ç­‰ä»·äºé€šå¾€æŸä¸€ä¸ªæœåŠ¡å™¨çš„ç›¸å¯¹å›ºå®šè·¯çº¿ï¼ˆå³å›ºå®šçš„ä¸­é—´ç‰©ç†è®¾å¤‡é›†åˆï¼‰ï¼Œæ­£æ˜¯ç”±äºè¿™æ ·ï¼Œæˆ‘ä»¬å»é’ˆå¯¹æ¯ä¸ª TCP ä¼šè¯è¿›è¡Œæœ‰çŠ¶æ€çš„æ‹¥å¡æ§åˆ¶ç­‰æ“ä½œæ‰æ˜¯æœ‰æ„ä¹‰çš„ã€‚\nè¿æ¥çš„å¼€é”€ æˆ‘ä»¬å¸¸å¸¸å¬åˆ°è¿ç»´ä¼šè¯´æŸå°æœºå™¨è¿æ¥å¤ªå¤šæ‰€ä»¥å‡ºç°äº†æœåŠ¡æŠ–åŠ¨ï¼Œå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä¼šæ¥å—è¿™ä¸ªè¯´æ³•ç„¶åå»å°è¯•é™ä½è¿æ¥æ•°ã€‚ç„¶è€Œæˆ‘ä»¬å¾ˆå°‘å»æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ä¸€ä¸ªæœåŠ¡è¿æ¥æ•°è¿‡å¤šçš„æ—¶å€™ï¼Œæœºå™¨ä¸Šçš„ CPUï¼Œå†…å­˜ï¼Œç½‘å¡å¾€å¾€éƒ½æœ‰å¤§é‡çš„ç©ºä½™èµ„æºï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šæŠ–åŠ¨ï¼Ÿç»´æŠ¤ä¸€ä¸ªè¿æ¥çš„å…·ä½“å¼€é”€æ˜¯å“ªäº›ï¼Ÿ\nå†…å­˜å¼€é”€ï¼š\nTCP åè®®æ ˆä¸€èˆ¬ç”±æ“ä½œç³»ç»Ÿå®ç°ï¼Œå› ä¸ºè¿æ¥æ˜¯æœ‰çŠ¶æ€å¯¹ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿéœ€è¦åœ¨å†…å­˜ä¸­ä¿å­˜è¿™ä¸ªä¼šè¯ä¿¡æ¯ï¼Œè¿™ä¸ªå†…å­˜å¼€é”€æ¯ä¸ªè¿æ¥å¤§æ¦‚ 4kb ä¸åˆ°ã€‚\næ–‡ä»¶æè¿°ç¬¦å ç”¨ï¼š\nåœ¨ Linux è§†è§’ä¸­ï¼Œæ¯ä¸ªè¿æ¥éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œéƒ½ä¼šå ç”¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚æ–‡ä»¶æè¿°ç¬¦æ‰€å ç”¨çš„å†…å­˜å·²ç»è®¡ç®—åœ¨ä¸Šé¢çš„å†…å­˜å¼€é”€ä¸­ï¼Œä½†æ“ä½œç³»ç»Ÿä¸ºäº†ä¿æŠ¤å…¶è‡ªèº«çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ï¼Œä¼šé™åˆ¶æ•´ä¸ªç³»ç»Ÿå†…ä»¥åŠæ¯ä¸ªè¿›ç¨‹ä¸­å¯è¢«åŒæ—¶æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°ï¼š\n# æœºå™¨é…ç½®: Linux 1 æ ¸ 1 GB $ cat \/proc\/sys\/fs\/file-max 97292 $ ulimit -n 1024 ä¸Šé¢çš„è®¾ç½®è¡¨ç¤ºæ•´ä¸ªæ“ä½œç³»ç»Ÿæœ€å¤šèƒ½åŒæ—¶æ‰“å¼€ 97292 ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªè¿›ç¨‹æœ€å¤šåŒæ—¶æ‰“å¼€ 1024 ä¸ªæ–‡ä»¶ã€‚\nä¸¥æ ¼æ¥è¯´æ–‡ä»¶æè¿°ç¬¦æ ¹æœ¬ç®—ä¸ä¸Šæ˜¯ä¸€ä¸ªèµ„æºï¼ŒçœŸæ­£çš„èµ„æºæ˜¯å†…å­˜ã€‚å¦‚æœä½ æœ‰æ˜ç¡®çš„éœ€è¦ï¼Œå®Œå…¨å¯ä»¥é€šè¿‡è®¾ç½®ä¸€ä¸ªæå¤§å€¼ï¼Œè®©æ‰€æœ‰åº”ç”¨ç»•å¼€è¿™ä¸ªé™åˆ¶ã€‚\nçº¿ç¨‹å¼€é”€ï¼š\næœ‰ä¸€äº›è¾ƒè€çš„ Server å®ç°é‡‡ç”¨çš„è¿˜æ˜¯ä¸ºæ¯ä¸ªè¿æ¥ç‹¬å ï¼ˆæ–°å»ºæˆ–ä»è¿æ¥æ± ä¸­è·å–ï¼‰ä¸€ä¸ªçº¿ç¨‹æä¾›æœåŠ¡çš„æ–¹å¼ï¼Œå¯¹äºè¿™ç±»æœåŠ¡æ¥è¯´ï¼Œé™¤äº†è¿æ¥æœ¬èº«å ç”¨çš„å¤–ï¼Œè¿˜æœ‰çº¿ç¨‹çš„å›ºå®šå†…å­˜å¼€é”€ï¼š\n# æœºå™¨é…ç½®: Linux 1 æ ¸ 1 GB # æ“ä½œç³»ç»Ÿæœ€å¤§çº¿ç¨‹æ•° $ cat \/proc\/sys\/kernel\/threads-max 7619 # æ“ä½œç³»ç»Ÿå•è¿›ç¨‹æœ€å¤§çº¿ç¨‹æ•°ï¼Œundef è¡¨ç¤ºæœªé™åˆ¶ $ cat \/usr\/include\/bits\/local_lim.h \/* We have no predefined limit on the number of threads. *\/ #undef PTHREAD_THREADS_MAX # å•ä¸ªçº¿ç¨‹æ ˆé»˜è®¤å¤§å°ï¼Œå•ä½ä¸º KB $ ulimit -s 8192 åœ¨ä¸Šé¢è¿™å°æœºå™¨é‡Œï¼Œå…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°ä¸€æ–¹é¢å—æ“ä½œç³»ç»Ÿè‡ªèº«è®¾å®šå€¼é™åˆ¶ï¼Œä¸€æ–¹é¢ä¹Ÿå—å†…å­˜å¤§å°é™åˆ¶ã€‚ç”±äº 1024MB \/ 8MB = 128 \u0026gt; 7619 ï¼Œ æ‰€ä»¥è¿™å°æœºå™¨ä¸­èƒ½å¤Ÿåˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°ä¸º 128ã€‚å¦‚æœ Server é‡‡ç”¨ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªè¿æ¥ï¼Œé‚£ä¹ˆè¿™æ—¶ Server åŒæ—¶æœ€å¤šä¹Ÿåªèƒ½å¤Ÿä¸º 128 ä¸ªè¿æ¥æä¾›æœåŠ¡ã€‚\n","inLanguage":"en-US","author":"Joway","creator":"Joway","publisher":"Joway","accountablePerson":"Joway","copyrightHolder":"Joway","copyrightYear":"2021","datePublished":"2021-05-06 00:00:00 \u002b0000 UTC","dateModified":"2021-05-06 00:00:00 \u002b0000 UTC","url":"https:\/\/blog.joway.io\/posts\/deep-into-rpc-connection\/","keywords":["RPC","Service Mesh"]}</script><title>RPC æ¼«è°ˆï¼š è¿æ¥é—®é¢˜</title><meta property="og:title" content="RPC æ¼«è°ˆï¼š è¿æ¥é—®é¢˜"><meta property="og:type" content="article"><meta property="og:description" content="ä»€ä¹ˆæ˜¯è¿æ¥ åœ¨ç‰©ç†ä¸–ç•Œå¹¶ä¸å­˜åœ¨è¿æ¥è¿™ä¹ˆä¸€è¯´ï¼Œæ•°æ®è½¬æ¢ä¸ºå…‰/ç”µä¿¡å·åï¼Œä»ä¸€å°æœºå™¨å‘å¾€å¦ä¸€å°æœºå™¨ï¼Œä¸­é—´è®¾å¤‡é€šè¿‡ä¿¡å·è§£æå‡ºç›®çš„ä¿¡æ¯æ¥ç¡®å®šå¦‚ä½•è½¬å‘åŒ…ã€‚æˆ‘ä»¬æ—¥å¸¸æ‰€è°“çš„ã€Œè¿æ¥ã€çº¯ç²¹æ˜¯ä¸€ä¸ªäººä¸ºæŠ½è±¡çš„æ¦‚å¿µï¼Œç›®çš„æ˜¯å°†ä¼ è¾“è¿›æ¥çš„æ— çŠ¶æ€æ•°æ®é€šè¿‡æŸä¸ªå›ºå®šå­—æ®µä½œä¸ºæ ‡è¯†ï¼Œåˆ†ç±»ä¸ºä¸åŒæœ‰çŠ¶æ€ä¼šè¯ï¼Œä»è€Œæ–¹ä¾¿åœ¨ä¼ è¾“å±‚å»å®ç°ä¸€äº›ä¾èµ–çŠ¶æ€çš„äº‹æƒ…ã€‚
ä»¥ TCP ä¸ºä¾‹ï¼Œä¸€å¼€å§‹çš„ä¸‰æ¬¡æ¡æ‰‹ç”¨æ¥åœ¨åŒæ–¹ç¡®è®¤ä¸€ä¸ªåˆå§‹åºåˆ—å·ï¼ˆInitial Sequence Numbersï¼ŒISNï¼‰ï¼Œè¿™ä¸ª ISN æ ‡å¿—äº†ä¸€ä¸ª TCP ä¼šè¯ï¼Œå¹¶ä¸”è¿™ä¸ªä¼šè¯æœ‰ä¸€ä¸ªç‹¬å çš„äº”å…ƒç»„ï¼ˆæº IP åœ°å€ï¼Œæºç«¯å£ï¼Œç›®çš„ IP åœ°å€ï¼Œç›®çš„ç«¯å£ï¼Œä¼ è¾“å±‚åè®®ï¼‰ã€‚åœ¨ç‰©ç†æ„ä¹‰ä¸Šï¼Œä¸€ä¸ª TCP ä¼šè¯ç­‰ä»·äºé€šå¾€æŸä¸€ä¸ªæœåŠ¡å™¨çš„ç›¸å¯¹å›ºå®šè·¯çº¿ï¼ˆå³å›ºå®šçš„ä¸­é—´ç‰©ç†è®¾å¤‡é›†åˆï¼‰ï¼Œæ­£æ˜¯ç”±äºè¿™æ ·ï¼Œæˆ‘ä»¬å»é’ˆå¯¹æ¯ä¸ª TCP ä¼šè¯è¿›è¡Œæœ‰çŠ¶æ€çš„æ‹¥å¡æ§åˆ¶ç­‰æ“ä½œæ‰æ˜¯æœ‰æ„ä¹‰çš„ã€‚
è¿æ¥çš„å¼€é”€ æˆ‘ä»¬å¸¸å¸¸å¬åˆ°è¿ç»´ä¼šè¯´æŸå°æœºå™¨è¿æ¥å¤ªå¤šæ‰€ä»¥å‡ºç°äº†æœåŠ¡æŠ–åŠ¨ï¼Œå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä¼šæ¥å—è¿™ä¸ªè¯´æ³•ç„¶åå»å°è¯•é™ä½è¿æ¥æ•°ã€‚ç„¶è€Œæˆ‘ä»¬å¾ˆå°‘å»æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ä¸€ä¸ªæœåŠ¡è¿æ¥æ•°è¿‡å¤šçš„æ—¶å€™ï¼Œæœºå™¨ä¸Šçš„ CPUï¼Œå†…å­˜ï¼Œç½‘å¡å¾€å¾€éƒ½æœ‰å¤§é‡çš„ç©ºä½™èµ„æºï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šæŠ–åŠ¨ï¼Ÿç»´æŠ¤ä¸€ä¸ªè¿æ¥çš„å…·ä½“å¼€é”€æ˜¯å“ªäº›ï¼Ÿ
å†…å­˜å¼€é”€ï¼š
TCP åè®®æ ˆä¸€èˆ¬ç”±æ“ä½œç³»ç»Ÿå®ç°ï¼Œå› ä¸ºè¿æ¥æ˜¯æœ‰çŠ¶æ€å¯¹ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿéœ€è¦åœ¨å†…å­˜ä¸­ä¿å­˜è¿™ä¸ªä¼šè¯ä¿¡æ¯ï¼Œè¿™ä¸ªå†…å­˜å¼€é”€æ¯ä¸ªè¿æ¥å¤§æ¦‚ 4kb ä¸åˆ°ã€‚
æ–‡ä»¶æè¿°ç¬¦å ç”¨ï¼š
åœ¨ Linux è§†è§’ä¸­ï¼Œæ¯ä¸ªè¿æ¥éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œéƒ½ä¼šå ç”¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚æ–‡ä»¶æè¿°ç¬¦æ‰€å ç”¨çš„å†…å­˜å·²ç»è®¡ç®—åœ¨ä¸Šé¢çš„å†…å­˜å¼€é”€ä¸­ï¼Œä½†æ“ä½œç³»ç»Ÿä¸ºäº†ä¿æŠ¤å…¶è‡ªèº«çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ï¼Œä¼šé™åˆ¶æ•´ä¸ªç³»ç»Ÿå†…ä»¥åŠæ¯ä¸ªè¿›ç¨‹ä¸­å¯è¢«åŒæ—¶æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°ï¼š
# æœºå™¨é…ç½®: Linux 1 æ ¸ 1 GB $ cat /proc/sys/fs/file-max 97292 $ ulimit -n 1024 ä¸Šé¢çš„è®¾ç½®è¡¨ç¤ºæ•´ä¸ªæ“ä½œç³»ç»Ÿæœ€å¤šèƒ½åŒæ—¶æ‰“å¼€ 97292 ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªè¿›ç¨‹æœ€å¤šåŒæ—¶æ‰“å¼€ 1024 ä¸ªæ–‡ä»¶ã€‚
ä¸¥æ ¼æ¥è¯´æ–‡ä»¶æè¿°ç¬¦æ ¹æœ¬ç®—ä¸ä¸Šæ˜¯ä¸€ä¸ªèµ„æºï¼ŒçœŸæ­£çš„èµ„æºæ˜¯å†…å­˜ã€‚å¦‚æœä½ æœ‰æ˜ç¡®çš„éœ€è¦ï¼Œå®Œå…¨å¯ä»¥é€šè¿‡è®¾ç½®ä¸€ä¸ªæå¤§å€¼ï¼Œè®©æ‰€æœ‰åº”ç”¨ç»•å¼€è¿™ä¸ªé™åˆ¶ã€‚
çº¿ç¨‹å¼€é”€ï¼š
æœ‰ä¸€äº›è¾ƒè€çš„ Server å®ç°é‡‡ç”¨çš„è¿˜æ˜¯ä¸ºæ¯ä¸ªè¿æ¥ç‹¬å ï¼ˆæ–°å»ºæˆ–ä»è¿æ¥æ± ä¸­è·å–ï¼‰ä¸€ä¸ªçº¿ç¨‹æä¾›æœåŠ¡çš„æ–¹å¼ï¼Œå¯¹äºè¿™ç±»æœåŠ¡æ¥è¯´ï¼Œé™¤äº†è¿æ¥æœ¬èº«å ç”¨çš„å¤–ï¼Œè¿˜æœ‰çº¿ç¨‹çš„å›ºå®šå†…å­˜å¼€é”€ï¼š
# æœºå™¨é…ç½®: Linux 1 æ ¸ 1 GB # æ“ä½œç³»ç»Ÿæœ€å¤§çº¿ç¨‹æ•° $ cat /proc/sys/kernel/threads-max 7619 # æ“ä½œç³»ç»Ÿå•è¿›ç¨‹æœ€å¤§çº¿ç¨‹æ•°ï¼Œundef è¡¨ç¤ºæœªé™åˆ¶ $ cat /usr/include/bits/local_lim.h /* We have no predefined limit on the number of threads. */ #undef PTHREAD_THREADS_MAX # å•ä¸ªçº¿ç¨‹æ ˆé»˜è®¤å¤§å°ï¼Œå•ä½ä¸º KB $ ulimit -s 8192 åœ¨ä¸Šé¢è¿™å°æœºå™¨é‡Œï¼Œå…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°ä¸€æ–¹é¢å—æ“ä½œç³»ç»Ÿè‡ªèº«è®¾å®šå€¼é™åˆ¶ï¼Œä¸€æ–¹é¢ä¹Ÿå—å†…å­˜å¤§å°é™åˆ¶ã€‚ç”±äº 1024MB / 8MB = 128 > 7619 ï¼Œ æ‰€ä»¥è¿™å°æœºå™¨ä¸­èƒ½å¤Ÿåˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°ä¸º 128ã€‚å¦‚æœ Server é‡‡ç”¨ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªè¿æ¥ï¼Œé‚£ä¹ˆè¿™æ—¶ Server åŒæ—¶æœ€å¤šä¹Ÿåªèƒ½å¤Ÿä¸º 128 ä¸ªè¿æ¥æä¾›æœåŠ¡ã€‚
"><meta name=description content="ä»€ä¹ˆæ˜¯è¿æ¥ åœ¨ç‰©ç†ä¸–ç•Œå¹¶ä¸å­˜åœ¨è¿æ¥è¿™ä¹ˆä¸€è¯´ï¼Œæ•°æ®è½¬æ¢ä¸ºå…‰/ç”µä¿¡å·åï¼Œä»ä¸€å°æœºå™¨å‘å¾€å¦ä¸€å°æœºå™¨ï¼Œä¸­é—´è®¾å¤‡é€šè¿‡ä¿¡å·è§£æå‡ºç›®çš„ä¿¡æ¯æ¥ç¡®å®šå¦‚ä½•è½¬å‘åŒ…ã€‚æˆ‘ä»¬æ—¥å¸¸æ‰€è°“çš„ã€Œè¿æ¥ã€çº¯ç²¹æ˜¯ä¸€ä¸ªäººä¸ºæŠ½è±¡çš„æ¦‚å¿µï¼Œç›®çš„æ˜¯å°†ä¼ è¾“è¿›æ¥çš„æ— çŠ¶æ€æ•°æ®é€šè¿‡æŸä¸ªå›ºå®šå­—æ®µä½œä¸ºæ ‡è¯†ï¼Œåˆ†ç±»ä¸ºä¸åŒæœ‰çŠ¶æ€ä¼šè¯ï¼Œä»è€Œæ–¹ä¾¿åœ¨ä¼ è¾“å±‚å»å®ç°ä¸€äº›ä¾èµ–çŠ¶æ€çš„äº‹æƒ…ã€‚
ä»¥ TCP ä¸ºä¾‹ï¼Œä¸€å¼€å§‹çš„ä¸‰æ¬¡æ¡æ‰‹ç”¨æ¥åœ¨åŒæ–¹ç¡®è®¤ä¸€ä¸ªåˆå§‹åºåˆ—å·ï¼ˆInitial Sequence Numbersï¼ŒISNï¼‰ï¼Œè¿™ä¸ª ISN æ ‡å¿—äº†ä¸€ä¸ª TCP ä¼šè¯ï¼Œå¹¶ä¸”è¿™ä¸ªä¼šè¯æœ‰ä¸€ä¸ªç‹¬å çš„äº”å…ƒç»„ï¼ˆæº IP åœ°å€ï¼Œæºç«¯å£ï¼Œç›®çš„ IP åœ°å€ï¼Œç›®çš„ç«¯å£ï¼Œä¼ è¾“å±‚åè®®ï¼‰ã€‚åœ¨ç‰©ç†æ„ä¹‰ä¸Šï¼Œä¸€ä¸ª TCP ä¼šè¯ç­‰ä»·äºé€šå¾€æŸä¸€ä¸ªæœåŠ¡å™¨çš„ç›¸å¯¹å›ºå®šè·¯çº¿ï¼ˆå³å›ºå®šçš„ä¸­é—´ç‰©ç†è®¾å¤‡é›†åˆï¼‰ï¼Œæ­£æ˜¯ç”±äºè¿™æ ·ï¼Œæˆ‘ä»¬å»é’ˆå¯¹æ¯ä¸ª TCP ä¼šè¯è¿›è¡Œæœ‰çŠ¶æ€çš„æ‹¥å¡æ§åˆ¶ç­‰æ“ä½œæ‰æ˜¯æœ‰æ„ä¹‰çš„ã€‚
è¿æ¥çš„å¼€é”€ æˆ‘ä»¬å¸¸å¸¸å¬åˆ°è¿ç»´ä¼šè¯´æŸå°æœºå™¨è¿æ¥å¤ªå¤šæ‰€ä»¥å‡ºç°äº†æœåŠ¡æŠ–åŠ¨ï¼Œå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä¼šæ¥å—è¿™ä¸ªè¯´æ³•ç„¶åå»å°è¯•é™ä½è¿æ¥æ•°ã€‚ç„¶è€Œæˆ‘ä»¬å¾ˆå°‘å»æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ä¸€ä¸ªæœåŠ¡è¿æ¥æ•°è¿‡å¤šçš„æ—¶å€™ï¼Œæœºå™¨ä¸Šçš„ CPUï¼Œå†…å­˜ï¼Œç½‘å¡å¾€å¾€éƒ½æœ‰å¤§é‡çš„ç©ºä½™èµ„æºï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šæŠ–åŠ¨ï¼Ÿç»´æŠ¤ä¸€ä¸ªè¿æ¥çš„å…·ä½“å¼€é”€æ˜¯å“ªäº›ï¼Ÿ
å†…å­˜å¼€é”€ï¼š
TCP åè®®æ ˆä¸€èˆ¬ç”±æ“ä½œç³»ç»Ÿå®ç°ï¼Œå› ä¸ºè¿æ¥æ˜¯æœ‰çŠ¶æ€å¯¹ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿéœ€è¦åœ¨å†…å­˜ä¸­ä¿å­˜è¿™ä¸ªä¼šè¯ä¿¡æ¯ï¼Œè¿™ä¸ªå†…å­˜å¼€é”€æ¯ä¸ªè¿æ¥å¤§æ¦‚ 4kb ä¸åˆ°ã€‚
æ–‡ä»¶æè¿°ç¬¦å ç”¨ï¼š
åœ¨ Linux è§†è§’ä¸­ï¼Œæ¯ä¸ªè¿æ¥éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œéƒ½ä¼šå ç”¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚æ–‡ä»¶æè¿°ç¬¦æ‰€å ç”¨çš„å†…å­˜å·²ç»è®¡ç®—åœ¨ä¸Šé¢çš„å†…å­˜å¼€é”€ä¸­ï¼Œä½†æ“ä½œç³»ç»Ÿä¸ºäº†ä¿æŠ¤å…¶è‡ªèº«çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ï¼Œä¼šé™åˆ¶æ•´ä¸ªç³»ç»Ÿå†…ä»¥åŠæ¯ä¸ªè¿›ç¨‹ä¸­å¯è¢«åŒæ—¶æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°ï¼š
# æœºå™¨é…ç½®: Linux 1 æ ¸ 1 GB $ cat /proc/sys/fs/file-max 97292 $ ulimit -n 1024 ä¸Šé¢çš„è®¾ç½®è¡¨ç¤ºæ•´ä¸ªæ“ä½œç³»ç»Ÿæœ€å¤šèƒ½åŒæ—¶æ‰“å¼€ 97292 ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªè¿›ç¨‹æœ€å¤šåŒæ—¶æ‰“å¼€ 1024 ä¸ªæ–‡ä»¶ã€‚
ä¸¥æ ¼æ¥è¯´æ–‡ä»¶æè¿°ç¬¦æ ¹æœ¬ç®—ä¸ä¸Šæ˜¯ä¸€ä¸ªèµ„æºï¼ŒçœŸæ­£çš„èµ„æºæ˜¯å†…å­˜ã€‚å¦‚æœä½ æœ‰æ˜ç¡®çš„éœ€è¦ï¼Œå®Œå…¨å¯ä»¥é€šè¿‡è®¾ç½®ä¸€ä¸ªæå¤§å€¼ï¼Œè®©æ‰€æœ‰åº”ç”¨ç»•å¼€è¿™ä¸ªé™åˆ¶ã€‚
çº¿ç¨‹å¼€é”€ï¼š
æœ‰ä¸€äº›è¾ƒè€çš„ Server å®ç°é‡‡ç”¨çš„è¿˜æ˜¯ä¸ºæ¯ä¸ªè¿æ¥ç‹¬å ï¼ˆæ–°å»ºæˆ–ä»è¿æ¥æ± ä¸­è·å–ï¼‰ä¸€ä¸ªçº¿ç¨‹æä¾›æœåŠ¡çš„æ–¹å¼ï¼Œå¯¹äºè¿™ç±»æœåŠ¡æ¥è¯´ï¼Œé™¤äº†è¿æ¥æœ¬èº«å ç”¨çš„å¤–ï¼Œè¿˜æœ‰çº¿ç¨‹çš„å›ºå®šå†…å­˜å¼€é”€ï¼š
# æœºå™¨é…ç½®: Linux 1 æ ¸ 1 GB # æ“ä½œç³»ç»Ÿæœ€å¤§çº¿ç¨‹æ•° $ cat /proc/sys/kernel/threads-max 7619 # æ“ä½œç³»ç»Ÿå•è¿›ç¨‹æœ€å¤§çº¿ç¨‹æ•°ï¼Œundef è¡¨ç¤ºæœªé™åˆ¶ $ cat /usr/include/bits/local_lim.h /* We have no predefined limit on the number of threads. */ #undef PTHREAD_THREADS_MAX # å•ä¸ªçº¿ç¨‹æ ˆé»˜è®¤å¤§å°ï¼Œå•ä½ä¸º KB $ ulimit -s 8192 åœ¨ä¸Šé¢è¿™å°æœºå™¨é‡Œï¼Œå…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°ä¸€æ–¹é¢å—æ“ä½œç³»ç»Ÿè‡ªèº«è®¾å®šå€¼é™åˆ¶ï¼Œä¸€æ–¹é¢ä¹Ÿå—å†…å­˜å¤§å°é™åˆ¶ã€‚ç”±äº 1024MB / 8MB = 128 > 7619 ï¼Œ æ‰€ä»¥è¿™å°æœºå™¨ä¸­èƒ½å¤Ÿåˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°ä¸º 128ã€‚å¦‚æœ Server é‡‡ç”¨ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªè¿æ¥ï¼Œé‚£ä¹ˆè¿™æ—¶ Server åŒæ—¶æœ€å¤šä¹Ÿåªèƒ½å¤Ÿä¸º 128 ä¸ªè¿æ¥æä¾›æœåŠ¡ã€‚
"><meta property="og:locale" content="cn"><meta property="og:image" content="/logo.png"><style>:root{--bg-color:#ffffff;--text-color:#000000;--link-color:#000000;--border-color:#482936;--secondary-text:#666666;--code-bg:#f6f8fa;--blockquote-color:#57606a;--blockquote-border:#d0d7de;--disqus-bg:white}[data-theme=dark]{--bg-color:#1a1a1a;--text-color:#e0e0e0;--link-color:#b0b0b0;--border-color:#8b5a7a;--secondary-text:#aaaaaa;--code-bg:#2d2d2d;--blockquote-color:#a0a0a0;--blockquote-border:#404040;--disqus-bg:#1a1a1a}body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px;background-color:var(--bg-color);color:var(--text-color)}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:var(--link-color);text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:var(--link-color)}.markdown-body blockquote{margin:0;padding:0 1em;color:var(--blockquote-color);border-left:.25em solid var(--blockquote-border)}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px;background-color:var(--code-bg)}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:var(--code-bg);border-radius:6px}.markdown-body pre>code{padding:0;font-size:100%;background-color:var(--code-bg);border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:var(--secondary-text)}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-item-right{margin-left:auto}.header-line{width:100%;border-width:2px;border-color:var(--border-color);border-style:solid none none none}.lang-switch{font-weight:600}.theme-toggle{background:0 0;border:none;color:var(--link-color);cursor:pointer;font-weight:600;font-size:inherit;padding:0}.theme-toggle:hover{font-weight:800}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:var(--text-color)2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:var(--text-color)2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:6px}.post-content .post-gallery{display:flex;flex-wrap:wrap;gap:6px}.post-content .post-gallery img{margin-right:auto;margin-top:auto;width:calc(50% - 3px)}.related-content{border-width:3px;border-style:solid;border-color:var(--text-color);padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:var(--disqus-bg)}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}.post-content .post-gallery img{width:100%}}@media screen and (max-width:48em){.posts-category{display:none}}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=https://cdn.jsdelivr.net/gh/joway/blog/index.xml rel=alternate type=application/rss+xml title="Random Thoughts"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel=stylesheet><script data-cfasync=false>(function(){const o="theme",e={light:"light",dark:"dark",system:"system"};function t(){return window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function n(){return localStorage.getItem(o)}function r(){const s=n();return s&&s!==e.system?s:t()}function s(n){const s=document.documentElement;n===e.system&&(n=t()),n===e.dark?s.setAttribute("data-theme","dark"):s.removeAttribute("data-theme"),i(n)}function i(e){const t=document.getElementById("theme-toggle");t&&(t.textContent=e==="dark"?"â˜€ï¸":"ğŸŒ™")}function a(){i(r())}function c(){const o=n();let i;o?(i=o===e.system?t():o,s(o)):(i=t(),s(e.system))}function l(){const a=n()||e.system;let i;a===e.system?i=t()==="dark"?e.light:e.dark:a===e.dark?i=e.light:i=e.dark,localStorage.setItem(o,i),s(i)}window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){const t=n();(!t||t===e.system)&&s(e.system)}),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",a):a(),window.toggleTheme=l,c()})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53624533-8"></script><script src=https://cdn.jsdelivr.net/gh/joway/homepage/analytics.js></script><article class="post ç®€ä½“ä¸­æ–‡" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>Random Thoughts</a></div><div class=header-subtitle>Log something useless, but interesting.</div></header><div class="row end-md header-items"><div class=header-item><a href=https://mailchi.mp/a1a0d59e7a19/joway target=_blank>Subscribe</a></div><div class=header-item><a href=/travel target=_blank>Travel</a></div><div class=header-item><a href=https://joway.io target=_blank>About</a></div><div class="header-item header-item-right"><button id=theme-toggle onclick=toggleTheme() class=theme-toggle>
ğŸŒ™</button></div></div><div class=row></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>RPC æ¼«è°ˆï¼š è¿æ¥é—®é¢˜</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2021-05-06 00:00:00 UTC">06 May 2021</time></div><div class=col-xs-6><div class=post-author><a target=_blank href>@Joway</a></div></div></div></header><div class="post-content markdown-body"><h2 id=ä»€ä¹ˆæ˜¯è¿æ¥>ä»€ä¹ˆæ˜¯è¿æ¥</h2><p>åœ¨ç‰©ç†ä¸–ç•Œå¹¶ä¸å­˜åœ¨è¿æ¥è¿™ä¹ˆä¸€è¯´ï¼Œæ•°æ®è½¬æ¢ä¸ºå…‰/ç”µä¿¡å·åï¼Œä»ä¸€å°æœºå™¨å‘å¾€å¦ä¸€å°æœºå™¨ï¼Œä¸­é—´è®¾å¤‡é€šè¿‡ä¿¡å·è§£æå‡ºç›®çš„ä¿¡æ¯æ¥ç¡®å®šå¦‚ä½•è½¬å‘åŒ…ã€‚æˆ‘ä»¬æ—¥å¸¸æ‰€è°“çš„ã€Œè¿æ¥ã€çº¯ç²¹æ˜¯ä¸€ä¸ªäººä¸ºæŠ½è±¡çš„æ¦‚å¿µï¼Œç›®çš„æ˜¯å°†ä¼ è¾“è¿›æ¥çš„æ— çŠ¶æ€æ•°æ®é€šè¿‡æŸä¸ªå›ºå®šå­—æ®µä½œä¸ºæ ‡è¯†ï¼Œåˆ†ç±»ä¸ºä¸åŒæœ‰çŠ¶æ€ä¼šè¯ï¼Œä»è€Œæ–¹ä¾¿åœ¨ä¼ è¾“å±‚å»å®ç°ä¸€äº›ä¾èµ–çŠ¶æ€çš„äº‹æƒ…ã€‚<p>ä»¥ TCP ä¸ºä¾‹ï¼Œä¸€å¼€å§‹çš„ä¸‰æ¬¡æ¡æ‰‹ç”¨æ¥åœ¨åŒæ–¹ç¡®è®¤ä¸€ä¸ªåˆå§‹åºåˆ—å·ï¼ˆInitial Sequence Numbersï¼ŒISNï¼‰ï¼Œè¿™ä¸ª ISN æ ‡å¿—äº†ä¸€ä¸ª TCP ä¼šè¯ï¼Œå¹¶ä¸”è¿™ä¸ªä¼šè¯æœ‰ä¸€ä¸ªç‹¬å çš„äº”å…ƒç»„ï¼ˆæº IP åœ°å€ï¼Œæºç«¯å£ï¼Œç›®çš„ IP åœ°å€ï¼Œç›®çš„ç«¯å£ï¼Œä¼ è¾“å±‚åè®®ï¼‰ã€‚åœ¨ç‰©ç†æ„ä¹‰ä¸Šï¼Œä¸€ä¸ª TCP ä¼šè¯ç­‰ä»·äºé€šå¾€æŸä¸€ä¸ªæœåŠ¡å™¨çš„ç›¸å¯¹å›ºå®šè·¯çº¿ï¼ˆå³å›ºå®šçš„ä¸­é—´ç‰©ç†è®¾å¤‡é›†åˆï¼‰ï¼Œæ­£æ˜¯ç”±äºè¿™æ ·ï¼Œæˆ‘ä»¬å»é’ˆå¯¹æ¯ä¸ª TCP ä¼šè¯è¿›è¡Œæœ‰çŠ¶æ€çš„æ‹¥å¡æ§åˆ¶ç­‰æ“ä½œæ‰æ˜¯æœ‰æ„ä¹‰çš„ã€‚<h2 id=è¿æ¥çš„å¼€é”€>è¿æ¥çš„å¼€é”€</h2><p>æˆ‘ä»¬å¸¸å¸¸å¬åˆ°è¿ç»´ä¼šè¯´æŸå°æœºå™¨è¿æ¥å¤ªå¤šæ‰€ä»¥å‡ºç°äº†æœåŠ¡æŠ–åŠ¨ï¼Œå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä¼šæ¥å—è¿™ä¸ªè¯´æ³•ç„¶åå»å°è¯•é™ä½è¿æ¥æ•°ã€‚ç„¶è€Œæˆ‘ä»¬å¾ˆå°‘å»æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ä¸€ä¸ªæœåŠ¡è¿æ¥æ•°è¿‡å¤šçš„æ—¶å€™ï¼Œæœºå™¨ä¸Šçš„ CPUï¼Œå†…å­˜ï¼Œç½‘å¡å¾€å¾€éƒ½æœ‰å¤§é‡çš„ç©ºä½™èµ„æºï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šæŠ–åŠ¨ï¼Ÿç»´æŠ¤ä¸€ä¸ªè¿æ¥çš„å…·ä½“å¼€é”€æ˜¯å“ªäº›ï¼Ÿ<p><strong>å†…å­˜å¼€é”€ï¼š</strong><p>TCP åè®®æ ˆä¸€èˆ¬ç”±æ“ä½œç³»ç»Ÿå®ç°ï¼Œå› ä¸ºè¿æ¥æ˜¯æœ‰çŠ¶æ€å¯¹ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿéœ€è¦åœ¨å†…å­˜ä¸­ä¿å­˜è¿™ä¸ªä¼šè¯ä¿¡æ¯ï¼Œè¿™ä¸ªå†…å­˜å¼€é”€æ¯ä¸ªè¿æ¥å¤§æ¦‚ 4kb ä¸åˆ°ã€‚<p><strong>æ–‡ä»¶æè¿°ç¬¦å ç”¨ï¼š</strong><p>åœ¨ Linux è§†è§’ä¸­ï¼Œæ¯ä¸ªè¿æ¥éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œéƒ½ä¼šå ç”¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚æ–‡ä»¶æè¿°ç¬¦æ‰€å ç”¨çš„å†…å­˜å·²ç»è®¡ç®—åœ¨ä¸Šé¢çš„å†…å­˜å¼€é”€ä¸­ï¼Œä½†æ“ä½œç³»ç»Ÿä¸ºäº†ä¿æŠ¤å…¶è‡ªèº«çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ï¼Œä¼šé™åˆ¶æ•´ä¸ªç³»ç»Ÿå†…ä»¥åŠæ¯ä¸ªè¿›ç¨‹ä¸­å¯è¢«åŒæ—¶æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># æœºå™¨é…ç½®: Linux 1 æ ¸ 1 GB</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ cat /proc/sys/fs/file-max
</span></span><span class=line><span class=cl><span class=m>97292</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=nb>ulimit</span> -n
</span></span><span class=line><span class=cl><span class=m>1024</span>
</span></span></code></pre></div><p>ä¸Šé¢çš„è®¾ç½®è¡¨ç¤ºæ•´ä¸ªæ“ä½œç³»ç»Ÿæœ€å¤šèƒ½åŒæ—¶æ‰“å¼€ 97292 ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªè¿›ç¨‹æœ€å¤šåŒæ—¶æ‰“å¼€ 1024 ä¸ªæ–‡ä»¶ã€‚<p>ä¸¥æ ¼æ¥è¯´æ–‡ä»¶æè¿°ç¬¦æ ¹æœ¬ç®—ä¸ä¸Šæ˜¯ä¸€ä¸ªèµ„æºï¼ŒçœŸæ­£çš„èµ„æºæ˜¯å†…å­˜ã€‚å¦‚æœä½ æœ‰æ˜ç¡®çš„éœ€è¦ï¼Œå®Œå…¨å¯ä»¥é€šè¿‡è®¾ç½®ä¸€ä¸ªæå¤§å€¼ï¼Œè®©æ‰€æœ‰åº”ç”¨ç»•å¼€è¿™ä¸ªé™åˆ¶ã€‚<p><strong>çº¿ç¨‹å¼€é”€ï¼š</strong><p>æœ‰ä¸€äº›è¾ƒè€çš„ Server å®ç°é‡‡ç”¨çš„è¿˜æ˜¯ä¸ºæ¯ä¸ªè¿æ¥ç‹¬å ï¼ˆæ–°å»ºæˆ–ä»è¿æ¥æ± ä¸­è·å–ï¼‰ä¸€ä¸ªçº¿ç¨‹æä¾›æœåŠ¡çš„æ–¹å¼ï¼Œå¯¹äºè¿™ç±»æœåŠ¡æ¥è¯´ï¼Œé™¤äº†è¿æ¥æœ¬èº«å ç”¨çš„å¤–ï¼Œè¿˜æœ‰çº¿ç¨‹çš„å›ºå®šå†…å­˜å¼€é”€ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># æœºå™¨é…ç½®: Linux 1 æ ¸ 1 GB</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ“ä½œç³»ç»Ÿæœ€å¤§çº¿ç¨‹æ•°</span>
</span></span><span class=line><span class=cl>$ cat /proc/sys/kernel/threads-max
</span></span><span class=line><span class=cl><span class=m>7619</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ“ä½œç³»ç»Ÿå•è¿›ç¨‹æœ€å¤§çº¿ç¨‹æ•°ï¼Œundef è¡¨ç¤ºæœªé™åˆ¶</span>
</span></span><span class=line><span class=cl>$ cat /usr/include/bits/local_lim.h
</span></span><span class=line><span class=cl>/* We have no predefined limit on the number of threads.  */
</span></span><span class=line><span class=cl><span class=c1>#undef PTHREAD_THREADS_MAX</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å•ä¸ªçº¿ç¨‹æ ˆé»˜è®¤å¤§å°ï¼Œå•ä½ä¸º KB</span>
</span></span><span class=line><span class=cl>$ <span class=nb>ulimit</span> -s
</span></span><span class=line><span class=cl><span class=m>8192</span>
</span></span></code></pre></div><p>åœ¨ä¸Šé¢è¿™å°æœºå™¨é‡Œï¼Œå…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°ä¸€æ–¹é¢å—æ“ä½œç³»ç»Ÿè‡ªèº«è®¾å®šå€¼é™åˆ¶ï¼Œä¸€æ–¹é¢ä¹Ÿå—å†…å­˜å¤§å°é™åˆ¶ã€‚ç”±äº 1024MB / 8MB = 128 > 7619 ï¼Œ æ‰€ä»¥è¿™å°æœºå™¨ä¸­èƒ½å¤Ÿåˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°ä¸º 128ã€‚å¦‚æœ Server é‡‡ç”¨ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªè¿æ¥ï¼Œé‚£ä¹ˆè¿™æ—¶ Server åŒæ—¶æœ€å¤šä¹Ÿåªèƒ½å¤Ÿä¸º 128 ä¸ªè¿æ¥æä¾›æœåŠ¡ã€‚<p>å¯ä»¥çœ‹å‡ºè¿™ç§å•è¿æ¥å•çº¿ç¨‹çš„æ¨¡å¼ä¼šå¯¼è‡´è¿æ¥æ•°å¤§å¤§åœ°è¢«çº¿ç¨‹æ•°æ‰€åˆ¶çº¦ï¼Œæ‰€ä»¥ç°ä»£ Server å®ç°å¤§å¤šæŠ›å¼ƒäº†è¿™ç§æ¨¡å¼ï¼Œè®©å•ä¸€çº¿ç¨‹ä¸“é—¨å¤„ç†è¿æ¥ã€‚<h2 id=c10k-é—®é¢˜>C10K é—®é¢˜</h2><p>é€šè¿‡ä¸Šé¢çš„è®¨è®ºï¼Œæˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ï¼ŒçœŸæ­£åˆ¶çº¦äº†è¿æ¥æ•°é‡çš„ï¼Œæœ¬è´¨è¿˜æ˜¯å†…å­˜èµ„æºã€‚å…¶ä»–å˜é‡è¦ä¹ˆå¯ä»¥é€šè¿‡ä¿®æ”¹é»˜è®¤å‚æ•°ç»•å¼€ï¼Œè¦ä¹ˆå¯ä»¥é€šè¿‡æ›´æ”¹è½¯ä»¶è®¾è®¡è€Œä¼˜åŒ–ã€‚ä½†å¦‚æœäº‹å®çœŸçš„å¦‚æ­¤ç®€å•ï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šæœ‰è‘—åçš„ <a href=https://en.wikipedia.org/wiki/C10k_problem>C10K</a> é—®é¢˜å‘¢ï¼Ÿ<p>è¿™å…¶å®çº¯ç²¹æ˜¯ä¸€ä¸ªè½¯ä»¶å·¥ç¨‹çš„é—®é¢˜ï¼Œè€Œéç¡¬ä»¶é—®é¢˜ã€‚æ—©æœŸæ“ä½œç³»ç»Ÿè®¾è®¡æ—¶ï¼Œå°±æ²¡æœ‰è€ƒè™‘åˆ°æœªæ¥ä¼šå‡ºç°å•æœº 10K è¿æ¥ç”šè‡³æ›´å¤šçš„é—®é¢˜ï¼Œæ‰€ä»¥åœ¨å…¶æ¥å£ä¸Šå¹¶æœªå¯¹è¿™ç±»åœºæ™¯è¿›è¡Œä¼˜åŒ–ï¼Œè€Œåœ¨æ­¤ä¹‹ä¸Šçš„åŸºç¡€è®¾æ–½è½¯ä»¶ï¼ˆä¾‹å¦‚ Apacheï¼‰è‡ªç„¶è€Œç„¶ä¹Ÿå°±æ²¡æœ‰è€ƒè™‘åˆ°åº”å¯¹è¿™ç±»åœºæ™¯ã€‚<p>å¯¹äºåº”ç”¨è½¯ä»¶å¼€å‘è€…è€Œè¨€ï¼Œæ“ä½œç³»ç»Ÿå°±å¦‚åŒæ³•å¾‹ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåšä»€ä¹ˆå¹¶ä¸å…¨å‡­ç‰©ç†ä¸–ç•Œå¯ä»¥åšä»€ä¹ˆï¼Œè¿˜è¦éµä»æ“ä½œç³»ç»Ÿå…è®¸æˆ‘ä»¬åšä»€ä¹ˆã€‚<p>éœ€è¦æ³¨æ„çš„æ˜¯ C10K é—®é¢˜æŒ‡çš„æ˜¯è¿æ¥æ•°ï¼Œè€Œéè¯·æ±‚æ•°ã€‚å¦‚æœæ˜¯ 10K çš„ QPS(Query per Second) åœ¨ä¸€æ¡è¿æ¥ä¸Šä¹Ÿèƒ½å¤Ÿè¿›è¡Œï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¯¹äºä¼ä¸šå†…ç½‘ä¸­çš„ RPC è°ƒç”¨è€Œè¨€ï¼Œä¸€èˆ¬ä¹Ÿä¸ä¼šå‡ºç° C10K çš„é—®é¢˜ã€‚C10K é—®é¢˜å¾€å¾€å‡ºç°åœ¨è¯¸å¦‚æ¨é€æœåŠ¡ï¼ŒIM æœåŠ¡è¿™ç±»éœ€è¦å’Œæµ·é‡å®¢æˆ·ç«¯å»ºç«‹æŒä¹…è¿æ¥çš„åœºæ™¯ã€‚<p>åœ¨ Linux è¯­å¢ƒä¸‹ï¼Œè¿æ¥è¢«æŠ½è±¡ä¸ºæ–‡ä»¶ï¼Œæ‰€ä»¥ C10K é—®é¢˜çš„å…³é”®åœ¨äº Linux ä¸­æ‰€æä¾›çš„ IO æ¥å£è®¾è®¡æ˜¯å¦å¯ä»¥åº”å¯¹å¤§è§„æ¨¡è¿æ¥çš„åœºæ™¯ï¼Œä»¥åŠæˆ‘ä»¬å¦‚ä½•ä½¿ç”¨è¿™äº›æ¥å£å»å®ç°èƒ½å¤Ÿæ”¯æŒé«˜å¹¶å‘è¿æ¥çš„è½¯ä»¶æ¶æ„ã€‚<h3 id=linux-io-çš„å†å²æ¼”å˜>Linux IO çš„å†å²æ¼”å˜</h3><p>å¦‚æœæˆ‘ä»¬è¦ä¸€æ¬¡å¤„ç†å¤šä¸ªè¿æ¥ï¼ˆå³å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼Œé‚£ä¹ˆå¿…ç„¶éœ€è¦æ“ä½œç³»ç»Ÿèƒ½å¤Ÿæä¾›ç»™æˆ‘ä»¬ä¸€ä¸ªæ‰¹é‡ç›‘å¬å‡½æ•°ï¼Œè®©æˆ‘ä»¬èƒ½å¤ŸåŒæ—¶å»ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä¸”é€šè¿‡è¿”å›å€¼å‘ŠçŸ¥æˆ‘ä»¬å“ªäº›æ–‡ä»¶å·²ç»å¯è¯»/å¯å†™ï¼Œç„¶åæˆ‘ä»¬æ‰èƒ½å»çœŸæ­£æ“ä½œè¿™äº›å·²ç»å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ã€‚<p>Linux IO çš„æ ¹æœ¬æ€§å·¥ä½œæ— éå°±æ˜¯ä¸Šé¢è¿™äº›ï¼Œçœ‹ä¸Šå»å¹¶ä¸æ˜¯ä»€ä¹ˆå¤æ‚çš„è®¾è®¡ï¼Œä½†æ˜¯è¿™éƒ¨åˆ†å·¥ä½œåœ¨å†å²ä¸Šçš„ä¸åŒå®ç°æ–¹å¼å´æ·±åˆ»å½±å“äº†åæ¥çš„åº”ç”¨è½¯ä»¶å‘å±•ï¼Œä¹Ÿæ˜¯å¾ˆå¤šåŸºç¡€è½¯ä»¶ä¹‹é—´æ ¸å¿ƒåŒºåˆ«æ‰€åœ¨ã€‚<h4 id=select-1993>select, 1993</h4><p>select çš„å‡½æ•°ç­¾åï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#define __FD_SETSIZE 1024
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>__fd_mask</span> <span class=n>fds_bits</span><span class=p>[</span><span class=n>__FD_SETSIZE</span> <span class=o>/</span> <span class=n>__NFDBITS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=n>fd_set</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>select</span> <span class=p>(</span><span class=kt>int</span> <span class=n>nfds</span><span class=p>,</span> <span class=n>fd_set</span> <span class=o>*</span><span class=n>readfds</span><span class=p>,</span> <span class=n>fd_set</span> <span class=o>*</span><span class=n>writefds</span><span class=p>,</span> <span class=n>fd_set</span> <span class=o>*</span><span class=n>exceptfds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=k>struct</span> <span class=nc>timeval</span> <span class=o>*</span><span class=n>timeout</span><span class=p>)</span>
</span></span></code></pre></div><p>ä½¿ç”¨æ–¹å¼ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// åˆå§‹åŒ–æ–‡ä»¶æè¿°ç¬¦æ•°ç»„
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>fd_set</span> <span class=n>readfds</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>FD_ZERO</span><span class=p>(</span><span class=o>&amp;</span><span class=n>readfds</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// socket1, socket2 è¿æ¥æ³¨å†Œè¿› readfds
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>FD_SET</span><span class=p>(</span><span class=n>conn_sockfd_1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>readfds</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>FD_SET</span><span class=p>(</span><span class=n>conn_sockfd_2</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>readfds</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å¾ªç¯ç›‘å¬ readfds
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è¿”å›å°±ç»ªæè¿°ç¬¦çš„æ•°ç›®
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>available_fd_count</span> <span class=o>=</span> <span class=n>select</span><span class=p>(</span><span class=n>maxfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>readfds</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>timeout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// éå†å½“å‰æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span><span class=p>(</span><span class=n>fd</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>fd</span> <span class=o>&lt;</span> <span class=n>maxfd</span><span class=p>;</span> <span class=n>fd</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ£€æŸ¥æ˜¯å¦å¯è¯»
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span><span class=p>(</span><span class=n>FD_ISSET</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>readfds</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ä» fd è¯»å–
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buf</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>select å‡½æ•°åœ¨å¤§è§„æ¨¡è¿æ¥æ—¶çš„ç¼ºé™·ä¸»è¦åœ¨ä»¥ä¸‹ä¸¤æ–¹é¢ï¼š<ul><li><p><strong>çº¿æ€§éå†æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼ŒO(N)  å¤æ‚åº¦</strong>ï¼š<p>select å‡½æ•°æœ¬èº«å¹¶ä¸è¿”å›å…·ä½“å“ªäº›æ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼Œéœ€è¦ç”¨æˆ·è‡ªå·±å»éå†æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶é€šè¿‡ FD_ISSET æ¥åˆ¤æ–­ã€‚è¿æ¥å°‘æ—¶å½±å“å¹¶ä¸å¤§ï¼Œä½†å½“è¿æ¥æ•°è¾¾åˆ° 10Kï¼Œè¿™ä¸ª O(N) å¤æ‚åº¦é€ æˆçš„æµªè´¹ä¹Ÿä¼šéå¸¸å¤¸å¼ ã€‚<li><p><strong>fd_set å¤§å°é™åˆ¶</strong>ï¼š<p>fd_set ç»“æ„èƒŒåæ˜¯ä¸€ä¸ªä½å›¾ï¼Œæ¯ä¸€ä½ä»£è¡¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä½†å°±ç»ªçŠ¶æ€ï¼Œ1 ä»£è¡¨å°±ç»ªã€‚Linux é»˜è®¤ FD_SETSIZE ä¸º 1024ï¼Œä¹Ÿå°±æ˜¯å®é™…å¤§å°ä¸º 1024/8bits = 128 bytesã€‚å¹¶ä¸”è¿™éƒ¨åˆ†å†…å­˜æœ€åä¼šè¢«æ‹·è´åˆ°å†…æ ¸æ€ï¼Œä¹Ÿä¼šé€ æˆæ‹·è´ä¸Šçš„å¼€é”€ã€‚</ul><p>è¿™ç§è®¾è®¡çœ‹èµ·æ¥ç²—ç³™ï¼Œä½†æ˜¯å¥½å¤„æ˜¯å¯ä»¥å¾ˆå¥½åº”å¯¹æ’é˜Ÿé—®é¢˜ã€‚å¦‚æœæŸä¸ªè¿æ¥ç‰¹åˆ«ç¹å¿™ï¼Œä¹Ÿä¸ä¼šå½±å“è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æœ¬èº«çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒåªå…³å¿ƒæ˜¯å¦å°±ç»ªï¼Œä¸å…³å¿ƒå…·ä½“æœ‰å¤šå°‘æ•°æ®å¾…å¤„ç†ã€‚åœ¨ 2000 å¹´ Linus çš„ <a href=http://lkml.iu.edu/hypermail/linux/kernel/0010.3/0003.html>é‚®ä»¶</a> ä¸­å¯ä»¥çœ‹åˆ°æ›´å¤šç›¸å…³è®¨è®ºã€‚<h4 id=poll-1998>poll, 1998</h4><p>poll å‡½æ•°çš„ç­¾åï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>pollfd</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span><span class=p>;</span>             <span class=cm>/* File descriptor to poll.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>short</span> <span class=kt>int</span> <span class=n>events</span><span class=p>;</span>   <span class=cm>/* Types of events poller cares about.  */</span>
</span></span><span class=line><span class=cl>    <span class=kt>short</span> <span class=kt>int</span> <span class=n>revents</span><span class=p>;</span>  <span class=cm>/* Types of events that actually occurred.  */</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>poll</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>pollfd</span> <span class=o>*</span><span class=n>fds</span><span class=p>,</span> <span class=n>nfds_t</span> <span class=n>nfds</span><span class=p>,</span> <span class=kt>int</span> <span class=n>timeout</span><span class=p>)</span>
</span></span></code></pre></div><p>ä½¿ç”¨æ–¹å¼ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// åˆå§‹åŒ– pollfd æ•°ç»„
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>nfds</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>pollfd</span> <span class=n>fds</span><span class=p>[</span><span class=n>fds_size</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>fds</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>fd</span> <span class=o>=</span> <span class=n>STDIN_FILENO</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>fds</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>events</span> <span class=o>=</span> <span class=n>POLLIN</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>fds</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>fd</span> <span class=o>=</span> <span class=n>STDOUT_FILENO</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>fds</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>events</span> <span class=o>=</span> <span class=n>POLLOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ç›‘å¬ pollfd æ•°ç»„å†…çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>poll</span><span class=p>(</span><span class=n>fds</span><span class=p>,</span> <span class=n>nfds</span><span class=p>,</span> <span class=n>TIMEOUT</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// éå† fds
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span><span class=p>(</span><span class=n>fd</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>fd</span> <span class=o>&lt;</span> <span class=n>nfds</span><span class=p>;</span> <span class=n>fd</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ˜¯å¦æ˜¯è¯»å–äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>fds</span><span class=p>[</span><span class=n>fd</span><span class=p>].</span><span class=n>revents</span> <span class=o>&amp;</span> <span class=n>POLLIN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ä» fd è¯»å–
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>read</span><span class=p>(</span><span class=n>fds</span><span class=p>[</span><span class=n>fd</span><span class=p>].</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buf</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>poll ç›¸æ¯” select çš„å·®å¼‚ä¸»è¦æœ‰ä¸¤ä¸ªï¼š<ol><li>é€šè¿‡ pollfd ç»Ÿä¸€ readfds, writefds, exceptfds ä¸‰ç§äº‹ä»¶ç±»å‹ã€‚<li>é€šè¿‡ pollfd[] æ•°ç»„ä¼ é€’éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸å†é™åˆ¶æ–‡ä»¶æè¿°ç¬¦æ•°é‡ã€‚ï¼ˆå†…æ ¸å°†æ•°ç»„è½¬æ¢ä¸ºé“¾è¡¨ï¼‰ã€‚</ol><p>ä½†åœ¨ poll å‘æ˜çš„ 1998 å¹´ï¼Œå¤§è§„æ¨¡ç½‘ç»œåŸºç¡€è®¾æ–½ä¾ç„¶ä¸æ˜¯ä¸€ä¸ªæ™®éçš„éœ€æ±‚ï¼Œæ‰€ä»¥è¿™æ¬¡ API å¢åŠ å¹¶æ²¡æœ‰è§£å†³å‰é¢è¯´çš„åœ¨å¤§è§„æ¨¡è¿æ¥ä¸‹ï¼Œéœ€è¦éå†æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„é—®é¢˜ã€‚ä½†å°±åœ¨ poll å‘å¸ƒåçš„ 1999 å¹´å‘ç”Ÿäº†å‡ ä»¶äº‹æƒ…ï¼š<ol><li>C10K é—®é¢˜è¢«æ­£å¼æå‡º<li>HTTP 1.1 å‘å¸ƒï¼Œåœ¨è¿™ä¸€ç‰ˆæœ¬å¼•å…¥äº† keep alive çš„æŒä¹…è¿æ¥æ¦‚å¿µ<li>QQ å‘å¸ƒ</ol><p>å¹¶ä¸”åœ¨ 00 å¹´å‰å 2C äº’è”ç½‘å¼•æ¥äº†å¤§çˆ†å‘å’Œå¤§æ³¡æ²«çš„æ—¶ä»£ã€‚<p>åœ¨ QQ å‘å¸ƒçš„å¹´ä»£ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯æ— è§£çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåƒ QQ è¿™ç§é¢å‘ä¼šè¯è€Œç”Ÿçš„åº”ç”¨ï¼Œå´æŠ›å¼ƒäº†é¢å‘ä¼šè¯çš„ TCP åè®®ï¼Œè€Œä½¿ç”¨çš„æ˜¯ UDPã€‚<h4 id=epoll-2003>epoll, 2003</h4><p>epoll å‡½æ•°ç­¾åï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>typedef</span> <span class=k>union</span> <span class=nc>epoll_data</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span>    <span class=o>*</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span>      <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>u32</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>u64</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>epoll_data_t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>epoll_event</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span>     <span class=n>events</span><span class=p>;</span>    <span class=cm>/* Epoll events */</span>
</span></span><span class=line><span class=cl>    <span class=n>epoll_data_t</span> <span class=n>data</span><span class=p>;</span>      <span class=cm>/* User data variable */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>epoll_create</span><span class=p>(</span><span class=kt>int</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>epoll_ctl</span><span class=p>(</span><span class=kt>int</span> <span class=n>epfd</span><span class=p>,</span> <span class=kt>int</span> <span class=n>op</span><span class=p>,</span> <span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>epoll_event</span> <span class=o>*</span><span class=n>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>epoll_wait</span><span class=p>(</span><span class=kt>int</span> <span class=n>epfd</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>epoll_event</span> <span class=o>*</span><span class=n>events</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=kt>int</span> <span class=n>maxevents</span><span class=p>,</span> <span class=kt>int</span> <span class=n>timeout</span><span class=p>);</span>
</span></span></code></pre></div><p>ä½¿ç”¨æ–¹å¼ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#define MAX_EVENTS 10
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>struct</span> <span class=nc>epoll_event</span> <span class=n>ev</span><span class=p>,</span> <span class=n>events</span><span class=p>[</span><span class=n>MAX_EVENTS</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>listen_sock</span><span class=p>,</span> <span class=n>conn_sock</span><span class=p>,</span> <span class=n>nfds</span><span class=p>,</span> <span class=n>epollfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// åˆ›å»º epollfd å¯¹è±¡ï¼Œåç»­ epoll æ“ä½œéƒ½å›´ç»•è¯¥å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>epollfd</span> <span class=o>=</span> <span class=n>epoll_create</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å¯¹ ev ç»‘å®šå…³å¿ƒå¯¹ EPOLLIN äº‹ä»¶ï¼Œå¹¶æ³¨å†Œè¿› epollfd ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ev</span><span class=p>.</span><span class=n>events</span> <span class=o>=</span> <span class=n>EPOLLIN</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>ev</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span> <span class=o>=</span> <span class=n>listen_sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>epoll_ctl</span><span class=p>(</span><span class=n>epollfd</span><span class=p>,</span> <span class=n>EPOLL_CTL_ADD</span><span class=p>,</span> <span class=n>listen_sock</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ev</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=n>perror</span><span class=p>(</span><span class=s>&#34;epoll_ctl: listen_sock&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(;;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¼ å…¥ events ç©ºæ•°ç»„ï¼Œé˜»å¡ç­‰å¾…ç›´åˆ°ä¸€æœ‰å°±ç»ªäº‹ä»¶ä¾¿è¿”å›ï¼Œè¿”å›å€¼ä¸ºæœ‰æ•ˆäº‹ä»¶æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>nfds</span> <span class=o>=</span> <span class=n>epoll_wait</span><span class=p>(</span><span class=n>epollfd</span><span class=p>,</span> <span class=n>events</span><span class=p>,</span> <span class=n>MAX_EVENTS</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>nfds</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>perror</span><span class=p>(</span><span class=s>&#34;epoll_pwait&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// åªéœ€è¦éå†æœ‰æ•ˆäº‹ä»¶å³å¯
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=n>n</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>n</span> <span class=o>&lt;</span> <span class=n>nfds</span><span class=p>;</span> <span class=o>++</span><span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>events</span><span class=p>[</span><span class=n>n</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span> <span class=o>!=</span> <span class=n>listen_sock</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//å¤„ç†æ–‡ä»¶æè¿°ç¬¦ï¼Œread/write
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>do_use_fd</span><span class=p>(</span><span class=n>events</span><span class=p>[</span><span class=n>n</span><span class=p>].</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//ä¸»ç›‘å¬socketæœ‰æ–°è¿æ¥
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>conn_sock</span> <span class=o>=</span> <span class=n>accept</span><span class=p>(</span><span class=n>listen_sock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=p>(</span><span class=k>struct</span> <span class=nc>sockaddr</span> <span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>local</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>addrlen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>conn_sock</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>perror</span><span class=p>(</span><span class=s>&#34;accept&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>setnonblocking</span><span class=p>(</span><span class=n>conn_sock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1>//å°†æ–°è¿æ¥æ³¨å†Œåˆ° epollfd ä¸­ï¼Œå¹¶ä»¥è¾¹ç¼˜è§¦å‘æ–¹å¼ç›‘å¬è¯»äº‹ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ev</span><span class=p>.</span><span class=n>events</span> <span class=o>=</span> <span class=n>EPOLLIN</span> <span class=o>|</span> <span class=n>EPOLLET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>ev</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>fd</span> <span class=o>=</span> <span class=n>conn_sock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>epoll_ctl</span><span class=p>(</span><span class=n>epollfd</span><span class=p>,</span> <span class=n>EPOLL_CTL_ADD</span><span class=p>,</span> <span class=n>conn_sock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=o>&amp;</span><span class=n>ev</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>perror</span><span class=p>(</span><span class=s>&#34;epoll_ctl: conn_sock&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>epoll æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š<ol><li>æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œåªä¼šåœ¨åˆ›å»ºæ—¶ï¼Œè¢« epoll_ctl æ‹·è´ä¸€æ¬¡ã€‚<li>epoll_wait åªæœ‰å¤§å°æœ‰é™çš„å‚æ•°ï¼Œä»è€Œé¿å…äº†é¢‘ç¹è¿›è¡Œç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„æ‹·è´ã€‚<li>epoll_wait åªè¿”å›å°±ç»ªçŠ¶æ€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé¿å…äº†å¯¹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦å»éå†ã€‚</ol><p>å› æ­¤ï¼Œå½“è¿æ¥æ•°çº¿æ€§å¢å¤šæ—¶ï¼Œepoll è°ƒç”¨æœ¬èº«çš„æ€§èƒ½å¹¶ä¸ä¼šçº¿æ€§å¢å¤§ã€‚ç°ä»£ Server åœ¨ Linux å¹³å°ä¸‹å¤§å¤šå·²ç»è½¬å‘ä½¿ç”¨ epoll æ¥å®ç°ã€‚<h3 id=é«˜å¹¶å‘æœåŠ¡è®¾è®¡>é«˜å¹¶å‘æœåŠ¡è®¾è®¡</h3><p>æˆ‘ä»¬å¯ä»¥æŠŠ C10K é—®é¢˜æ‹†è§£æˆä»¥ä¸‹ä¸‰ä¸ªå­é—®é¢˜ï¼š<ol><li>å¦‚ä½•é«˜æ•ˆåœ°<strong>å»ºç«‹</strong>å¤§é‡è¿æ¥ (accept)<li>å¦‚æœé«˜æ•ˆåœ°<strong>è¯»å†™</strong>å¤§é‡è¿æ¥ï¼ˆread/writeï¼‰<li>å¦‚ä½•é«˜æ•ˆåœ°<strong>å¤„ç†</strong>å¤§é‡è¯·æ±‚</ol><p>è¿™ä¸‰ä¸ªå­é—®é¢˜çš„åŒºåˆ«æ˜¯ï¼Œå»ºç«‹è¿æ¥åªä¼šåœ¨ä¸€å¼€å§‹å ç”¨ CPUï¼Œè¿æ¥å»ºç«‹å®Œæˆåï¼Œåªä¼šå ç”¨å†…å­˜èµ„æºï¼Œå¹¶ä¸”æ¯æ¬¡å»ºç«‹è¿æ¥æ‰€æ¶ˆè€—çš„èµ„æºéƒ½æ˜¯å›ºå®šçš„ã€‚ä½†æ¯ä¸ªè¿æ¥ä¸Šçš„è¯»å†™æ“ä½œä»¥åŠå¯¹è¯·æ±‚æ•°æ®çš„å¤„ç†å´ä¼šé¢‘ç¹æ¶ˆè€—ä¸å¯é¢„è®¡çš„ CPU ä¸ å†…å­˜èµ„æºï¼Œä¸”è¿æ¥é—´å’Œè¯·æ±‚é—´çš„å·®å¼‚ä¼šéå¸¸å¤§ã€‚<h4 id=å¦‚ä½•é«˜æ•ˆå»ºç«‹è¿æ¥>å¦‚ä½•é«˜æ•ˆå»ºç«‹è¿æ¥</h4><p>ç”±äºå»ºç«‹è¿æ¥æ¶ˆè€—çš„èµ„æºæ˜¯å›ºå®šçš„ï¼Œå‡è®¾éœ€è¦ x msï¼Œå¦‚æœæˆ‘ä»¬ç”¨ä¸€ä¸ªå•çº¿ç¨‹ï¼Œåªè´Ÿè´£ç›‘å¬ listen port æ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ›å»ºæ–°è¿æ¥ä½†ä¸è´Ÿè´£å¯¹å…¶è¿›è¡Œè¯»å†™ã€‚é‚£ä¹ˆè¯¥çº¿ç¨‹æ¯ç§’èƒ½å¤Ÿåˆ›å»ºçš„è¿æ¥æ•°åº”è¯¥æ˜¯ 1000/x ã€‚<p>ä¸€èˆ¬æ¥è¯´ï¼Œåˆ›å»ºè¿æ¥æœ¬èº«çš„æ¶ˆè€—éå¸¸å°‘ï¼Œå•çº¿ç¨‹è¶³ä»¥åº”å¯¹ 10K ç”šè‡³æ›´é«˜çš„å¹¶å‘ã€‚<h4 id=å¦‚ä½•é«˜æ•ˆè¯»å†™è¿æ¥>å¦‚ä½•é«˜æ•ˆè¯»å†™è¿æ¥</h4><p>æˆ‘ä»¬é€šè¿‡å‰ä¸€ä¸ªæ­¥éª¤å·²ç»ç¡®ä¿æœåŠ¡èƒ½å¤Ÿé«˜æ•ˆå»ºç«‹æ–°è¿æ¥ï¼Œè€Œå¯¹äºè¿™äº›æ–°è¿æ¥çš„è¯»å†™ä»»åŠ¡å·¥ä½œé‡æˆ‘ä»¬å®ç°å¹¶æ— æ³•å‡†ç¡®ä¼°ç®—ï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€ä¸ªçº¿ç¨‹æ± ä¸“é—¨å»ä½¿ç”¨ epoll_wait æ‰¹é‡ç›‘å¬è¿æ¥äº‹ä»¶ï¼Œå¹¶è¿›è¡ŒçœŸæ­£çš„è¯»å†™æ“ä½œã€‚ä½†è¿™é‡Œçš„è¯»å†™æ“ä½œæ¶‰åŠåˆ° epoll çš„ä¸¤ç§é€šçŸ¥æ¨¡å¼ â€”â€”â€”â€” <strong>æ°´å¹³è§¦å‘</strong>å’Œ<strong>è¾¹ç¼˜è§¦å‘</strong>ã€‚<p>å¯¹äº select/poll è€Œè¨€ï¼Œè·å–çš„éƒ½æ˜¯æ–‡ä»¶æè¿°ç¬¦å°±ç»ªçš„åˆ—è¡¨ï¼Œæ¯æ¬¡è°ƒç”¨åªä¼šå»æ£€æŸ¥æ˜¯å¦å¯è¯»/å¯å†™çš„çŠ¶æ€ï¼Œæ‹¿åˆ°å¯ç”¨æè¿°ç¬¦åï¼Œè¿›è¡Œè¯»å†™ï¼Œç„¶åå†è¿›è¡Œä¸‹ä¸€æ¬¡ select/pollã€‚å¦‚æœæ²¡æœ‰è¯»å®Œï¼Œä¸‹ä¸€æ¬¡è°ƒç”¨ select/poll æ—¶ï¼Œè¿˜ä¼šç»§ç»­è¿”å›å¯è¯»çŠ¶æ€ï¼Œåªè¦ç»§ç»­å»è¯»å°±æ²¡é—®é¢˜ã€‚å¦‚æœæ²¡æœ‰å†™å®Œï¼Œå½“ä¸‹ä¸€æ¬¡å›åˆ°å¯å†™æ—¶çŠ¶æ€æ—¶ï¼Œå¯ä»¥ç»§ç»­å†™ã€‚epoll åŒæ ·ä¹Ÿæœ‰è¿™ç±»æ¨¡å¼ï¼Œæˆ‘ä»¬å°†è¿™ç§å¤„ç†ç§°ä¹‹ä¸º<strong>æ°´å¹³è§¦å‘</strong>ã€‚<p>ä¸æ°´å¹³è§¦å‘å¯¹åº”çš„æ˜¯è¾¹ç¼˜è§¦å‘ï¼Œä»–ä»¬çš„å‘½åæ¥è‡ªç”µå¹³çš„æ¦‚å¿µï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Level Triggered:
</span></span><span class=line><span class=cl>        ......
</span></span><span class=line><span class=cl>        |    |
</span></span><span class=line><span class=cl>________|    |_________
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Edge Triggered:
</span></span><span class=line><span class=cl>          ____
</span></span><span class=line><span class=cl>         |    |
</span></span><span class=line><span class=cl>________.|    |_________
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// &#34;.&#34; è¡¨ç¤ºè§¦å‘é€šçŸ¥
</span></span></code></pre></div><p><strong>è¾¹ç¼˜è§¦å‘</strong>åªæœ‰åœ¨ä»æ— æ•°æ®åˆ°æœ‰æ•°æ®æ—¶é€šçŸ¥ä¸€æ¬¡ï¼Œåç»­è°ƒç”¨éƒ½è¿”å› Falseã€‚æ‰€ä»¥å½“æ”¶åˆ°é€šçŸ¥åï¼Œå¿…é¡»å»ä¸€æ¬¡æ€§è¯»å®Œæ–‡ä»¶æ‰€æœ‰å†…å®¹ã€‚è€Œå¦‚æœæŸä¸ªè¿æ¥æç«¯ç¹å¿™ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°é¥¥é¥¿ç°è±¡ã€‚ä½†è¿™ç±»é¥¥é¥¿ç°è±¡å’Œ epoll æˆ–æ˜¯è¾¹ç¼˜è§¦å‘å…³ç³»éƒ½ä¸å¤§ï¼Œçº¯ç²¹æ˜¯æˆ‘ä»¬åœ¨ä»£ç å®ç°æ—¶ï¼Œéœ€è¦å¤šè€ƒè™‘åˆ°å‡è¡¡è¯»å†™çš„æƒ…å†µã€‚å¦‚æœåœ¨æ°´å¹³è§¦å‘çš„æ¨¡å¼ä¸‹ï¼Œä¹Ÿæ€»æ˜¯å»å°è¯•ä¸€æ¬¡æ€§è¯»å®Œæ‰€æœ‰å†…å®¹ï¼Œä¾ç„¶ä¼šå­˜åœ¨é¥¥é¥¿ç°è±¡ã€‚<p>å¯¹äºç»å¤§å¤šæ•°å°ä½“ç§¯æ¶ˆæ¯è€Œè¨€ï¼Œæ— è®ºå“ªç§è§¦å‘æ–¹å¼éƒ½èƒ½å¤Ÿå¿«é€Ÿè¯»å®Œæ¶ˆæ¯ï¼Œå·®åˆ«ä¸å¤§ã€‚ä½†å¯¹äºå¤§ä½“ç§¯çš„æ¶ˆæ¯ï¼Œè¯¸å¦‚è§†é¢‘è¿™ç§ï¼Œæ°´å¹³è§¦å‘çš„æ–¹å¼ä¼šå¯¼è‡´ epoll_wait é¢‘ç¹è¢«å”¤é†’ï¼Œç›¸æ¯”äºè¾¹ç¼˜è§¦å‘ä¼šå¤šå¾ˆå¤šæ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€ä»¥æ€§èƒ½ä¼šæ›´å·®ã€‚<h4 id=å¦‚ä½•é«˜æ•ˆå¤„ç†è¯·æ±‚>å¦‚ä½•é«˜æ•ˆå¤„ç†è¯·æ±‚</h4><p>å¯¹äºç»å¤§éƒ¨åˆ†ä¸šåŠ¡æ¥è¯´ï¼Œä¸šåŠ¡é€»è¾‘çš„å¤„ç†æ‰æ˜¯çœŸæ­£è€—è´¹èµ„æºçš„æ“ä½œï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½å°†è¿™éƒ¨åˆ†æ“ä½œæ”¾è¿› IO çº¿ç¨‹å†…è¿›è¡Œï¼Œå¦åˆ™ä¼šå½±å“åˆ°è¿™ä¸ªçº¿ç¨‹ä¸­ç›‘å¬çš„å…¶ä»–è¿æ¥ã€‚æ‰€ä»¥éœ€è¦å•ç‹¬å†å¼€è¾Ÿä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ± å»å¤„ç†ä¸šåŠ¡é€»è¾‘æœ¬èº«ã€‚<p>å½’æ ¹ç»“åº•ï¼Œå¯¹äºæ¶ˆè€—å°‘ä¸”å›ºå®šçš„ä»»åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨å•çº¿ç¨‹ã€‚å¯¹äºæ¶ˆè€—ä¸ç¡®å®šçš„ä»»åŠ¡ï¼Œéœ€è¦ä½¿ç”¨çº¿ç¨‹æ± ã€‚<h4 id=æœ€ç»ˆæ¶æ„>æœ€ç»ˆæ¶æ„</h4><p>é€šè¿‡ä¸Šé¢ä¸€ç³»åˆ—ä»»åŠ¡æ‹†åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªä¸šå†…ç§°ä¹‹ä¸ºä¸»ä» Reactor çš„æ”¯æŒé«˜å¹¶å‘çš„æœåŠ¡æ¨¡å‹ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>     å•çº¿ç¨‹                         çº¿ç¨‹æ±                          çº¿ç¨‹æ± 
</span></span><span class=line><span class=cl>[ Main Reactor ] == æ–°è¿æ¥ ==&gt; [ Sub Reactor ] &lt;-- Data --&gt; [ Worker Thread ]
</span></span><span class=line><span class=cl>    å»ºç«‹æ–°è¿æ¥                      è¯»å†™è¿æ¥                      ä¸šåŠ¡é€»è¾‘å¤„ç†
</span></span></code></pre></div><p>è¿™ä¸ªæ¨¡å‹ä¹Ÿæ˜¯ Java çš„ Netty æ¡†æ¶ï¼Œå’Œ Go çš„ <a href=https://strikefreedom.top/go-event-loop-networking-library-gnet>gnet</a> æ¡†æ¶çš„å®ç°åŸºç¡€ã€‚<p>äº’è”ç½‘ä¸šåŠ¡æœ‰çº¢åˆ©ï¼ŒåŸºç¡€è®¾æ–½è½¯ä»¶çš„å˜é©ä¹Ÿæœ‰çº¢åˆ©ã€‚Epoll å°±æ˜¯ä¸Šä¸ª 10 å¹´æœ€å¤§çš„ä¸€ä¸ªçº¢åˆ©ä¹‹ä¸€ã€‚<h2 id=è¿æ¥æ± -vs-å¤šè·¯å¤ç”¨>è¿æ¥æ±  VS å¤šè·¯å¤ç”¨</h2><p>å¯¹äºè¿æ¥çš„ç®¡ç†æœ‰ä¸¤ç§åŸºæœ¬æ€æƒ³ï¼š<strong>è¿æ¥æ± </strong>å’Œ<strong>å¤šè·¯å¤ç”¨</strong>ã€‚<p>è¿æ¥æ˜¯è¯·æ±‚çš„ä¼ è¾“è½½ä½“ï¼Œä¸€ä¸ªè¯·æ±‚åŒ…å«ä¸€æ¥ä¸€å›ï¼Œå³ä¸€ä¸ª RTT æ—¶é—´ã€‚è¿æ¥æ± ä¸€èˆ¬æ˜¯æŒ‡æ¯ä¸ªè¿æ¥åŒæ—¶åªä¸ºä¸€ä¸ªè¯·æ±‚æä¾›æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª RTT å†…åªä¼šå­˜åœ¨ä¸€ä¸ªè¯·æ±‚ï¼Œæ­¤æ—¶å¦‚æœå­˜åœ¨å¤§é‡å¹¶å‘è¯·æ±‚å¿…é¡»ä½¿ç”¨ä¸€ä¸ª<strong>è¿æ¥æ± </strong>æ¥ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚ä½†è¿æ¥æœ¬èº«æ˜¯å…¨åŒå·¥çš„ï¼Œå®Œå…¨å¯ä»¥ä¸€ç›´å‘é€ Requestï¼Œä¸€ç›´å‘é€ Responseï¼Œè¿™ä¹Ÿæ˜¯<strong>å¤šè·¯å¤ç”¨</strong>çš„å«ä¹‰ï¼Œä½†è¿™éœ€è¦åº”ç”¨å±‚åè®®æ”¯æŒå¯¹ç»™æ¯ä¸ªåŒ…æ ‡å®šä¸€ä¸ª ID æ¥ç”¨ä»¥åˆ†å‰²ä¸åŒè¯·æ±‚å’Œå“åº”ã€‚<p>HTTP 1.0 åè®®å°±æ˜¯å› ä¸ºå¹¶æœªå¯¹æ¯ä¸ªè¯·æ±‚æ ‡å®š IDï¼Œæ‰€ä»¥åœ¨å®ç°ä¸Šä¸å¯èƒ½æ”¯æŒå¤šè·¯å¤ç”¨ã€‚è€Œåœ¨ HTTP 1.1 åè®®ä¸­ï¼Œå¢åŠ äº† Keep-Alive è¿æ¥ä¿æ´»ä»¥åŠ Pipeline çš„æ¦‚å¿µï¼Œè¯·æ±‚å¯ä»¥ä¸åœå‘ï¼Œä½†æ˜¯ Response è¿”å›çš„é¡ºåºå¿…é¡»æ˜¯å‘é€æ—¶çš„é¡ºåºï¼Œä»¥æ­¤æ¥å°½å¯èƒ½å¤ç”¨è¿æ¥ã€‚ä½†æ˜¯ Pipeline å¯¹ Response é¡ºåºçš„è¦æ±‚ä¼šå¯¼è‡´å¦‚æœæŸä¸ªè¯·æ±‚å¤„ç†æ—¶é—´æ¯”è¾ƒé•¿ï¼Œé‚£ä¹ˆåé¢çš„è¿”å›ä¼šä¸€ç›´å †ç§¯ã€‚1.1 å› ä¸ºæ˜¯ 1.0 çš„ä¿®è®¢ç‰ˆï¼Œæ‰€ä»¥ä¸å¤ªå¯èƒ½å¢åŠ å¤ªå¤šä¸å…¼å®¹çš„å˜æ›´ã€‚ä½†åœ¨ HTTP 2.0 ä¸­ï¼Œå°±å¢åŠ äº† stream ID æ¥å®ç°å¤šè·¯å¤ç”¨çš„èƒ½åŠ›ã€‚<p>Thrift åè®®ä¹Ÿä¼šåœ¨å¼€å¤´(8~12 bytes)æ ‡æ˜è‡ªå·±çš„åºåˆ—å· IDï¼Œæ‰€ä»¥ä¹Ÿèƒ½å¾ˆå¥½æ”¯æŒå¤šè·¯å¤ç”¨ã€‚<p>ä½†æ˜¯ä¸»æµæ•°æ®åº“åè®®å¦‚ Mysql å´å¤§å¤šéƒ½ä¸æ”¯æŒè¿æ¥çš„å¤šè·¯å¤ç”¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ç»å¸¸ä¼šéœ€è¦å»é…ç½®æ•°æ®åº“è¿æ¥æ± çš„åŸå› ã€‚æ•°æ®åº“çš„å¤§éƒ¨åˆ†æ—¶é—´æ¶ˆè€—åœ¨ç£ç›˜ IO å’Œ CPU è®¡ç®—ï¼Œä½¿ç”¨è¿æ¥æ± çš„æ–¹å¼å¯ä»¥ä¿è¯æœ‰é™åº¦çš„å¹¶å‘è¯·æ±‚é‡ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªæŠŠæ´»å¹²å®Œï¼Œå¦‚æœå‡ºç°ç¹å¿™çŠ¶å†µï¼Œè¯·æ±‚ä¸»è¦è¢«é˜»å¡åœ¨ Client ç«¯ã€‚å¦‚æœæ˜¯å¤šè·¯å¤ç”¨çš„æ–¹å¼ï¼ŒClient å¹¶æ²¡æœ‰åŠæ³•å‡†ç¡®ä¼°è®¡å‡º Server çš„è´Ÿè½½èƒ½åŠ›ï¼Œå¤§é‡è¯·æ±‚ä¾æ—§ä¼šè¢«å‘å‡ºå»ï¼Œé˜»å¡åœ¨æ•°æ®åº“ä¾§ï¼Œè¿™ä¸ªå¾€å¾€æˆ‘ä»¬æ˜¯ä¸æƒ³çœ‹åˆ°çš„ã€‚å¦å¤–ï¼Œè¿æ¥æ± çš„æ–¹å¼å¯¹äº Client çš„å®ç°æ¥è¯´å¾€å¾€ä¹Ÿæ›´åŠ å®¹æ˜“ã€‚<h2 id=server-push>Server Push</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“è¿æ¥æœ¬èº«æ˜¯å…¨åŒå·¥çš„ï¼ŒClient å’Œ Server ä¹‹é—´æƒ³æ€ä¹ˆå‘æ¶ˆæ¯å°±æ€ä¹ˆå‘ï¼Œä½•å†µä¸€ä¸ªè¯·æ±‚çš„è¿”å›æ¶ˆæ¯æœ¬èº«å°±æ˜¯ä¸€ä¸ªå­—é¢æ„ä¹‰çš„ Server Pushã€‚é‚£ä¸ºä»€ä¹ˆ HTTP 2.0 ä»¥åŠä¸€äº› RPC åè®®è¿˜è¦å»æ ‡æ¦œè‡ªå·±æ”¯æŒ Server Push ï¼Ÿ<p>è¿™ä¸ªé—®é¢˜æœ¬èº«åˆæ˜¯ä¸€ä¸ªè½¯ä»¶å·¥ç¨‹çš„é—®é¢˜ã€‚æˆ‘ä»¬å·²ç»ä¹ æƒ¯äº†ç”¨è¾“å…¥è¾“å‡ºçš„æ¨¡å¼å»ç¼–ç¨‹ï¼Œæ‰€ä»¥åœ¨åè®®è®¾è®¡çš„æ—¶å€™ï¼Œå¾ˆå°‘è€ƒè™‘åˆ°è¾“å…¥æ²¡è¾“å‡ºï¼Œè¾“å‡ºæ²¡è¾“å…¥çš„è¿™ç§æƒ…å†µã€‚Server Push å°±å±äºä¸€ç§è¾“å‡ºæ²¡è¾“å…¥çš„æƒ…å†µã€‚<p>åœ¨ HTTP 1.1 é‡Œï¼Œä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯åº”è¯¥å¦‚ä¸‹ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>===</span> <span class=n>Request</span> <span class=o>===</span>
</span></span><span class=line><span class=cl><span class=n>GET</span> <span class=o>/</span><span class=n>hello</span><span class=o>.</span><span class=n>txt</span> <span class=n>HTTP</span><span class=o>/</span><span class=mf>1.1</span>
</span></span><span class=line><span class=cl><span class=n>User</span><span class=o>-</span><span class=n>Agent</span><span class=p>:</span> <span class=n>curl</span><span class=o>/</span><span class=mf>7.16</span><span class=o>.</span><span class=mi>3</span> <span class=n>libcurl</span><span class=o>/</span><span class=mf>7.16</span><span class=o>.</span><span class=mi>3</span> <span class=n>OpenSSL</span><span class=o>/</span><span class=mf>0.9</span><span class=o>.</span><span class=mi>7</span><span class=n>l</span> <span class=n>zlib</span><span class=o>/</span><span class=mf>1.2</span><span class=o>.</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=p>:</span> <span class=n>www</span><span class=o>.</span><span class=n>example</span><span class=o>.</span><span class=n>com</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>-</span><span class=n>Language</span><span class=p>:</span> <span class=n>en</span><span class=p>,</span> <span class=n>mi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>===</span> <span class=n>Response</span> <span class=o>===</span>
</span></span><span class=line><span class=cl><span class=n>HTTP</span><span class=o>/</span><span class=mf>1.1</span> <span class=mi>200</span> <span class=n>OK</span>
</span></span><span class=line><span class=cl><span class=n>Date</span><span class=p>:</span> <span class=n>Mon</span><span class=p>,</span> <span class=mi>27</span> <span class=n>Jul</span> <span class=mi>2009</span> <span class=mi>12</span><span class=p>:</span><span class=mi>28</span><span class=p>:</span><span class=mi>53</span> <span class=n>GMT</span>
</span></span><span class=line><span class=cl><span class=n>Server</span><span class=p>:</span> <span class=n>Apache</span>
</span></span><span class=line><span class=cl><span class=n>Last</span><span class=o>-</span><span class=n>Modified</span><span class=p>:</span> <span class=n>Wed</span><span class=p>,</span> <span class=mi>22</span> <span class=n>Jul</span> <span class=mi>2009</span> <span class=mi>19</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>56</span> <span class=n>GMT</span>
</span></span><span class=line><span class=cl><span class=n>ETag</span><span class=p>:</span> <span class=s2>&#34;34aa387-d-1568eb00&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>-</span><span class=n>Ranges</span><span class=p>:</span> <span class=n>bytes</span>
</span></span><span class=line><span class=cl><span class=n>Content</span><span class=o>-</span><span class=n>Length</span><span class=p>:</span> <span class=mi>51</span>
</span></span><span class=line><span class=cl><span class=n>Vary</span><span class=p>:</span> <span class=n>Accept</span><span class=o>-</span><span class=n>Encoding</span>
</span></span><span class=line><span class=cl><span class=n>Content</span><span class=o>-</span><span class=n>Type</span><span class=p>:</span> <span class=n>text</span><span class=o>/</span><span class=n>plain</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Hello</span> <span class=ne>World</span><span class=o>!</span> <span class=n>My</span> <span class=n>payload</span> <span class=n>includes</span> <span class=n>a</span> <span class=n>trailing</span> <span class=n>CRLF</span><span class=o>.</span>
</span></span></code></pre></div><p>æ¯ä¸ª Response å¿…é¡»å¯¹åº”ä¸€ä¸ª Requestï¼Œä»ä»£ç ä¾§æ¥è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ã€‚è¯•æƒ³å¦‚æœæ­¤æ—¶ Server åœ¨è¿æ¥ä¸­ï¼Œè«åå…¶å¦™è¿”å›äº†ä¸€ä¸ªå®¢æˆ·ç«¯æ²¡æœ‰è¯·æ±‚çš„ Responseï¼Œä»£ç å®ç°ä¸Šèƒ½æ€ä¹ˆåšï¼Ÿä»£ç æ ¹æœ¬æ²¡è°ƒç”¨ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡åœ°æ–¹åœ¨ç›‘å¬ç­‰å¾…è¿™ä¸ª Response ï¼Œè‡ªç„¶æ²¡åœ°æ–¹ä¼šå»å¤„ç†å®ƒã€‚<p>åäººåœ¨ HTTP 1.1 ä¸Šæ‰€å®ç°çš„æ‰€è°“çš„é•¿è½®è¯¢ï¼Œæ— éæ˜¯åˆ©ç”¨é•¿è¿æ¥çš„ç‰¹æ€§ï¼Œå»¶è¿Ÿå‘é€äº†æ¶ˆæ¯ã€‚ä¸å…¶è¯´æ˜¯ä»€ä¹ˆæ–°æŠ€æœ¯ï¼Œä¸æ˜¯è¯´æ˜¯æŠ•æœºå–å·§ï¼Œä½†æ˜¯çš„ç¡®åœ¨ç®€å•çš„åœºæ™¯ä¸‹æ˜¯ä¸€ä¸ªå¥½ç”¨çš„æ–¹æ¡ˆã€‚è¦å½»åº•è§£å†³é—®é¢˜å¿…é¡»ä¿®æ”¹åè®®ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¼šæœ‰ WebSocket å’Œ HTTP 2.0 çš„åŸå› ã€‚<p>åœ¨ HTTP 2.0 ä¸­ï¼Œé€šè¿‡æ ‡è®°ç‰¹æ®Šçš„å¸§ PUSH_PROMISE æ¥è¡¨ç¤ºè¿™ä¸ªæ¶ˆæ¯æ˜¯æ²¡æœ‰å¯¹åº” Request çš„ï¼Œä½†å…·ä½“å®ç°çš„æ—¶å€™ä¼šå‘ç°ï¼Œå°±ç®— Server èƒ½å¤Ÿ Push å†…å®¹ç»™ Clientï¼ŒClient ä¹Ÿéœ€è¦å»è§£æä¸åŒæ¶ˆæ¯å…·ä½“å«ä¹‰æ˜¯ä»€ä¹ˆã€‚åœ¨ä¼ ç»Ÿæ¨¡å¼ä¸‹ï¼Œä¸€ä¸ª Response çš„å«ä¹‰ç”± Request å†³å®šï¼Œä½†ç°åœ¨ä¸€ä¸ªæ²¡æœ‰ Request çš„ Response åªèƒ½é€šè¿‡è§£æå…¶å†…å®¹å†³å®šã€‚è¿™å°±å¯¼è‡´äº†å®ç°è¿™ä¸ªè§£æçš„è¿‡ç¨‹å…¶å®æ˜¯å¯ä»¥å„å®¶è‡ªå·±å®šä¹‰è‡ªå·±çš„ã€‚å¯¹äºæµè§ˆå™¨æ ‡å‡†è€Œè¨€ï¼ŒServer Push ä¸€èˆ¬ç”¨äºé™æ€èµ„æºï¼Œæ‰€ä»¥å°±éœ€è¦å»ºç«‹ä¸€å¥—èµ„æºç¼“å­˜çš„æ ‡å‡†ã€‚<p>è€Œåœ¨ grpc ä¸­ï¼Œè™½ç„¶åº•å±‚ç”¨çš„æ˜¯ HTTP 2.0 ï¼Œä½†å¹¶æ²¡æœ‰ä½¿ç”¨ PUSH_PROMISE åŠŸèƒ½ï¼Œå°±æ˜¯å› ä¸ºå¯¹äº RPC è€Œè¨€ï¼Œæˆ‘å¯ä»¥ä¸€ä¸ªè¯·æ±‚æœ‰å¤šä¸ªè¿”å›ï¼ˆæ‰€è°“çš„æµæ¨¡å¼ï¼‰ï¼Œä½†æ˜¯ä¸èƒ½è¯´æ²¡æœ‰è¯·æ±‚ç›´æ¥æœ‰è¿”å›ï¼Œå¦åˆ™ç”¨æˆ·å¤„ç†ä¾§ä¼šæ›´åŠ å¤æ‚ä¸”ä¸ç»Ÿä¸€äº†ã€‚grpc ä½¿ç”¨æµæ¨¡å¼çš„ç¤ºä¾‹ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>stream</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>streamClient</span><span class=p>.</span><span class=nf>Ping</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>err</span> <span class=p>=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>response</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹å‡ºï¼ŒServer Push ä»æ¥ä¸æ˜¯ä¸€é¡¹æ–°æŠ€æœ¯ï¼Œå› ä¸ºä¸€ç›´ä»¥æ¥è¿™åŠŸèƒ½å°±æ˜¯ TCP ç°æˆçš„ã€‚æˆ‘ä»¬æ‰€ç¼ºå°‘çš„ï¼Œå…¶å®ä»…ä»…åªæ˜¯åœ¨åº”ç”¨å±‚çš„æ“ä½œè§„èŒƒè€Œå·²ã€‚<h2 id=æœ€å>æœ€å</h2><p>ä» epoll çš„è¯ç”Ÿï¼Œåˆ° Server Push é—®é¢˜çš„è§£å†³ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹åˆ°ï¼Œæ‰€è°“çš„æ–°æŠ€æœ¯ä»æ›´åŠ å®è§‚çš„è§†è§’æ¥çœ‹å‹æ ¹å°±ä¸èƒ½ç®—æ˜¯æŠ€æœ¯ï¼Œä»…ä»…åªæ˜¯ä¸€äº›å¯¹çº¦å®šå…±è¯†çš„æ”¹å˜è€Œå·²ã€‚ä½†å°±æ˜¯è¿™ç§å…±è¯†çš„æ”¹å˜ï¼Œå¯èƒ½ä¼šéœ€è¦å‡ åå¹´çš„æ—¶é—´ã€‚<p>æ–‡æ˜å»ºç«‹åœ¨å…±è¯†çš„åŸºç¡€ä¸Šï¼ŒæŠ€æœ¯ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æ–‡æ˜çš„è¿›æ­¥é å»ç ´é™¤å¥³å­æ— æ‰ä¾¿æ˜¯å¾·è¿™ç±»æ—§æœ‰çš„å…±è¯†ï¼ŒæŠ€æœ¯çš„è¿›æ­¥ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</div><div class="row middle-xs"><div class=col-xs-12><div class=post-tags><a href=/tags/rpc/>RPC</a></div><div class=post-tags><a href=/tags/service-mesh/>Service Mesh</a></div></div></div><div class=row><div class=col-xs-12><br><br><p>Subscribeï¼š<a target=_blank href=https://mailchi.mp/a1a0d59e7a19/joway><b>Mailchimp</b></a></p><br><a rel=license href=http://creativecommons.org/licenses/by-nc-nd/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://blog.joway.io/images/cc.png></a></div></div><div class=related-content><h3>Related Posts</h3><ul><li><a href=/posts/deep-into-rpc-serialization/>RPC æ¼«è°ˆï¼šåºåˆ—åŒ–é—®é¢˜</a><li><a href=/posts/deep-into-rpc-ratelimiter/>RPC æ¼«è°ˆï¼š é™æµé—®é¢˜</a></ul></div><div style=height:50px></div><div class=post-comments><div id=disqus_thread></div><script>window.addEventListener("load",()=>{(function(){var e=document,t=e.createElement("script");t.src="https://joway.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()})</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><div class=site-footer></div></div></div></article><script src=https://cdn.jsdelivr.net/gh/joway/blog/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("disqus_thread");if(!e)return;const t=new MutationObserver(function(n){n.forEach(function(){const n=e.getElementsByTagName("iframe");if(n.length>1){const s=n[1];for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(s),t.disconnect()}})});t.observe(e,{childList:!0,subtree:!0})})</script>