<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.148.2"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Joway"><meta property="og:url" content="https://blog.joway.io/posts/golang-rethink-program-in-realworld/"><link rel=canonical href=https://blog.joway.io/posts/golang-rethink-program-in-realworld/><link rel=dns-prefetch href=https://cdn.jsdelivr.net/gh/joway/blog><link rel=apple-touch-icon href=/logo.png><link rel=icon href=/logo.png><link rel=shortcut href=/logo.png><link rel=alternate type=application/atom+xml href=https://blog.joway.io/index.xml title="Random Thoughts"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.joway.io\/"},"articleSection":"posts","name":"é‡æ–°æ€è€ƒ Goï¼šäº†è§£ç¨‹åºåœ¨çº¿ä¸Šæ˜¯å¦‚ä½•è¿è¡Œçš„","headline":"é‡æ–°æ€è€ƒ Goï¼šäº†è§£ç¨‹åºåœ¨çº¿ä¸Šæ˜¯å¦‚ä½•è¿è¡Œçš„","description":" é‡æ–°æ€è€ƒ Go ç³»åˆ—ï¼šè¿™ä¸ªç³»åˆ—å¸Œæœ›ç»“åˆå·¥ä½œä¸­åœ¨ Go ç¼–ç¨‹ä¸æ€§èƒ½ä¼˜åŒ–ä¸­é‡åˆ°è¿‡çš„é—®é¢˜ï¼Œæ¢è®¨ Go åœ¨è¯­è¨€å“²å­¦ã€åº•å±‚å®ç°å’Œç°å®éœ€æ±‚ä¸‰è€…ä¹‹é—´å…³ç³»ä¸çŸ›ç›¾ã€‚\nå‰è¨€ è¿‡å»ä¸€æ®µæ—¶é—´ï¼Œåœ¨å¤§é‡çš„çº¿ä¸ŠæœåŠ¡ case study è¿‡ç¨‹ä¸­ï¼Œé€æ­¥æ·±å…¥äº†è§£äº†å¦‚ä»Šçš„ä¸šåŠ¡ Go è¿›ç¨‹æ˜¯å¦‚ä½•åœ¨ä¸€ç³»åˆ—ç¹æ‚çš„åŸºç¡€è®¾æ–½ä¹‹ä¸Šè¿è¡Œçš„ã€‚æœ‰äº›è¡¨ç°åœ¨æ„æ–™ä¹‹ä¸­ï¼Œä¹Ÿæœ‰ä¸€äº›å‡ºä¹æ„æ–™çš„å‘ç°ã€‚\næˆ‘å¾ˆå–œæ¬¢ä¸€ä¸ªå«åšã€Œ æœºæ¢°åŒç†å¿ƒ\/Mechanical Sympathy ã€çš„æ¦‚å¿µï¼Œå¤§ä½“çš„æ„æ€æ˜¯ä½ å¿…é¡»æ·±åˆ»äº†è§£ä½ çš„ç¨‹åº\/æœºæ¢°è£…ç½®æ˜¯åœ¨ä¸€ç§æ€ä¹ˆæ ·çš„ç¯å¢ƒä¸‹è¿è¡Œçš„ï¼Œè®¾èº«å¤„åœ°åœ°åœ¨è¿™ä¸ªè¿è¡Œç¯å¢ƒä¸‹å»æ€è€ƒï¼Œæ‰èƒ½å¸®åŠ©ä½ å†™å‡ºæ›´å¥½çš„ç¨‹åºï¼Œæˆ–æ˜¯è§£ç­”ä¸€äº›å¥‡æ€ªç°è±¡çš„åŸå› ã€‚\næœ¬æ–‡å¸Œæœ›è¾¾åˆ°çš„ç›®çš„ï¼Œä¹Ÿæ˜¯æ„å»ºè¿™ä»½ã€Œæœºæ¢°åŒç†å¿ƒã€ã€‚\nç¨‹åºèƒ½ä½¿ç”¨å¤šå°‘è®¡ç®—èµ„æºï¼Ÿ å¯¹äºå¾ˆå¤šäººæ¥è¯´ï¼Œè¿™ä¸ªé—®é¢˜ä¼¼ä¹éå¸¸ç®€å•ï¼Œå¤§å¤šçš„è®¡ç®—å¹³å°éƒ½ä¼šè¦æ±‚ä½ å»ºç«‹æœåŠ¡çš„æ—¶å€™å°±æŒ‡å®šå¥½ã€Œéœ€è¦çš„è®¡ç®—èµ„æºã€ï¼Œä½†è¿™ä¸ä½ çš„ã€Œèƒ½ä½¿ç”¨çš„è®¡ç®—èµ„æºã€æ˜¯ä¸¤ä»¶äº‹æƒ…ã€‚å®é™…ä¸Šè¿™ä¸ªé—®é¢˜çš„å¤æ‚æ€§è¿œè¿œè¶…å‡ºå¤§éƒ¨åˆ†äººç°è±¡ï¼Œç”šè‡³éƒ½ä¸æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨å…¬å¼ç®€å•è®¡ç®—ã€‚æŠ½è±¡åœ°è®²ï¼Œè¿™å–å†³äºå¤©æ—¶åœ°åˆ©äººå’Œã€‚\nã€Œå¤©æ—¶ã€æŒ‡çš„æ˜¯å†…æ ¸ Cgroups ä»¥åŠå®¹å™¨è°ƒåº¦å¹³å°çš„åŸºæœ¬åŸç†å’Œå‚æ•°è®¾ç½®ã€‚è¿™æ˜¯ç¡¬æŒ‡æ ‡ï¼Œå¤§éƒ¨åˆ†æ—¶å€™ä¹Ÿæ˜¯å¸¸é‡ã€‚ ã€Œåœ°åˆ©ã€æŒ‡çš„æ˜¯éƒ¨ç½²çš„å®é™…ç‰©ç†æœºçš„ç¹å¿™ç¨‹åº¦ã€‚ ã€Œäººå’Œã€æŒ‡çš„æ˜¯å†™ç¨‹åºçš„äººå¾—åœ¨èƒ½å¤Ÿæœ‰æ›´å¤šè®¡ç®—èµ„æºå¯ç”¨çš„æ—¶å€™çœŸçš„è®©è‡ªå·±ç¨‹åºç”¨ä¸Šè¿™äº›è®¡ç®—èµ„æºã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬é€æ­¥åˆ†èŠ‚æ¥è¯¦ç»†æ¢ç©¶è¿™ä¸ªé—®é¢˜ã€‚\nè¢«å°è£…çš„ CPU è°è¨€ åœ¨ Oncall ä¸­å¸¸è§çš„ä¸€ä¸ªè¯¯è§£æ˜¯ï¼Œç ”å‘äººå‘˜åœ¨å®¹å™¨å¹³å°ä¸Šç”³è¯·äº† 4 æ ¸ CPU çš„å®¹å™¨ï¼Œç„¶åè‡ªç„¶è€Œç„¶è®¤ä¸ºè‡ªå·±çš„ç¨‹åºæœ€å¤šåªèƒ½ä½¿ç”¨ 4 ä¸ª CPUï¼Œäºæ˜¯æŒ‰ç…§è¿™ä¸ªè®¡ç®—èƒ½åŠ›å»ä¼°ç®—éœ€è¦çš„å®¹å™¨æ•°é‡ï¼Œä»¥åŠå¯¹è‡ªå·±ç¨‹åºå¥—ä¸Šè¿™ä¸ªå‡è®¾è¿›è¡Œå‚æ•°è°ƒä¼˜ã€‚\nä¸Šçº¿åï¼Œè¿›åˆ°å®¹å™¨ç”¨ top ä¸€çœ‹ï¼Œå„é¡¹æŒ‡æ ‡ç¡®å®æ˜¯æŒ‰ç…§ 4 æ ¸çš„æ ‡å‡†åœ¨è¿›è¡Œã€‚ç”šè‡³ç”¨ cat \/proc\/cpuinfo ä¸€çœ‹ï¼Œä¸å¤šä¸å°‘åˆšå¥½çœ‹åˆ°æœ‰ 4 ä¸ª CPUã€‚ã€‚ã€‚\nä½†å®é™…ä¸Šï¼Œè¿™ä¸€åˆ‡éƒ½åªæ˜¯å®¹å™¨å¹³å°ä¸ºä½ å°è£…å‡ºæ¥çš„ä¸€ä¸ªç¾å¥½çš„å‡è±¡ã€‚ä¹‹æ‰€ä»¥è¦æŠŠè¿™ä¸ªå‡è±¡åšçš„è¿™ä¹ˆé€¼çœŸï¼Œåªæ˜¯ä¸ºäº†è®©ä½ æ‘†è„±ç¼–ç¨‹æ—¶çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œé¡ºä¾¿å†è®©é‚£äº›ä¼ ç»Ÿçš„ Linux è§‚æµ‹å·¥å…·åœ¨å®¹å™¨ç¯å¢ƒä¸­ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚\nä½†æ˜¯å‡è±¡ç»ˆç©¶ä¸æ˜¯çœŸç›¸ï¼Œå¦‚æœæœ‰ä¸€å¤©ä½ é‡åˆ°ä¸€äº›ç–‘éš¾é—®é¢˜æˆ–æ˜¯æƒ³è¦å»ç¼–å†™æè‡´æ€§èƒ½çš„ä»£ç ï¼Œä½ ä¼šå‘ç°è¿™äº›å°è£…å‡ºæ¥çš„æŠ½è±¡æŠŠä½ çš„ç†è§£å¸¦çš„æœ‰å¤šåã€‚\næˆ‘åˆ°åº•èƒ½åŒæ—¶ä½¿ç”¨å¤šå°‘ä¸ª CPU ï¼Ÿ åœ¨ K8s çš„ç¯å¢ƒé‡Œï¼ŒCPU æ˜¯ä¸€ä¸ªæ—¶é—´å•ä½è€Œéæ•°é‡ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ‹¥æœ‰ 64 æ ¸å¿ƒçš„æœºå™¨ï¼Œä½ æœ€å¤šèƒ½åŒæ—¶ä½¿ç”¨çš„ç†è®º CPU ä¸ªæ•°æ˜¯ 64 ï¼Œå³ä¾¿ä½ åˆ›å»ºå®¹å™¨çš„æ—¶å€™ç”³è¯·çš„æ˜¯ 4 æ ¸ã€‚\n","inLanguage":"en-US","author":"Joway","creator":"Joway","publisher":"Joway","accountablePerson":"Joway","copyrightHolder":"Joway","copyrightYear":"2024","datePublished":"2024-12-10 00:00:00 \u002b0000 UTC","dateModified":"2024-12-10 00:00:00 \u002b0000 UTC","url":"https:\/\/blog.joway.io\/posts\/golang-rethink-program-in-realworld\/","keywords":[]}</script><title>é‡æ–°æ€è€ƒ Goï¼šäº†è§£ç¨‹åºåœ¨çº¿ä¸Šæ˜¯å¦‚ä½•è¿è¡Œçš„</title><meta property="og:title" content="é‡æ–°æ€è€ƒ Goï¼šäº†è§£ç¨‹åºåœ¨çº¿ä¸Šæ˜¯å¦‚ä½•è¿è¡Œçš„"><meta property="og:type" content="article"><meta property="og:description" content=" é‡æ–°æ€è€ƒ Go ç³»åˆ—ï¼šè¿™ä¸ªç³»åˆ—å¸Œæœ›ç»“åˆå·¥ä½œä¸­åœ¨ Go ç¼–ç¨‹ä¸æ€§èƒ½ä¼˜åŒ–ä¸­é‡åˆ°è¿‡çš„é—®é¢˜ï¼Œæ¢è®¨ Go åœ¨è¯­è¨€å“²å­¦ã€åº•å±‚å®ç°å’Œç°å®éœ€æ±‚ä¸‰è€…ä¹‹é—´å…³ç³»ä¸çŸ›ç›¾ã€‚
å‰è¨€ è¿‡å»ä¸€æ®µæ—¶é—´ï¼Œåœ¨å¤§é‡çš„çº¿ä¸ŠæœåŠ¡ case study è¿‡ç¨‹ä¸­ï¼Œé€æ­¥æ·±å…¥äº†è§£äº†å¦‚ä»Šçš„ä¸šåŠ¡ Go è¿›ç¨‹æ˜¯å¦‚ä½•åœ¨ä¸€ç³»åˆ—ç¹æ‚çš„åŸºç¡€è®¾æ–½ä¹‹ä¸Šè¿è¡Œçš„ã€‚æœ‰äº›è¡¨ç°åœ¨æ„æ–™ä¹‹ä¸­ï¼Œä¹Ÿæœ‰ä¸€äº›å‡ºä¹æ„æ–™çš„å‘ç°ã€‚
æˆ‘å¾ˆå–œæ¬¢ä¸€ä¸ªå«åšã€Œ æœºæ¢°åŒç†å¿ƒ/Mechanical Sympathy ã€çš„æ¦‚å¿µï¼Œå¤§ä½“çš„æ„æ€æ˜¯ä½ å¿…é¡»æ·±åˆ»äº†è§£ä½ çš„ç¨‹åº/æœºæ¢°è£…ç½®æ˜¯åœ¨ä¸€ç§æ€ä¹ˆæ ·çš„ç¯å¢ƒä¸‹è¿è¡Œçš„ï¼Œè®¾èº«å¤„åœ°åœ°åœ¨è¿™ä¸ªè¿è¡Œç¯å¢ƒä¸‹å»æ€è€ƒï¼Œæ‰èƒ½å¸®åŠ©ä½ å†™å‡ºæ›´å¥½çš„ç¨‹åºï¼Œæˆ–æ˜¯è§£ç­”ä¸€äº›å¥‡æ€ªç°è±¡çš„åŸå› ã€‚
æœ¬æ–‡å¸Œæœ›è¾¾åˆ°çš„ç›®çš„ï¼Œä¹Ÿæ˜¯æ„å»ºè¿™ä»½ã€Œæœºæ¢°åŒç†å¿ƒã€ã€‚
ç¨‹åºèƒ½ä½¿ç”¨å¤šå°‘è®¡ç®—èµ„æºï¼Ÿ å¯¹äºå¾ˆå¤šäººæ¥è¯´ï¼Œè¿™ä¸ªé—®é¢˜ä¼¼ä¹éå¸¸ç®€å•ï¼Œå¤§å¤šçš„è®¡ç®—å¹³å°éƒ½ä¼šè¦æ±‚ä½ å»ºç«‹æœåŠ¡çš„æ—¶å€™å°±æŒ‡å®šå¥½ã€Œéœ€è¦çš„è®¡ç®—èµ„æºã€ï¼Œä½†è¿™ä¸ä½ çš„ã€Œèƒ½ä½¿ç”¨çš„è®¡ç®—èµ„æºã€æ˜¯ä¸¤ä»¶äº‹æƒ…ã€‚å®é™…ä¸Šè¿™ä¸ªé—®é¢˜çš„å¤æ‚æ€§è¿œè¿œè¶…å‡ºå¤§éƒ¨åˆ†äººç°è±¡ï¼Œç”šè‡³éƒ½ä¸æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨å…¬å¼ç®€å•è®¡ç®—ã€‚æŠ½è±¡åœ°è®²ï¼Œè¿™å–å†³äºå¤©æ—¶åœ°åˆ©äººå’Œã€‚
ã€Œå¤©æ—¶ã€æŒ‡çš„æ˜¯å†…æ ¸ Cgroups ä»¥åŠå®¹å™¨è°ƒåº¦å¹³å°çš„åŸºæœ¬åŸç†å’Œå‚æ•°è®¾ç½®ã€‚è¿™æ˜¯ç¡¬æŒ‡æ ‡ï¼Œå¤§éƒ¨åˆ†æ—¶å€™ä¹Ÿæ˜¯å¸¸é‡ã€‚ ã€Œåœ°åˆ©ã€æŒ‡çš„æ˜¯éƒ¨ç½²çš„å®é™…ç‰©ç†æœºçš„ç¹å¿™ç¨‹åº¦ã€‚ ã€Œäººå’Œã€æŒ‡çš„æ˜¯å†™ç¨‹åºçš„äººå¾—åœ¨èƒ½å¤Ÿæœ‰æ›´å¤šè®¡ç®—èµ„æºå¯ç”¨çš„æ—¶å€™çœŸçš„è®©è‡ªå·±ç¨‹åºç”¨ä¸Šè¿™äº›è®¡ç®—èµ„æºã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬é€æ­¥åˆ†èŠ‚æ¥è¯¦ç»†æ¢ç©¶è¿™ä¸ªé—®é¢˜ã€‚
è¢«å°è£…çš„ CPU è°è¨€ åœ¨ Oncall ä¸­å¸¸è§çš„ä¸€ä¸ªè¯¯è§£æ˜¯ï¼Œç ”å‘äººå‘˜åœ¨å®¹å™¨å¹³å°ä¸Šç”³è¯·äº† 4 æ ¸ CPU çš„å®¹å™¨ï¼Œç„¶åè‡ªç„¶è€Œç„¶è®¤ä¸ºè‡ªå·±çš„ç¨‹åºæœ€å¤šåªèƒ½ä½¿ç”¨ 4 ä¸ª CPUï¼Œäºæ˜¯æŒ‰ç…§è¿™ä¸ªè®¡ç®—èƒ½åŠ›å»ä¼°ç®—éœ€è¦çš„å®¹å™¨æ•°é‡ï¼Œä»¥åŠå¯¹è‡ªå·±ç¨‹åºå¥—ä¸Šè¿™ä¸ªå‡è®¾è¿›è¡Œå‚æ•°è°ƒä¼˜ã€‚
ä¸Šçº¿åï¼Œè¿›åˆ°å®¹å™¨ç”¨ top ä¸€çœ‹ï¼Œå„é¡¹æŒ‡æ ‡ç¡®å®æ˜¯æŒ‰ç…§ 4 æ ¸çš„æ ‡å‡†åœ¨è¿›è¡Œã€‚ç”šè‡³ç”¨ cat /proc/cpuinfo ä¸€çœ‹ï¼Œä¸å¤šä¸å°‘åˆšå¥½çœ‹åˆ°æœ‰ 4 ä¸ª CPUã€‚ã€‚ã€‚
ä½†å®é™…ä¸Šï¼Œè¿™ä¸€åˆ‡éƒ½åªæ˜¯å®¹å™¨å¹³å°ä¸ºä½ å°è£…å‡ºæ¥çš„ä¸€ä¸ªç¾å¥½çš„å‡è±¡ã€‚ä¹‹æ‰€ä»¥è¦æŠŠè¿™ä¸ªå‡è±¡åšçš„è¿™ä¹ˆé€¼çœŸï¼Œåªæ˜¯ä¸ºäº†è®©ä½ æ‘†è„±ç¼–ç¨‹æ—¶çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œé¡ºä¾¿å†è®©é‚£äº›ä¼ ç»Ÿçš„ Linux è§‚æµ‹å·¥å…·åœ¨å®¹å™¨ç¯å¢ƒä¸­ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚
ä½†æ˜¯å‡è±¡ç»ˆç©¶ä¸æ˜¯çœŸç›¸ï¼Œå¦‚æœæœ‰ä¸€å¤©ä½ é‡åˆ°ä¸€äº›ç–‘éš¾é—®é¢˜æˆ–æ˜¯æƒ³è¦å»ç¼–å†™æè‡´æ€§èƒ½çš„ä»£ç ï¼Œä½ ä¼šå‘ç°è¿™äº›å°è£…å‡ºæ¥çš„æŠ½è±¡æŠŠä½ çš„ç†è§£å¸¦çš„æœ‰å¤šåã€‚
æˆ‘åˆ°åº•èƒ½åŒæ—¶ä½¿ç”¨å¤šå°‘ä¸ª CPU ï¼Ÿ åœ¨ K8s çš„ç¯å¢ƒé‡Œï¼ŒCPU æ˜¯ä¸€ä¸ªæ—¶é—´å•ä½è€Œéæ•°é‡ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ‹¥æœ‰ 64 æ ¸å¿ƒçš„æœºå™¨ï¼Œä½ æœ€å¤šèƒ½åŒæ—¶ä½¿ç”¨çš„ç†è®º CPU ä¸ªæ•°æ˜¯ 64 ï¼Œå³ä¾¿ä½ åˆ›å»ºå®¹å™¨çš„æ—¶å€™ç”³è¯·çš„æ˜¯ 4 æ ¸ã€‚
"><meta name=description content=" é‡æ–°æ€è€ƒ Go ç³»åˆ—ï¼šè¿™ä¸ªç³»åˆ—å¸Œæœ›ç»“åˆå·¥ä½œä¸­åœ¨ Go ç¼–ç¨‹ä¸æ€§èƒ½ä¼˜åŒ–ä¸­é‡åˆ°è¿‡çš„é—®é¢˜ï¼Œæ¢è®¨ Go åœ¨è¯­è¨€å“²å­¦ã€åº•å±‚å®ç°å’Œç°å®éœ€æ±‚ä¸‰è€…ä¹‹é—´å…³ç³»ä¸çŸ›ç›¾ã€‚
å‰è¨€ è¿‡å»ä¸€æ®µæ—¶é—´ï¼Œåœ¨å¤§é‡çš„çº¿ä¸ŠæœåŠ¡ case study è¿‡ç¨‹ä¸­ï¼Œé€æ­¥æ·±å…¥äº†è§£äº†å¦‚ä»Šçš„ä¸šåŠ¡ Go è¿›ç¨‹æ˜¯å¦‚ä½•åœ¨ä¸€ç³»åˆ—ç¹æ‚çš„åŸºç¡€è®¾æ–½ä¹‹ä¸Šè¿è¡Œçš„ã€‚æœ‰äº›è¡¨ç°åœ¨æ„æ–™ä¹‹ä¸­ï¼Œä¹Ÿæœ‰ä¸€äº›å‡ºä¹æ„æ–™çš„å‘ç°ã€‚
æˆ‘å¾ˆå–œæ¬¢ä¸€ä¸ªå«åšã€Œ æœºæ¢°åŒç†å¿ƒ/Mechanical Sympathy ã€çš„æ¦‚å¿µï¼Œå¤§ä½“çš„æ„æ€æ˜¯ä½ å¿…é¡»æ·±åˆ»äº†è§£ä½ çš„ç¨‹åº/æœºæ¢°è£…ç½®æ˜¯åœ¨ä¸€ç§æ€ä¹ˆæ ·çš„ç¯å¢ƒä¸‹è¿è¡Œçš„ï¼Œè®¾èº«å¤„åœ°åœ°åœ¨è¿™ä¸ªè¿è¡Œç¯å¢ƒä¸‹å»æ€è€ƒï¼Œæ‰èƒ½å¸®åŠ©ä½ å†™å‡ºæ›´å¥½çš„ç¨‹åºï¼Œæˆ–æ˜¯è§£ç­”ä¸€äº›å¥‡æ€ªç°è±¡çš„åŸå› ã€‚
æœ¬æ–‡å¸Œæœ›è¾¾åˆ°çš„ç›®çš„ï¼Œä¹Ÿæ˜¯æ„å»ºè¿™ä»½ã€Œæœºæ¢°åŒç†å¿ƒã€ã€‚
ç¨‹åºèƒ½ä½¿ç”¨å¤šå°‘è®¡ç®—èµ„æºï¼Ÿ å¯¹äºå¾ˆå¤šäººæ¥è¯´ï¼Œè¿™ä¸ªé—®é¢˜ä¼¼ä¹éå¸¸ç®€å•ï¼Œå¤§å¤šçš„è®¡ç®—å¹³å°éƒ½ä¼šè¦æ±‚ä½ å»ºç«‹æœåŠ¡çš„æ—¶å€™å°±æŒ‡å®šå¥½ã€Œéœ€è¦çš„è®¡ç®—èµ„æºã€ï¼Œä½†è¿™ä¸ä½ çš„ã€Œèƒ½ä½¿ç”¨çš„è®¡ç®—èµ„æºã€æ˜¯ä¸¤ä»¶äº‹æƒ…ã€‚å®é™…ä¸Šè¿™ä¸ªé—®é¢˜çš„å¤æ‚æ€§è¿œè¿œè¶…å‡ºå¤§éƒ¨åˆ†äººç°è±¡ï¼Œç”šè‡³éƒ½ä¸æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨å…¬å¼ç®€å•è®¡ç®—ã€‚æŠ½è±¡åœ°è®²ï¼Œè¿™å–å†³äºå¤©æ—¶åœ°åˆ©äººå’Œã€‚
ã€Œå¤©æ—¶ã€æŒ‡çš„æ˜¯å†…æ ¸ Cgroups ä»¥åŠå®¹å™¨è°ƒåº¦å¹³å°çš„åŸºæœ¬åŸç†å’Œå‚æ•°è®¾ç½®ã€‚è¿™æ˜¯ç¡¬æŒ‡æ ‡ï¼Œå¤§éƒ¨åˆ†æ—¶å€™ä¹Ÿæ˜¯å¸¸é‡ã€‚ ã€Œåœ°åˆ©ã€æŒ‡çš„æ˜¯éƒ¨ç½²çš„å®é™…ç‰©ç†æœºçš„ç¹å¿™ç¨‹åº¦ã€‚ ã€Œäººå’Œã€æŒ‡çš„æ˜¯å†™ç¨‹åºçš„äººå¾—åœ¨èƒ½å¤Ÿæœ‰æ›´å¤šè®¡ç®—èµ„æºå¯ç”¨çš„æ—¶å€™çœŸçš„è®©è‡ªå·±ç¨‹åºç”¨ä¸Šè¿™äº›è®¡ç®—èµ„æºã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬é€æ­¥åˆ†èŠ‚æ¥è¯¦ç»†æ¢ç©¶è¿™ä¸ªé—®é¢˜ã€‚
è¢«å°è£…çš„ CPU è°è¨€ åœ¨ Oncall ä¸­å¸¸è§çš„ä¸€ä¸ªè¯¯è§£æ˜¯ï¼Œç ”å‘äººå‘˜åœ¨å®¹å™¨å¹³å°ä¸Šç”³è¯·äº† 4 æ ¸ CPU çš„å®¹å™¨ï¼Œç„¶åè‡ªç„¶è€Œç„¶è®¤ä¸ºè‡ªå·±çš„ç¨‹åºæœ€å¤šåªèƒ½ä½¿ç”¨ 4 ä¸ª CPUï¼Œäºæ˜¯æŒ‰ç…§è¿™ä¸ªè®¡ç®—èƒ½åŠ›å»ä¼°ç®—éœ€è¦çš„å®¹å™¨æ•°é‡ï¼Œä»¥åŠå¯¹è‡ªå·±ç¨‹åºå¥—ä¸Šè¿™ä¸ªå‡è®¾è¿›è¡Œå‚æ•°è°ƒä¼˜ã€‚
ä¸Šçº¿åï¼Œè¿›åˆ°å®¹å™¨ç”¨ top ä¸€çœ‹ï¼Œå„é¡¹æŒ‡æ ‡ç¡®å®æ˜¯æŒ‰ç…§ 4 æ ¸çš„æ ‡å‡†åœ¨è¿›è¡Œã€‚ç”šè‡³ç”¨ cat /proc/cpuinfo ä¸€çœ‹ï¼Œä¸å¤šä¸å°‘åˆšå¥½çœ‹åˆ°æœ‰ 4 ä¸ª CPUã€‚ã€‚ã€‚
ä½†å®é™…ä¸Šï¼Œè¿™ä¸€åˆ‡éƒ½åªæ˜¯å®¹å™¨å¹³å°ä¸ºä½ å°è£…å‡ºæ¥çš„ä¸€ä¸ªç¾å¥½çš„å‡è±¡ã€‚ä¹‹æ‰€ä»¥è¦æŠŠè¿™ä¸ªå‡è±¡åšçš„è¿™ä¹ˆé€¼çœŸï¼Œåªæ˜¯ä¸ºäº†è®©ä½ æ‘†è„±ç¼–ç¨‹æ—¶çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œé¡ºä¾¿å†è®©é‚£äº›ä¼ ç»Ÿçš„ Linux è§‚æµ‹å·¥å…·åœ¨å®¹å™¨ç¯å¢ƒä¸­ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚
ä½†æ˜¯å‡è±¡ç»ˆç©¶ä¸æ˜¯çœŸç›¸ï¼Œå¦‚æœæœ‰ä¸€å¤©ä½ é‡åˆ°ä¸€äº›ç–‘éš¾é—®é¢˜æˆ–æ˜¯æƒ³è¦å»ç¼–å†™æè‡´æ€§èƒ½çš„ä»£ç ï¼Œä½ ä¼šå‘ç°è¿™äº›å°è£…å‡ºæ¥çš„æŠ½è±¡æŠŠä½ çš„ç†è§£å¸¦çš„æœ‰å¤šåã€‚
æˆ‘åˆ°åº•èƒ½åŒæ—¶ä½¿ç”¨å¤šå°‘ä¸ª CPU ï¼Ÿ åœ¨ K8s çš„ç¯å¢ƒé‡Œï¼ŒCPU æ˜¯ä¸€ä¸ªæ—¶é—´å•ä½è€Œéæ•°é‡ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ‹¥æœ‰ 64 æ ¸å¿ƒçš„æœºå™¨ï¼Œä½ æœ€å¤šèƒ½åŒæ—¶ä½¿ç”¨çš„ç†è®º CPU ä¸ªæ•°æ˜¯ 64 ï¼Œå³ä¾¿ä½ åˆ›å»ºå®¹å™¨çš„æ—¶å€™ç”³è¯·çš„æ˜¯ 4 æ ¸ã€‚
"><meta property="og:locale" content="cn"><meta property="og:image" content="/logo.png"><style>:root{--bg-color:#ffffff;--text-color:#000000;--link-color:#000000;--border-color:#482936;--secondary-text:#666666;--code-bg:#f6f8fa;--blockquote-color:#57606a;--blockquote-border:#d0d7de;--disqus-bg:white}[data-theme=dark]{--bg-color:#1a1a1a;--text-color:#e0e0e0;--link-color:#b0b0b0;--border-color:#8b5a7a;--secondary-text:#aaaaaa;--code-bg:#2d2d2d;--blockquote-color:#a0a0a0;--blockquote-border:#404040;--disqus-bg:#1a1a1a}body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px;background-color:var(--bg-color);color:var(--text-color)}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:var(--link-color);text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:var(--link-color)}.markdown-body blockquote{margin:0;padding:0 1em;color:var(--blockquote-color);border-left:.25em solid var(--blockquote-border)}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px;background-color:var(--code-bg)}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:var(--code-bg);border-radius:6px}.markdown-body pre>code{padding:0;font-size:100%;background-color:var(--code-bg);border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:var(--secondary-text)}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-item-left{margin-left:5px;margin-right:auto}.header-line{width:100%;border-width:2px;border-color:var(--border-color);border-style:solid none none none}.lang-switch{font-weight:600}.theme-toggle{background:0 0;border:none;color:var(--link-color);cursor:pointer;font-weight:600;font-size:inherit;padding:0}.theme-toggle:hover{font-weight:800}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:var(--text-color)2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:var(--text-color)2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:6px}.post-content .post-gallery{display:flex;flex-wrap:wrap;gap:6px}.post-content .post-gallery img{margin-right:auto;margin-top:auto;width:calc(50% - 3px)}.related-content{border-width:3px;border-style:solid;border-color:var(--text-color);padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:var(--disqus-bg)}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}.post-content .post-gallery img{width:100%}}@media screen and (max-width:48em){.posts-category{display:none}}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=https://cdn.jsdelivr.net/gh/joway/blog/index.xml rel=alternate type=application/rss+xml title="Random Thoughts"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel=stylesheet><script data-cfasync=false>(function(){const o="theme",e={light:"light",dark:"dark",system:"system"};function t(){return window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function n(){return localStorage.getItem(o)}function r(){const s=n();return s&&s!==e.system?s:t()}function s(n){const s=document.documentElement;n===e.system&&(n=t()),n===e.dark?s.setAttribute("data-theme","dark"):s.removeAttribute("data-theme"),i(n)}function i(e){const t=document.getElementById("theme-toggle");t&&(t.textContent=e==="dark"?"â˜€ï¸":"ğŸŒ™")}function a(){i(r())}function c(){const o=n();let i;o?(i=o===e.system?t():o,s(o)):(i=t(),s(e.system))}function l(){const a=n()||e.system;let i;a===e.system?i=t()==="dark"?e.light:e.dark:a===e.dark?i=e.light:i=e.dark,localStorage.setItem(o,i),s(i)}window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){const t=n();(!t||t===e.system)&&s(e.system)}),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",a):a(),window.toggleTheme=l,c()})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53624533-8"></script><script src=https://cdn.jsdelivr.net/gh/joway/homepage/analytics.js></script><article class="post ç®€ä½“ä¸­æ–‡" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>Random Thoughts</a></div><div class=header-subtitle>Log something useless, but interesting.</div></header><div class="row end-md header-items"><div class=header-item-left><button id=theme-toggle onclick=toggleTheme() class=theme-toggle>
ğŸŒ™</button></div><div class=header-item><a href=https://mailchi.mp/a1a0d59e7a19/joway target=_blank>Subscribe</a></div><div class=header-item><a href=/travel target=_blank>Travel</a></div><div class=header-item><a href=https://joway.io target=_blank>About</a></div></div><div class=row></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>é‡æ–°æ€è€ƒ Goï¼šäº†è§£ç¨‹åºåœ¨çº¿ä¸Šæ˜¯å¦‚ä½•è¿è¡Œçš„</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2024-12-10 00:00:00 UTC">10 Dec 2024</time></div><div class=col-xs-6><div class=post-author><a target=_blank href>@Joway</a></div></div></div></header><div class="post-content markdown-body"><blockquote><p>é‡æ–°æ€è€ƒ Go ç³»åˆ—ï¼šè¿™ä¸ªç³»åˆ—å¸Œæœ›ç»“åˆå·¥ä½œä¸­åœ¨ Go ç¼–ç¨‹ä¸æ€§èƒ½ä¼˜åŒ–ä¸­é‡åˆ°è¿‡çš„é—®é¢˜ï¼Œæ¢è®¨ Go åœ¨è¯­è¨€å“²å­¦ã€åº•å±‚å®ç°å’Œç°å®éœ€æ±‚ä¸‰è€…ä¹‹é—´å…³ç³»ä¸çŸ›ç›¾ã€‚</blockquote><h2 id=å‰è¨€>å‰è¨€</h2><p>è¿‡å»ä¸€æ®µæ—¶é—´ï¼Œåœ¨å¤§é‡çš„çº¿ä¸ŠæœåŠ¡ case study è¿‡ç¨‹ä¸­ï¼Œé€æ­¥æ·±å…¥äº†è§£äº†å¦‚ä»Šçš„ä¸šåŠ¡ Go è¿›ç¨‹æ˜¯å¦‚ä½•åœ¨ä¸€ç³»åˆ—ç¹æ‚çš„åŸºç¡€è®¾æ–½ä¹‹ä¸Šè¿è¡Œçš„ã€‚æœ‰äº›è¡¨ç°åœ¨æ„æ–™ä¹‹ä¸­ï¼Œä¹Ÿæœ‰ä¸€äº›å‡ºä¹æ„æ–™çš„å‘ç°ã€‚<p>æˆ‘å¾ˆå–œæ¬¢ä¸€ä¸ªå«åšã€Œ æœºæ¢°åŒç†å¿ƒ/Mechanical Sympathy ã€çš„æ¦‚å¿µï¼Œå¤§ä½“çš„æ„æ€æ˜¯ä½ å¿…é¡»æ·±åˆ»äº†è§£ä½ çš„ç¨‹åº/æœºæ¢°è£…ç½®æ˜¯åœ¨ä¸€ç§æ€ä¹ˆæ ·çš„ç¯å¢ƒä¸‹è¿è¡Œçš„ï¼Œè®¾èº«å¤„åœ°åœ°åœ¨è¿™ä¸ªè¿è¡Œç¯å¢ƒä¸‹å»æ€è€ƒï¼Œæ‰èƒ½å¸®åŠ©ä½ å†™å‡ºæ›´å¥½çš„ç¨‹åºï¼Œæˆ–æ˜¯è§£ç­”ä¸€äº›å¥‡æ€ªç°è±¡çš„åŸå› ã€‚<p>æœ¬æ–‡å¸Œæœ›è¾¾åˆ°çš„ç›®çš„ï¼Œä¹Ÿæ˜¯æ„å»ºè¿™ä»½ã€Œæœºæ¢°åŒç†å¿ƒã€ã€‚<h2 id=ç¨‹åºèƒ½ä½¿ç”¨å¤šå°‘è®¡ç®—èµ„æº>ç¨‹åºèƒ½ä½¿ç”¨å¤šå°‘è®¡ç®—èµ„æºï¼Ÿ</h2><p>å¯¹äºå¾ˆå¤šäººæ¥è¯´ï¼Œè¿™ä¸ªé—®é¢˜ä¼¼ä¹éå¸¸ç®€å•ï¼Œå¤§å¤šçš„è®¡ç®—å¹³å°éƒ½ä¼šè¦æ±‚ä½ å»ºç«‹æœåŠ¡çš„æ—¶å€™å°±æŒ‡å®šå¥½ã€Œéœ€è¦çš„è®¡ç®—èµ„æºã€ï¼Œä½†è¿™ä¸ä½ çš„ã€Œèƒ½ä½¿ç”¨çš„è®¡ç®—èµ„æºã€æ˜¯ä¸¤ä»¶äº‹æƒ…ã€‚å®é™…ä¸Šè¿™ä¸ªé—®é¢˜çš„å¤æ‚æ€§è¿œè¿œè¶…å‡ºå¤§éƒ¨åˆ†äººç°è±¡ï¼Œç”šè‡³éƒ½ä¸æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨å…¬å¼ç®€å•è®¡ç®—ã€‚æŠ½è±¡åœ°è®²ï¼Œè¿™å–å†³äºå¤©æ—¶åœ°åˆ©äººå’Œã€‚<ul><li>ã€Œå¤©æ—¶ã€æŒ‡çš„æ˜¯å†…æ ¸ Cgroups ä»¥åŠå®¹å™¨è°ƒåº¦å¹³å°çš„åŸºæœ¬åŸç†å’Œå‚æ•°è®¾ç½®ã€‚è¿™æ˜¯ç¡¬æŒ‡æ ‡ï¼Œå¤§éƒ¨åˆ†æ—¶å€™ä¹Ÿæ˜¯å¸¸é‡ã€‚<li>ã€Œåœ°åˆ©ã€æŒ‡çš„æ˜¯éƒ¨ç½²çš„å®é™…ç‰©ç†æœºçš„ç¹å¿™ç¨‹åº¦ã€‚<li>ã€Œäººå’Œã€æŒ‡çš„æ˜¯å†™ç¨‹åºçš„äººå¾—åœ¨èƒ½å¤Ÿæœ‰æ›´å¤šè®¡ç®—èµ„æºå¯ç”¨çš„æ—¶å€™çœŸçš„è®©è‡ªå·±ç¨‹åºç”¨ä¸Šè¿™äº›è®¡ç®—èµ„æºã€‚</ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬é€æ­¥åˆ†èŠ‚æ¥è¯¦ç»†æ¢ç©¶è¿™ä¸ªé—®é¢˜ã€‚<h3 id=è¢«å°è£…çš„-cpu-è°è¨€>è¢«å°è£…çš„ CPU è°è¨€</h3><p>åœ¨ Oncall ä¸­å¸¸è§çš„ä¸€ä¸ªè¯¯è§£æ˜¯ï¼Œç ”å‘äººå‘˜åœ¨å®¹å™¨å¹³å°ä¸Šç”³è¯·äº† 4 æ ¸ CPU çš„å®¹å™¨ï¼Œç„¶åè‡ªç„¶è€Œç„¶è®¤ä¸ºè‡ªå·±çš„ç¨‹åºæœ€å¤šåªèƒ½ä½¿ç”¨ 4 ä¸ª CPUï¼Œäºæ˜¯æŒ‰ç…§è¿™ä¸ªè®¡ç®—èƒ½åŠ›å»ä¼°ç®—éœ€è¦çš„å®¹å™¨æ•°é‡ï¼Œä»¥åŠå¯¹è‡ªå·±ç¨‹åºå¥—ä¸Šè¿™ä¸ªå‡è®¾è¿›è¡Œå‚æ•°è°ƒä¼˜ã€‚<p>ä¸Šçº¿åï¼Œè¿›åˆ°å®¹å™¨ç”¨ top ä¸€çœ‹ï¼Œå„é¡¹æŒ‡æ ‡ç¡®å®æ˜¯æŒ‰ç…§ 4 æ ¸çš„æ ‡å‡†åœ¨è¿›è¡Œã€‚ç”šè‡³ç”¨ <code>cat /proc/cpuinfo</code> ä¸€çœ‹ï¼Œä¸å¤šä¸å°‘åˆšå¥½çœ‹åˆ°æœ‰ 4 ä¸ª CPUã€‚ã€‚ã€‚<p>ä½†å®é™…ä¸Šï¼Œè¿™ä¸€åˆ‡éƒ½åªæ˜¯å®¹å™¨å¹³å°ä¸ºä½ å°è£…å‡ºæ¥çš„ä¸€ä¸ªç¾å¥½çš„å‡è±¡ã€‚ä¹‹æ‰€ä»¥è¦æŠŠè¿™ä¸ªå‡è±¡åšçš„è¿™ä¹ˆé€¼çœŸï¼Œåªæ˜¯ä¸ºäº†è®©ä½ æ‘†è„±ç¼–ç¨‹æ—¶çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œé¡ºä¾¿å†è®©é‚£äº›ä¼ ç»Ÿçš„ Linux è§‚æµ‹å·¥å…·åœ¨å®¹å™¨ç¯å¢ƒä¸­ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚<p>ä½†æ˜¯å‡è±¡ç»ˆç©¶ä¸æ˜¯çœŸç›¸ï¼Œå¦‚æœæœ‰ä¸€å¤©ä½ é‡åˆ°ä¸€äº›ç–‘éš¾é—®é¢˜æˆ–æ˜¯æƒ³è¦å»ç¼–å†™æè‡´æ€§èƒ½çš„ä»£ç ï¼Œä½ ä¼šå‘ç°è¿™äº›å°è£…å‡ºæ¥çš„æŠ½è±¡æŠŠä½ çš„ç†è§£å¸¦çš„æœ‰å¤šåã€‚<h3 id=æˆ‘åˆ°åº•èƒ½åŒæ—¶ä½¿ç”¨å¤šå°‘ä¸ª-cpu->æˆ‘åˆ°åº•èƒ½åŒæ—¶ä½¿ç”¨å¤šå°‘ä¸ª CPU ï¼Ÿ</h3><p>åœ¨ K8s çš„ç¯å¢ƒé‡Œï¼ŒCPU æ˜¯ä¸€ä¸ªæ—¶é—´å•ä½è€Œéæ•°é‡ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ‹¥æœ‰ 64 æ ¸å¿ƒçš„æœºå™¨ï¼Œä½ æœ€å¤šèƒ½åŒæ—¶ä½¿ç”¨çš„ç†è®º CPU ä¸ªæ•°æ˜¯ 64 ï¼Œå³ä¾¿ä½ åˆ›å»ºå®¹å™¨çš„æ—¶å€™ç”³è¯·çš„æ˜¯ 4 æ ¸ã€‚<p>ä½†æ˜¯ç”±äºä½ ç”³è¯·çš„æ˜¯æ‰€è°“çš„ 4 CPUï¼Œæ‰€ä»¥ä½ æœ€ç»ˆä½¿ç”¨çš„ CPU æ—¶é—´åŠ èµ·æ¥æœ€å¤šåªèƒ½ç›¸å½“äº 4 CPU çš„æ—¶é—´ã€‚<p>å³ï¼Œç¨‹åºçš„æœ€å¤§å¹¶è¡Œæ•° = ç‰©ç†æœº CPU æ ¸å¿ƒä¸ªæ•°ï¼›ç¨‹åºçš„æœ€å¤§æ‰§è¡Œæ—¶é—´ = å®¹å™¨ CPU Quota ã€‚<h3 id=go-ç¨‹åºèƒ½åŒæ—¶ä½¿ç”¨å¤šå°‘ä¸ª-cpu->Go ç¨‹åºèƒ½åŒæ—¶ä½¿ç”¨å¤šå°‘ä¸ª CPU ?</h3><p>ä¸Šä¸€èŠ‚è®²çš„æ˜¯å®¹å™¨æœ¬èº«çš„æœ€å¤§å¹¶è¡Œæ•°å¹¶æ²¡æœ‰æ˜ç¡®çš„é™åˆ¶ï¼Œä¸Šé™æ˜¯ CPU æ ¸å¿ƒæ•°é‡ã€‚ç”¨å¤šç”¨å°‘å®é™…ä¸Šå®Œå…¨å–å†³äºä½ çš„ç¨‹åºè‡ªèº«è®¾è®¡ã€‚<p>ä½†ç”±äº Golang å¯¹å¹¶è¡Œæ•°çš„è®¾è®¡æ˜¯éšè—åœ¨ Runtime ä¸­çš„ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ GOMAXPROCSã€‚è¿™ä¸ªå€¼å¹¶æ²¡æœ‰ä¸€ä¸ªæ˜ç¡®çš„ Guideline å‘Šè¯‰ç”¨æˆ·åº”è¯¥å¦‚ä½•è°ƒæ•´ï¼Œå®é™…ä¸Šä¸åŒå…¬å¸çš„éƒ¨ç½²æ¶æ„ä»¥åŠå®¹å™¨å¹³å°å®ç°å¯¹äºè¿™ä¸ªå€¼çš„è°ƒæ•´éƒ½ä¼šæœ‰æˆªç„¶ä¸åŒçš„æ ‡å‡†ã€‚è¢«å¹¿æ³›é‡‡ç”¨çš„æ˜¯ <a href=https://github.com/uber-go/automaxprocs>Uber çš„æ ‡å‡†</a> ï¼Œå³æ ¹æ®å®¹å™¨çš„ CPU Quota ä¸Šé™æ¥è®¾ç½® GOMAXPROCS ã€‚æ‰€ä»¥è™½ç„¶ K8s å¯¹å®¹å™¨çš„åŸæœ¬è®¾å®šè™½ç„¶ä¸é™åˆ¶ä½ åŒæ—¶ä½¿ç”¨çš„ CPU ä¸ªæ•°ï¼Œä½†å…¶å®åœ¨ Uber è§„èŒƒçš„è¿™ç§éšå¼è¡Œä¸ºè®¾å®šä¸‹ï¼Œå®¹å™¨çš„ CPU quota å®é™…ä¸Šé—´æ¥å†³å®šäº†ç¨‹åºçš„æœ€å¤§å¹¶å‘æ•°ã€‚<p>å‡å¦‚ä½ æ˜¯ä¸€ä¸ª 1 ç§’é’Ÿå†…ï¼Œä¼šåŒæ—¶è¿è¡Œ 16 ä¸ªå¹¶è¡Œä»»åŠ¡ä¸”æ¯ä¸ªä»…æŒç»­ 10ms çš„ç¨‹åºï¼Œå½“ä½ éƒ¨ç½²åœ¨ä¸€ä¸ªç”³è¯·äº† 4 ä¸ª CPU quota çš„å®¹å™¨ä¸­æ—¶ï¼Œä½ ä¼šå‘ç°è™½ç„¶ä½  CPU åˆ©ç”¨ç‡æä½ï¼Œä½†æ˜¯ç¨‹åºæ— è®ºå¦‚ä½•éƒ½è·‘ä¸å¿«ã€‚è¿™å°±æ˜¯å› ä¸ºè¿™å¥— GOMAXPROCS è®¾ç½®ç»™ä½ åˆ›é€ äº†ä¸€ä¸ªè‡ªæˆ‘å—é™çš„è¿è¡Œç¯å¢ƒã€‚<h3 id=æˆ‘åˆ°åº•èƒ½ç”¨å¤šå°‘è®¡ç®—èµ„æº>æˆ‘åˆ°åº•èƒ½ç”¨å¤šå°‘è®¡ç®—èµ„æº</h3><p>å‰é¢è®²çš„å¤šå°‘ä¸ª CPU å¹¶ä¸ç­‰ä»·äºã€Œè®¡ç®—èµ„æºã€ï¼Œè®¡ç®—èµ„æºé€šä¿—ç†è§£å°±æ˜¯å•ä½æ—¶é—´å†…ï¼Œè¿™ç‰©ç†æœºçš„æ‰€æœ‰ CPU æ ¸å¿ƒæœ€ç»ˆèƒ½è½®åˆ°æ‰§è¡Œä½ ç¨‹åºçš„æ—¶é—´ã€‚<p>ä½ åœ¨ K8s ä¸Šé…ç½®çš„ CPU quota ä¹‹æ‰€ä»¥å«åš quota ï¼Œæ˜¯è¯´ä½ æœ€å¤šå¯ä»¥è¿è¡Œåˆ°è¿™ä¸ªæ•°å­—ï¼Œä½†ä¸ä»£è¡¨ä¸€å®šç»™ä½ è¿™ä¸ªæ•°å­—çš„è®¡ç®—èµ„æºã€‚è‡³äºä½ çœŸçš„èƒ½å¤Ÿæœ‰å¤šå°‘è®¡ç®—èµ„æºï¼Œè¯´å®è¯ï¼Œnobody knows &mldr;&mldr;.<p>ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªé—®é¢˜å–å†³äºï¼š<ol><li><p>ç‰©ç†æœºè‡ªèº«è´Ÿè½½ï¼šå¦‚æœç‰©ç†æœºè´Ÿè½½å·²ç»å¾ˆé«˜ ï¼Œä½ åŸºæœ¬ä¸Šå¾ˆéš¾æœ‰è¿æ°”è¿è¡Œæ»¡ CPU quota æ ‡æ³¨çš„è®¡ç®—é‡ã€‚æ¯”å¦‚æˆ‘åœ¨æŸå®¹å™¨å¹³å°ä¸Šéƒ¨ç½²ä¸€ä¸ªå®Œå…¨æ— ä¸šåŠ¡é€»è¾‘çš„ PingPong æœåŠ¡ï¼Œå®ƒçš„å»¶è¿Ÿä¹Ÿä¼šéšç€ä¸€å¤©æ—¶é—´å˜åŒ–è€Œå˜åŒ–ã€‚è¿™æ˜¯å› ä¸ºç‰©ç†æœºçš„ç¹å¿™ç¨‹åº¦åœ¨å˜åŒ–ï¼Œæ‰€ä»¥å®é™…ä¸Šä½ ç¨‹åºå¯è·å¾—çš„è®¡ç®—èµ„æºä¹Ÿåœ¨å˜åŒ–ã€‚<li><p>ç¨‹åºè®¾è®¡é—®é¢˜ï¼šå‡è®¾ä½ æ˜¯ä¸€ä¸ªå•çº¿ç¨‹ç¨‹åºï¼Œä½ çš„ä¸Šé™ä¹Ÿå°± 1 CPU è¿è¡Œæ»¡ï¼Œè‡ªç„¶æ— æ³•ä½¿ç”¨æ»¡å…¨éƒ¨çš„è®¡ç®—èµ„æºã€‚ä½ å¯èƒ½ä¼šè¯´æˆ‘æ˜¯ä¸€ä¸ª Golang ç¨‹åºï¼Œä¸æ˜¯å•çº¿ç¨‹ç¨‹åºã€‚ç„¶è€Œ Go çš„è®¾è®¡åå‘äºé«˜å¹¶å‘ä½å¹¶è¡Œï¼Œè®¸å¤š Go ä»£ç åœ¨è°ƒåº¦å™¨çš„ä½œç”¨ä¸‹ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå€¾å‘äºå•çº¿ç¨‹è¿è¡Œçš„ä»£ç ã€‚è¿™å…¶ä¸­çš„å¥¥ç§˜æ˜¯åç»­æ·±å…¥å±•å¼€çš„é‡ç‚¹ã€‚</ol><h2 id=go-å¦‚ä½•è°ƒåº¦è®¡ç®—èµ„æº>Go å¦‚ä½•è°ƒåº¦è®¡ç®—èµ„æº</h2><p>æ¯ä¸€ä¸ª Goroutine éƒ½å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªä»»åŠ¡ï¼ŒCPU æ˜¯ä»»åŠ¡çš„æ‰§è¡Œå™¨ã€‚ä¸€ä¸ªä»»åŠ¡ä»ã€Œå¯ä»¥è¿è¡Œ - Readyã€åˆ° ã€Œå¼€å§‹è¿è¡Œ - Running ã€çš„æ—¶é—´å³ä¸ºè°ƒåº¦å»¶è¿Ÿã€‚<p>è°ƒåº¦å»¶è¿Ÿçš„äº§ç”Ÿå¯èƒ½æ˜¯å› ä¸º CPU å¤ªå¿™åœ¨æ‰§è¡Œå…¶ä»– Goroutine ç”šè‡³æ˜¯å…¶ä»–è¿›ç¨‹çš„çº¿ç¨‹ï¼Œä¹Ÿå¯èƒ½æ˜¯å› ä¸ºè™½ç„¶æœ‰å…¶ä»– CPU ç©ºé—²ï¼Œä½†æ˜¯æˆ‘ä»»åŠ¡æŒ‚åœ¨æœ¬åœ°çº¿ç¨‹é˜Ÿåˆ—é‡Œï¼Œæ²¡æœ‰è¢«å…¶ä»– CPU ä¸Šçš„çº¿ç¨‹æ‹¿å–ã€‚<h3 id=è°ƒåº¦æ—¶æœºä¸å¼€é”€>è°ƒåº¦æ—¶æœºä¸å¼€é”€</h3><p>ä¸€ä¸ª Goroutine è¢«çœŸæ­£è°ƒåº¦åˆ°æ‰§è¡Œå­˜åœ¨ä¸‹ä»¥ä¸‹æ—¶æœºï¼š<ol><li>ã€å¼€é”€æœ€ä½ã€‘å‰ä¸€ä¸ª Goroutine æ‰§è¡Œå®Œæ¯•æˆ–è€…ä¸»åŠ¨è¿›å…¥ Waiting çŠ¶æ€ï¼Œå½“å‰ G å­˜åœ¨äºå½“å‰ P çš„ local runq é˜Ÿåˆ—<li>ã€å¼€é”€ä½ã€‘å‰ä¸€ä¸ª Goroutine æ‰§è¡Œæ—¶é—´è¿‡é•¿(~=10ms)ï¼Œåœ¨è°ƒç”¨å®ƒçš„æŸä¸ªå‡½æ•°æ—¶ï¼Œæ‰§è¡Œäº†åä½œå¼æŠ¢å ï¼Œå½“å‰ G å­˜åœ¨äºå½“å‰ P çš„ local runq é˜Ÿåˆ—<li>ã€å¼€é”€ä¸­ã€‘sysmon çº¿ç¨‹å¼‚æ­¥æŠ¢å ï¼ˆé€šè¿‡ä¸­æ–­ä¿¡å·ï¼‰æ‰§è¡Œæ—¶é—´è¿‡é•¿çš„ Goroutineï¼Œå¼ºè¡Œå‘èµ·è°ƒåº¦ã€‚å½“å‰ G å­˜åœ¨äºå½“å‰ P çš„ local runq é˜Ÿåˆ—ã€‚<li>ã€å¼€é”€å¤§ã€‘ä¸Šè¿°äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå½“å‰ local runq é˜Ÿåˆ—ä¸å­˜åœ¨å¯è¿è¡Œ Gï¼Œä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–å½“å‰ G<li>ã€å¼€é”€æœ€å¤§ã€‘ä¸Šè¿°äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œlocal å’Œ å…¨å±€ runq éƒ½ä¸å­˜åœ¨å¯è¿è¡Œ Gï¼Œä»åˆ«çš„ P å·å–ä»»åŠ¡</ol><h3 id=è°ƒåº¦çŠ¶æ€åˆ‡æ¢>è°ƒåº¦çŠ¶æ€åˆ‡æ¢</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span> <span class=c1>// G1</span>
</span></span><span class=line><span class=cl>   <span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>done</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=c1>// G2</span>
</span></span><span class=line><span class=cl>      <span class=c1>// do something</span>
</span></span><span class=line><span class=cl>      <span class=nx>done</span><span class=o>&lt;-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>   <span class=p>}()</span>
</span></span><span class=line><span class=cl>   <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=nx>res</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>done</span><span class=p>:</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>ä¸Šé¢è¿™æ®µä»£ç ï¼Œä¸€å…±æœ‰ä¸¤ä¸ª Goroutine: G1, G2ã€‚<p>è¿™ä¸¤ä¸ª Goroutine çš„çŠ¶æ€å˜åŒ–ä¸ºï¼š<ol><li>G1 runnable=>running: ä¸€å¼€å§‹å‡½æ•°å¼€å§‹è¿è¡Œ<li>G2 dead=>runnable: åˆ›å»ºå®Œ G2 åï¼Œåˆå§‹çŠ¶æ€<li>G1 running=>waiting: é˜»å¡åœ¨ select è¯­å¥<li>G2 runnable=>running: G2 å¼€å§‹è¿è¡Œã€‚æœ‰å¯èƒ½å’Œ G1 åœ¨åŒä¸€ä¸ª Pï¼Œä¹Ÿå¯èƒ½è¢«åˆ«çš„ P å·èµ°äº†ã€‚<li>G2 running=>waiting: é˜»å¡åœ¨ channel æ“ä½œã€‚å› ä¸º done æ˜¯æ— ç¼“å†²çš„ï¼Œæ‰€ä»¥æ­¤æ—¶ G2 å¹¶ä¸ä¼šé€€å‡º<li>G1 waiting=>runnable: channel send ä¼šçŸ¥é“ G1 é˜»å¡åœ¨è¿™é‡Œï¼Œæ‰€ä»¥ä¼šå…ˆä¿®æ”¹ G1 çŠ¶æ€ä¸º runnable<li>G1 runnable=>running: G1 æ¢å¤æ‰§è¡Œ</ol><p>è™½ç„¶è¿™æ®µä»£ç å¾ˆç®€å•ï¼Œä½†å­˜åœ¨å¤šæ¬¡åç¨‹åˆ‡æ¢ã€‚è¿™è¿˜ä¸ç®—æ¯ä¸€è¡Œä»£ç ä¹‹é—´è¿˜å¯èƒ½å­˜åœ¨å¼‚æ­¥æŠ¢å ï¼ˆå‡è®¾ä»£ç é€»è¾‘å¤æ‚çš„è¯ï¼‰ã€‚<p>æ¯ä¸€æ¬¡åˆ‡æ¢ï¼Œéƒ½æ„å‘³ç€ä¸‹ä¸€æ¬¡å¿…é¡»ä¾èµ– runtime è°ƒåº¦å™¨è°ƒåº¦æ‰èƒ½è·å¾—æ‰§è¡Œæœºä¼šã€‚<h3 id=è°ƒåº¦çš„ä»£ä»·>è°ƒåº¦çš„ä»£ä»·</h3><p>æ¯ä¸€ä¸ª Goroutine ä» runnable => running éƒ½ä¼šå­˜åœ¨ä¸€å®šå»¶è¿Ÿã€‚è¿™éƒ¨åˆ†å»¶è¿Ÿç§°ä¸ºè°ƒåº¦å»¶è¿Ÿã€‚<p>æ¯ä¸€æ¬¡è°ƒåº¦ï¼Œéƒ½ä¸ä¿è¯ä¼šç«‹åˆ»æ‰§è¡Œï¼Œä¹Ÿä¸ä¿è¯ä¸€å®šåœ¨æŸä¸ª P ä¸Šæ‰§è¡Œï¼Œæ›´ä¸ä¿è¯ä¸€å®šåœ¨ä¸€ä¸ªç‰©ç†çº¿ç¨‹ M ä¸Šæ‰§è¡Œã€‚<p>æ‰€ä»¥å³ä¾¿ä¸Šè¿°ä»£ç ç†è®ºä¸Šåº”è¯¥æ˜¯ä¸€ä¸ªçº³ç§’çº§åˆ«çš„ä»£ç å¼€é”€ï¼Œåœ¨çœŸå®ç¹å¿™çš„åœºæ™¯ä¸‹ï¼Œè°ƒåº¦å»¶è¿Ÿå¾ˆå¯èƒ½åœ¨æ¯«ç§’çº§åˆ«ã€‚ç”šè‡³ 5ms ä»¥ä¸Šä¹Ÿæ˜¯å¸¸è§çº¿ä¸Šæƒ…å†µã€‚<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿™é‡Œå‡è®¾çš„æ˜¯åº•å±‚ç‰©ç† CPU èµ„æºæ˜¯å……è¶³çš„æƒ…å†µä¸‹ï¼Œè€ŒçœŸå®çº¿ä¸Šçº¿ç¨‹æœ¬èº«ä¹Ÿæœ‰å†…æ ¸çš„è°ƒåº¦å»¶è¿Ÿï¼Œç”šè‡³æ˜¯ cgroup throttle æ•…æ„ä¼‘çœ çº¿ç¨‹ã€‚æ­¤æ—¶çœŸæ­£çœ‹åˆ°çš„å»¶è¿Ÿç”šè‡³èƒ½è¾¾åˆ°å‡ åæ¯«ç§’çº§åˆ«ã€‚<h3 id=è¡¡é‡è°ƒåº¦å¼€é”€>è¡¡é‡è°ƒåº¦å¼€é”€</h3><p>è°ƒåº¦å¼€é”€éƒ½åœ¨ç«ç„°å›¾çš„ <code>runtime.mcall</code> stack ä¸‹ï¼š<ol><li>å¦‚æœ <code>checkTimers</code> å¼€é”€ç‰¹åˆ«å¤§ï¼Œæ„å‘³ç€ä½ ä¸€å®šåˆ›å»ºäº†å¤§é‡ timerï¼Œä¸”è¿™äº› timer è¿˜å¤§æ¦‚ç‡éƒ½èƒ½åˆ°æœŸã€‚å¦‚æ–‡ç« å¼€å¤´è¿™ç§è¶…æ—¶æ§åˆ¶çš„ timerï¼Œè™½ç„¶å¾ˆå¤šï¼Œä½†æ˜¯ç»å¤§éƒ¨åˆ†éƒ½ä¸ä¼šåˆ°æœŸï¼Œæ‰€ä»¥æ€§èƒ½æŸè€—è¿˜å¥½ã€‚<li>å¦‚æœ <code>mPark</code> å¼€é”€ç‰¹åˆ«å¤§ï¼Œæ„å‘³ç€ä½ çº¿ç¨‹åˆ‡æ¢é¢‘ç‡å¾ˆé«˜ã€‚æ¯”å¦‚ä½ æ¯ç§’è¿è¡Œä¸€æ¬¡ï¼Œæ¯ä¸€æ¬¡åˆ›å»ºå‡ ç™¾ä¸ª goroutine æ‰¹å¤„ç†ä¸€äº›ä»»åŠ¡ï¼Œç„¶å 10ms åå°±å®Œæˆäº†ï¼Œä¼‘çœ  990msã€‚é‚£ä¹ˆæ¯ä¸€æ¬¡ä½ ç¨‹åºè¿è¡Œä»»åŠ¡ï¼Œéƒ½è¦å”¤é†’ä¸€å¤§æ‰¹å·²ç»å› ä¸ºæ²¡äº‹å¯åšè¢«ä¼‘çœ çš„çº¿ç¨‹ã€‚<li>å¦‚æœ <code>runtime.netpoll</code> å¼€é”€ç‰¹åˆ«å¤§ï¼Œå¤§æ¦‚ç‡ä½ è®¿é—®æ•°æ®åº“ç­‰ç½‘ç»œ IO ç‰¹åˆ«é¢‘ç¹ã€‚æ³¨æ„ï¼ŒKitex æ¡†æ¶æ—¶ï¼Œç½‘ç»œå¹¶ä¸èµ° runtime æ‰€ä»¥å¹¶æ²¡æœ‰è¿™ä¸ªå¼€é”€ã€‚<li>å¦‚æœ <code>stealWork</code> å¼€é”€ç‰¹åˆ«å¤§ï¼Œå¤§æ¦‚ç‡ä½ çš„ç¨‹åºç»å¸¸åœ¨ä¸€ä¸ª goroutine ä¸­ï¼Œä¸€æ¬¡æ€§åˆ›å»ºä¸€å¤§å † goroutineï¼Œè¿™æ ·å¯¼è‡´å¤§é‡ goroutine ç§¯å‹åœ¨æœ¬åœ° local runqï¼Œä¾èµ–å…¶ä»– P å»å·èµ°æ‰§è¡Œã€‚</ol><h2 id=go-gc-å¦‚ä½•å½±å“å»¶è¿Ÿ>Go GC å¦‚ä½•å½±å“å»¶è¿Ÿ</h2><p>å’Œæ‰€æœ‰ä¾èµ– GC çš„ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼ŒGO çš„ GC å»¶è¿Ÿä¹Ÿæ˜¯ä¸€å¤§å»¶è¿Ÿæ¥æºã€‚<h3 id=è§¦å‘-gc-çš„æ—¶æœº>è§¦å‘ GC çš„æ—¶æœº</h3><p>é™¤å»é•¿æ—¶é—´ä¸å‘ç”Ÿ GC å¼•èµ·çš„å®šæ—¶ GC å¤–ï¼ŒGC é€šå¸¸å‘ç”Ÿåœ¨ç”¨æˆ·åˆ›å»ºå †å¯¹è±¡è°ƒç”¨ mallocgc å‡½æ•°æ—¶ã€‚ä¾‹å¦‚å¦‚ä¸‹ä»£ç ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>buf</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>128</span><span class=p>)</span>
</span></span></code></pre></div><p>ç¼–ç¨‹è€…çš„é€šå¸¸é¢„æœŸæœ€å·®è¿™è¡Œä»£ç ä¹Ÿåº”è¯¥åœ¨ 1ms ä¹‹å†…å®Œæˆï¼Œç„¶è€Œå®é™…ä¸Šç”±äºè¿™ä¸ªæ“ä½œæœ‰å¯èƒ½è¢« Runtime åˆ‡å»å¸®åŠ©æ‰§è¡Œ GC çš„ä»»åŠ¡ï¼Œæ‰€ä»¥è¯¥è°ƒç”¨çš„å»¶è¿Ÿæ˜¯å®Œå…¨ä¸å—æ§çš„ï¼Œç”šè‡³é•¿è¾¾ä¸¤ä½æ•°æ¯«ç§’ä¹Ÿæ˜¯å¯èƒ½çš„ã€‚<h3 id=gc-æµç¨‹>GC æµç¨‹</h3><p>Go GC åˆ†ä¸º Mark å’Œ Sweep ä¸¤ä¸ªé˜¶æ®µã€‚<h4 id=mark---æ ‡è®°å¯¹è±¡>Mark - æ ‡è®°å¯¹è±¡</h4><p>Go çš„ä¸‰è‰²æ‰«æ Mark è¿‡ç¨‹çš„åŸç†ç›¸å¯¹ç®€å•ï¼Œå³æŠŠå…¨å±€å˜é‡ï¼Œæ‰€æœ‰ Goroutine çš„æ ˆä¸Šå˜é‡ä½œä¸ºæ ¹å¯¹è±¡å¼€å§‹æ‰«ææ ‡è®°ã€‚<p>å¦‚æœæŸä¸€ä¸ªå †å˜é‡å·²ç»ä¸è¢«æŒæœ‰ï¼Œåˆ™æ²¡æœ‰ Mark é˜¶æ®µçš„æˆæœ¬ã€‚<h4 id=sweep---æ¸…ç†é‡Šæ”¾å¯¹è±¡çš„å†…å­˜>Sweep - æ¸…ç†é‡Šæ”¾å¯¹è±¡çš„å†…å­˜</h4><h5 id=åˆ†é…å™¨ååŠ©-sweep>åˆ†é…å™¨ååŠ© Sweep</h5><p>Sweep è¢«åµŒå…¥åˆ°ç¨‹åºçš„æ¯ä¸€æ¬¡ Malloc æ“ä½œä¸­åˆ¤æ–­æ˜¯å¦è¦é¢å¤–æ‰§è¡Œ sweep æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¨‹åºå³ä¾¿åªæ˜¯è°ƒç”¨ä¸€ä¸ª make([]int, 1024) ï¼Œä¹Ÿå¯èƒ½ä¼šè¢«åˆ‡å»æ‰§è¡Œ sweepï¼Œä»è€Œäº§ç”Ÿç”¨æˆ·æ„æƒ³ä¸åˆ°çš„å»¶è¿Ÿã€‚<p>åœ¨ Mallocgc çš„æ—¶ï¼Œå¦‚æœå½“å‰ mcache span æ²¡æœ‰ç©ºé—´ï¼Œä¸”ä¸Šä¸€æ¬¡ GC mark åè¿˜æœ‰ sweep å·¥ä½œæ²¡æœ‰å®Œæˆï¼Œåˆ™ååŠ©å‚ä¸ sweepï¼Œä»æ‰€æœ‰æ²¡æœ‰è¢« sweep çš„ span ä¸­ï¼Œæ‰¾åˆ°èƒ½å¤Ÿåˆ†é…å½“å‰éœ€è¦å†…å­˜çš„ span ã€‚ä¸€ç›´ä¼šæ‰§è¡Œ 100 æ¬¡ï¼ˆGo >= 1.19 å‰æ˜¯æ­»å¾ªç¯ä¸€ç›´æ‰§è¡Œç›´åˆ°æ‰¾åˆ°æˆ–è€…å®Œæˆ sweep å·¥ä½œï¼‰ã€‚<p>æ‰€ä»¥å¦‚æœå­˜åœ¨å¤§é‡æ²¡æœ‰ç©ºä½™å¯¹è±¡å¯ä»¥åˆ†é…çš„ span ä¼šæå¤§å½±å“åˆ†é…å™¨æ•ˆç‡ã€‚<h5 id=åå°-bgsweep>åå° bgsweep</h5><p>bgsweep goroutine æ˜¯ä½ä¼˜å…ˆçº§çš„å¼‚æ­¥ sweepï¼Œåœ¨æ¯æ¬¡ GC Mark ç»“æŸåï¼Œä¼šè¢«å”¤èµ·ã€‚<p>æ¯ sweep 10 ä¸ª spanï¼Œå°±åˆ¤æ–­ä¸‹æ˜¯å¦æœ‰å…¶ä»– idle Pï¼Œæ²¡æœ‰å°± gosched è®©å…¶ä»– goroutine æ‰§è¡Œã€‚<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>bgsweep</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nf>sweep_10_span</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>goschedIfBusy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>goschedIfBusy</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>!</span><span class=nx>gp</span><span class=p>.</span><span class=nx>preempt</span> <span class=o>&amp;&amp;</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>npidle</span><span class=p>.</span><span class=nf>Load</span><span class=p>()</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nf>mcall</span><span class=p>(</span><span class=nx>gosched_m</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=è¡¡é‡-mark--sweep-å¼€é”€>è¡¡é‡ Mark & Sweep å¼€é”€</h3><p>ç³»ç»Ÿä¸­é€šå¸¸å­˜åœ¨ä¸¤ç§ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>longLife</span> <span class=p>=</span> <span class=p>[][]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>handler</span><span class=p>(</span><span class=nx>n</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>shortLife</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>n</span><span class=p>)</span> <span class=c1>// å› ä¸º n æ˜¯å˜é‡ï¼Œæ‰€ä»¥ shortLife ä¼šåˆ†é…åœ¨å †ä¸Š</span>
</span></span><span class=line><span class=cl>    <span class=nx>longLife</span><span class=p>[</span><span class=nx>n</span><span class=p>]</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=å¯¹äºçŸ­ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡>å¯¹äºçŸ­ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡</h4><h5 id=mark-å¼€é”€è¾ƒä½>Mark å¼€é”€è¾ƒä½</h5><p>å› ä¸º GC åªä¼šæ‰«æå½“å‰æœ‰æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼ŒçŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡å·²ç»æ²¡æœ‰ goroutine æŒæœ‰äº†ï¼Œæ‰€ä»¥ä¸éœ€è¦è¢«æ‰«æã€‚<h5 id=sweep-å¼€é”€è¾ƒä½>Sweep å¼€é”€è¾ƒä½</h5><p>ç†è®ºä¸Šï¼Œsweep å¼€é”€åº”è¯¥æ˜¯å’Œé•¿ç”Ÿå‘½å‘¨æœŸä¸€æ ·çš„ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼ŒRPC æœåŠ¡çš„å¯¹è±¡ä¸€èˆ¬æ˜¯çªç„¶åˆ†é…ä¸€æ³¢ï¼Œä¾‹å¦‚ RPC Request/Response ç»“æ„ä½“ï¼Œä¸”ç”±äºéœ€è¦åˆ†é…å¤§é‡å¯¹è±¡ï¼Œè¿™ç±»å¯¹è±¡å¤§æ¦‚ç‡éƒ½é›†ä¸­åœ¨ä¸€äº›ç‹¬å çš„ span ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´å¤šä¸ªå¯¹è±¡å ç”¨åŒä¸€ä¸ª spanï¼Œå³ span å¯†åº¦å¾ˆé«˜ ã€‚<p>è€Œ Sweep çš„å¼€é”€ä¸ span ä¸ªæ•°ç›¸å…³ï¼Œä¹Ÿå°±æ˜¯è¯´åŒæ ·çš„å¯¹è±¡æ•°é‡ï¼Œæ‰€æ¶‰åŠåˆ°çš„ span æ•°é‡æ›´å°‘ã€‚è€Œä¸”ä¸€æ—¦ Mark åï¼Œæ•´æ®µ span å‰©ä½™ç©ºé—´å¾ˆå¤§ï¼Œå¯ä»¥ç»§ç»­åˆ†é…ã€‚<h4 id=å¯¹äºé•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡>å¯¹äºé•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡</h4><h5 id=mark-å¼€é”€è¾ƒé«˜>Mark å¼€é”€è¾ƒé«˜</h5><p>ç”±äºæ¯æ¬¡ GC éƒ½éœ€è¦æ‰«æè¿™ç±»å¯¹è±¡ï¼Œå¦‚æœè¿™ç±»å¯¹è±¡å°±ä¸ä¼šé‡Šæ”¾ï¼Œè¿™é‡Œçš„æ‰«æéƒ½æ˜¯æµªè´¹çš„ã€‚<h5 id=sweep-å¼€é”€è¾ƒé«˜>Sweep å¼€é”€è¾ƒé«˜</h5><p>å’Œå‰é¢çš„åŸå› ä¸€æ ·ï¼Œä¸€ç›´éœ€è¦å»é‡å¤ sweep ç›¸åŒçš„ spanã€‚<p>æ­¤å¤–ï¼Œç”±äºè¿™ç±»å¯¹è±¡å¤§æ¦‚ç‡ä¹Ÿæ˜¯è¢«é›†ä¸­åˆ†é…å‡ºæ¥çš„ï¼Œæ‰€ä»¥ä»–ä»¬ä¹Ÿä¼šé›†ä¸­åœ¨å°éƒ¨åˆ† span ä¸­ï¼Œè€Œè¿™äº›å¯¹è±¡å¦‚æœæ•´ä½“éƒ½ä¸é‡Šæ”¾ï¼Œè¿™ç±» span çš„ç©ºä½™ç©ºé—´å¾ˆå°‘ï¼Œè¿™å°±å¯¼è‡´ malloc çš„æ—¶ï¼Œéœ€è¦å…ˆå»å¤„ç†è¿™äº› sweep å·¥ä½œï¼Œè¿›è€Œå¯¼è‡´åˆ†é…å»¶è¿Ÿæå¤§ã€‚<h3 id=numa-æ¶æ„ä¸‹-sweep-é¢å¤–çš„è®¿å­˜å»¶è¿Ÿ>NUMA æ¶æ„ä¸‹ Sweep é¢å¤–çš„è®¿å­˜å»¶è¿Ÿ</h3><p>NUMA æ¶æ„çš„ä¸€å¤§ç¼ºç‚¹æ˜¯åœ¨å‡ºç°è·¨ NUMA èŠ‚ç‚¹è®¿é—®å†…å­˜æ—¶ï¼Œä¼šå‡ºç°å·¨å¤§çš„è®¿é—®å†…å­˜å»¶è¿Ÿã€‚<p>æ­£å¸¸ Go ç¨‹åºéƒ½ç¬¦åˆå±€éƒ¨æ€§åŸç†ï¼Œä¸å¤ªå¯èƒ½å‡ºç°æé«˜å¯†åº¦è·¨èŠ‚ç‚¹è®¿é—®å†…å­˜çš„æƒ…å†µï¼Œä½†æ˜¯ sweep è¿‡ç¨‹ä¸ä¸€æ ·ï¼Œå®ƒçš„ä»£ç è®¾è®¡å°±æ˜¯ä¸åŒçº¿ç¨‹ä»ä¸€ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­å–å¯èƒ½åœ¨ä¸åŒ NUMA node ä¸Šåˆ†é…çš„åœ°å€ï¼Œæ‰€ä»¥è¿™ä¸ªé˜¶æ®µä¼šå‡ºç°å¤§é‡è·¨èŠ‚ç‚¹è®¿é—®å†…å­˜çš„æƒ…å†µã€‚<p>PSï¼šå…¶ä»–å¸¦ GC çš„è¯­è¨€å…¶å®ä¹Ÿæ˜¯è¿™å‡ å¹´æ‰å¼•å…¥ NUMA æ¶æ„çš„ä¼˜åŒ–çš„ï¼Œæ¯”å¦‚ <a href=https://blog.gceasy.io/2023/07/04/java-zgc-algorithm-tuning/>Java</a><h2 id=æ€»ç»“>æ€»ç»“</h2><p>æ ¹æ®ä¸Šé¢ç½—åˆ—çš„ä¼—å¤šçº¿ä¸Š Case æ€»ç»“ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å“ªæ€•æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„å¹¶å‘ç¨‹åºï¼Œä¹Ÿå¯èƒ½å¹¶éæˆ‘ä»¬å•çº¯ä»ç¨‹åºè‡ªèº«æ‰€çœ‹åˆ°çš„é‚£æ ·ç®€å•åœ°è¿è¡Œï¼Œæ—¢å¯èƒ½è¢«ç‰©ç†èµ„æºè®¾å®šæ‰€é—´æ¥å½±å“ï¼Œä¹Ÿå¯èƒ½è¢« Go Runtime æ³¨å…¥æ‰§è¡Œéä»£ç æ‰€æè¿°çš„ä¸ç›¸å…³ä»»åŠ¡ã€‚è¦åœ¨ä¸€ä¸ªè®¡ç®—èµ„æºä¸ç¨³å®šï¼Œæ‰§è¡Œä»£ç æ®µä¹Ÿä¸ç¨³å®šçš„ç°å®ä¸–ç•Œï¼Œå†™å‡ºä¸€æ®µæ‰§è¡Œæ—¶é—´ç¨³å®šçš„ Go ä»£ç å¹¶éæ˜“äº‹ã€‚<p>å³ä¾¿ Go ç¼–è¯‘å™¨åšå‡ºåè¶³çš„è¿›æ­¥ï¼Œä»¥è‡³äº Go é™æ€ç¼–è¯‘çš„å‡ºæ¥çš„ä»£ç æ€§èƒ½èƒ½å¤Ÿåª²ç¾ C ç¼–è¯‘å™¨ã€‚å®é™…è¿è¡Œæ—¶ï¼Œè¿™å¥— Runtime æœºåˆ¶ä¾ç„¶ä¼šé€ æˆç¨‹åº avg æ€§èƒ½æŒå¹³ C ä½†æ˜¯æœ‰ 1% çš„æ¦‚ç‡çªç„¶å»¶è¿ŸæŠ–åŠ¨ä¸€ä¸‹ã€‚è€Œå®é™…ä¸Šç ”å‘åœ¨åšæœåŠ¡å®¹é‡è§„åˆ’æ—¶ï¼Œçœ‹çš„å¾€å¾€å°±æ˜¯è¿™ 1% æ¦‚ç‡å‡ºç°çš„æ€§èƒ½çŸ­æ¿ï¼Œä¸ºè¿™ 1% çš„æƒ…å†µå †ä¸Šå¤§éƒ¨åˆ†æ—¶å€™å¯èƒ½å¹¶ç”¨ä¸åˆ°çš„è®¡ç®—èµ„æºã€‚<p>è™½ç„¶è¿™é‡Œçš„æ¯ä¸€ä¸ªå­é—®é¢˜æˆ–å¤šæˆ–å°‘éƒ½æœ‰ä¸€å®šçš„é€šç”¨è§£æ³•ï¼Œä½†å¯¹ç¨‹åºæ€§èƒ½å½±å“æœ€å¤§çš„å¾€å¾€å°±æ˜¯ç¨‹åºè‡ªèº«çš„ä»£ç ã€‚åªæœ‰äº†è§£è¿™äº›é™åˆ¶ä¸åŸç†ï¼Œæ‰èƒ½é’ˆå¯¹ä¸ç¡®å®šçš„ç°å®ä¸–ç•Œå†™å‡ºç›¸å¯¹æœ‰ç¡®å®šæ€§æ€§èƒ½çš„ä»£ç ã€‚</div><div class="row middle-xs"><div class=col-xs-12></div></div><div class=row><div class=col-xs-12><br><br><p>Subscribeï¼š<a target=_blank href=https://mailchi.mp/a1a0d59e7a19/joway><b>Mailchimp</b></a></p><br><a rel=license href=http://creativecommons.org/licenses/by-nc-nd/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://blog.joway.io/images/cc.png></a></div></div><div style=height:50px></div><div class=post-comments><div id=disqus_thread></div><script>window.addEventListener("load",()=>{(function(){var e=document,t=e.createElement("script");t.src="https://joway.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()})</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><div class=site-footer></div></div></div></article><script src=https://cdn.jsdelivr.net/gh/joway/blog/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("disqus_thread");if(!e)return;const t=new MutationObserver(function(n){n.forEach(function(){const n=e.getElementsByTagName("iframe");if(n.length>1){const s=n[1];for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(s),t.disconnect()}})});t.observe(e,{childList:!0,subtree:!0})})</script>