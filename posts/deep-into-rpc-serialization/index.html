<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.148.2"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Joway"><meta property="og:url" content="https://blog.joway.io/posts/deep-into-rpc-serialization/"><link rel=canonical href=https://blog.joway.io/posts/deep-into-rpc-serialization/><link rel=dns-prefetch href=https://cdn.jsdelivr.net/gh/joway/blog><link rel=apple-touch-icon href=/logo.png><link rel=icon href=/logo.png><link rel=shortcut href=/logo.png><link rel=alternate type=application/atom+xml href=https://blog.joway.io/index.xml title="Random Thoughts"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.joway.io\/"},"articleSection":"posts","name":"RPC æ¼«è°ˆï¼šåºåˆ—åŒ–é—®é¢˜","headline":"RPC æ¼«è°ˆï¼šåºåˆ—åŒ–é—®é¢˜","description":"ä½•ä¸ºåºåˆ— å¯¹äºè®¡ç®—æœºè€Œè¨€ï¼Œä¸€åˆ‡æ•°æ®çš†ä¸ºäºŒè¿›åˆ¶åºåˆ—ã€‚ä½†ç¼–ç¨‹äººå‘˜ä¸ºäº†ä»¥äººç±»å¯è¯»å¯æ§çš„å½¢å¼å¤„ç†è¿™äº›äºŒè¿›åˆ¶æ•°æ®ï¼Œäºæ˜¯å‘æ˜äº†æ•°æ®ç±»å‹å’Œç»“æ„çš„æ¦‚å¿µï¼Œæ•°æ®ç±»å‹ç”¨ä»¥æ ‡æ³¨ä¸€æ®µäºŒè¿›åˆ¶æ•°æ®çš„è§£ææ–¹å¼ï¼Œæ•°æ®ç»“æ„ç”¨ä»¥æ ‡æ³¨å¤šæ®µ(è¿ç»­\/ä¸è¿ç»­)äºŒè¿›åˆ¶æ•°æ®çš„ç»„ç»‡æ–¹å¼ã€‚\nä¾‹å¦‚ä»¥ä¸‹ç¨‹åºç»“æ„ä½“ï¼š\ntype User struct { Name string Email string } Name å’Œ Email åˆ†åˆ«è¡¨ç¤ºä¸¤å—ç‹¬ç«‹(æˆ–è¿ç»­ï¼Œæˆ–ä¸è¿ç»­)çš„å†…å­˜ç©ºé—´ï¼ˆæ•°æ®ï¼‰ï¼Œç»“æ„ä½“å˜é‡æœ¬èº«ä¹Ÿæœ‰ä¸€ä¸ªå†…å­˜åœ°å€ã€‚\nåœ¨å•è¿›ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†äº«è¯¥ç»“æ„ä½“åœ°å€æ¥äº¤æ¢æ•°æ®ã€‚ä½†å¦‚æœè¦å°†è¯¥æ•°æ®é€šè¿‡ç½‘ç»œä¼ è¾“ç»™å…¶ä»–æœºå™¨çš„è¿›ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦ç°å°†è¯¥ User å¯¹è±¡ä¸­ä¸åŒçš„å†…å­˜ç©ºé—´ï¼Œç¼–ç æˆä¸€æ®µè¿ç»­äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œæ­¤å³ä¸ºã€Œåºåˆ—åŒ–ã€ã€‚è€Œå¯¹ç«¯æœºå™¨æ”¶åˆ°äº†è¯¥äºŒè¿›åˆ¶æµä»¥åï¼Œè¿˜éœ€è¦èƒ½å¤Ÿè®¤å‡ºè¯¥æ•°æ®ä¸º User å¯¹è±¡ï¼Œè§£æä¸ºç¨‹åºå†…éƒ¨è¡¨ç¤ºï¼Œæ­¤å³ä¸ºã€Œååºåˆ—åŒ–ã€ã€‚\nåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå°±æ˜¯å°†åŒä¸€ä»½æ•°æ®ï¼Œåœ¨äººçš„è§†è§’å’Œæœºå™¨çš„è§†è§’ä¹‹é—´ç›¸äº’è½¬æ¢ã€‚\nåºåˆ—åŒ–è¿‡ç¨‹ å®šä¹‰æ¥å£æè¿°ï¼ˆIDLï¼‰ ä¸ºäº†ä¼ é€’æ•°æ®æè¿°ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†å¤šäººåä½œçš„è§„èŒƒï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå°†æè¿°ä¿¡æ¯å®šä¹‰åœ¨ä¸€ä¸ªç”± IDL(Interface Description Languages) ç¼–å†™çš„å®šä¹‰æ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ª Protobuf çš„ IDL å®šä¹‰ï¼š\nmessage User { string name = 1; string email = 2; } ç”Ÿæˆ Stub ä»£ç  æ— è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„åºåˆ—åŒ–æ–¹æ³•ï¼Œæœ€ç»ˆçš„ç›®çš„æ˜¯è¦å˜æˆç¨‹åºä¸­é‡Œçš„ä¸€ä¸ªå¯¹è±¡ï¼Œè™½ç„¶åºåˆ—åŒ–æ–¹æ³•å¾€å¾€æ˜¯è¯­è¨€æ— å…³çš„ï¼Œä½†è¿™æ®µå°†å†…å­˜ç©ºé—´ä¸ç¨‹åºå†…éƒ¨è¡¨ç¤ºï¼ˆå¦‚ struct\/classï¼‰ç›¸ç»‘å®šçš„è¿‡ç¨‹å´æ˜¯è¯­è¨€ç›¸å…³çš„ï¼Œæ‰€ä»¥å¾ˆå¤šåºåˆ—åŒ–åº“æ‰ä¼šéœ€è¦æä¾›å¯¹åº”çš„ç¼–è¯‘å™¨ï¼Œå°† IDL æ–‡ä»¶ç¼–è¯‘æˆç›®æ ‡è¯­è¨€çš„ Stub ä»£ç ã€‚\nStub ä»£ç å†…å®¹ä¸€èˆ¬åˆ†ä¸ºä¸¤å—ï¼š\nç±»å‹ç»“æ„ä½“ç”Ÿæˆï¼ˆå³ç›®æ ‡è¯­è¨€çš„ Struct[Golang]\/Class[Java] ï¼‰ åºåˆ—åŒ–\/ååºåˆ—åŒ–ä»£ç ç”Ÿæˆï¼ˆå°†äºŒè¿›åˆ¶æµä¸ç›®æ ‡è¯­è¨€ç»“æ„ä½“ç›¸è½¬æ¢ï¼‰ ä¸‹é¢æ˜¯ä¸€æ®µ Thrift ç”Ÿæˆçš„çš„åºåˆ—åŒ– Stub ä»£ç ï¼š\ntype User struct { Name string \u0060thrift:\u0026#34;name,1\u0026#34; db:\u0026#34;name\u0026#34; json:\u0026#34;name\u0026#34;\u0060 Email string \u0060thrift:\u0026#34;email,2\u0026#34; db:\u0026#34;email\u0026#34; json:\u0026#34;email\u0026#34;\u0060 } \/\/å†™å…¥ User struct func (p *User) Write(oprot thrift.TProtocol) error { if err := oprot.WriteStructBegin(\u0026#34;User\u0026#34;); err != nil { return thrift.PrependError(fmt.Sprintf(\u0026#34;%T write struct begin error: \u0026#34;, p), err) } if p != nil { if err := p.writeField1(oprot); err != nil { return err } if err := p.writeField2(oprot); err != nil { return err } } if err := oprot.WriteFieldStop(); err != nil { return thrift.PrependError(\u0026#34;write field stop error: \u0026#34;, err) } if err := oprot.WriteStructEnd(); err != nil { return thrift.PrependError(\u0026#34;write struct stop error: \u0026#34;, err) } return nil } \/\/ å†™å…¥ name å­—æ®µ func (p *User) writeField1(oprot thrift.TProtocol) (err error) { if err := oprot.WriteFieldBegin(\u0026#34;name\u0026#34;, thrift.STRING, 1); err != nil { return thrift.PrependError(fmt.Sprintf(\u0026#34;%T write field begin error 1:name: \u0026#34;, p), err) } if err := oprot.WriteString(string(p.Name)); err != nil { return thrift.PrependError(fmt.Sprintf(\u0026#34;%T.name (1) field write error: \u0026#34;, p), err) } if err := oprot.WriteFieldEnd(); err != nil { return thrift.PrependError(fmt.Sprintf(\u0026#34;%T write field end error 1:name: \u0026#34;, p), err) } return err } \/\/ å†™å…¥ email å­—æ®µ func (p *User) writeField2(oprot thrift.TProtocol) (err error) { if err := oprot.WriteFieldBegin(\u0026#34;email\u0026#34;, thrift.STRING, 2); err != nil { return thrift.PrependError(fmt.Sprintf(\u0026#34;%T write field begin error 2:email: \u0026#34;, p), err) } if err := oprot.WriteString(string(p.Email)); err != nil { return thrift.PrependError(fmt.Sprintf(\u0026#34;%T.email (2) field write error: \u0026#34;, p), err) } if err := oprot.WriteFieldEnd(); err != nil { return thrift.PrependError(fmt.Sprintf(\u0026#34;%T write field end error 2:email: \u0026#34;, p), err) } return err } å¯ä»¥çœ‹åˆ°ï¼Œä¸ºäº†æŠŠ User å¯¹è±¡ç»™åºåˆ—åŒ–æˆäºŒè¿›åˆ¶ï¼Œå®ƒ hard code äº†æ•´ä¸ªç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„ç»„ç»‡æ–¹å¼å’Œé¡ºåºï¼Œå¹¶ä¸”åˆ†åˆ«å¯¹æ¯ä¸ªå­—æ®µå»åšå¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚å¦‚æœæˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªå­—æ®µï¼Œå°±éœ€è¦é‡æ–°ç¼–è¯‘ Stub ä»£ç å¹¶è¦æ±‚æ‰€æœ‰ Client è¿›è¡Œå‡çº§æ›´æ–°ï¼ˆå½“ç„¶ä¸éœ€è¦ç”¨åˆ°æ–°å­—æ®µå¯ä»¥ä¸ç”¨æ›´æ–°ï¼‰ã€‚ååºåˆ—åŒ–çš„æ­¥éª¤ä¹Ÿæ˜¯ç±»ä¼¼ã€‚\n","inLanguage":"en-US","author":"Joway","creator":"Joway","publisher":"Joway","accountablePerson":"Joway","copyrightHolder":"Joway","copyrightYear":"2021","datePublished":"2021-04-30 00:00:00 \u002b0000 UTC","dateModified":"2021-04-30 00:00:00 \u002b0000 UTC","url":"https:\/\/blog.joway.io\/posts\/deep-into-rpc-serialization\/","keywords":["RPC","Service Mesh"]}</script><title>RPC æ¼«è°ˆï¼šåºåˆ—åŒ–é—®é¢˜</title><meta property="og:title" content="RPC æ¼«è°ˆï¼šåºåˆ—åŒ–é—®é¢˜"><meta property="og:type" content="article"><meta property="og:description" content='ä½•ä¸ºåºåˆ— å¯¹äºè®¡ç®—æœºè€Œè¨€ï¼Œä¸€åˆ‡æ•°æ®çš†ä¸ºäºŒè¿›åˆ¶åºåˆ—ã€‚ä½†ç¼–ç¨‹äººå‘˜ä¸ºäº†ä»¥äººç±»å¯è¯»å¯æ§çš„å½¢å¼å¤„ç†è¿™äº›äºŒè¿›åˆ¶æ•°æ®ï¼Œäºæ˜¯å‘æ˜äº†æ•°æ®ç±»å‹å’Œç»“æ„çš„æ¦‚å¿µï¼Œæ•°æ®ç±»å‹ç”¨ä»¥æ ‡æ³¨ä¸€æ®µäºŒè¿›åˆ¶æ•°æ®çš„è§£ææ–¹å¼ï¼Œæ•°æ®ç»“æ„ç”¨ä»¥æ ‡æ³¨å¤šæ®µ(è¿ç»­/ä¸è¿ç»­)äºŒè¿›åˆ¶æ•°æ®çš„ç»„ç»‡æ–¹å¼ã€‚
ä¾‹å¦‚ä»¥ä¸‹ç¨‹åºç»“æ„ä½“ï¼š
type User struct { Name string Email string } Name å’Œ Email åˆ†åˆ«è¡¨ç¤ºä¸¤å—ç‹¬ç«‹(æˆ–è¿ç»­ï¼Œæˆ–ä¸è¿ç»­)çš„å†…å­˜ç©ºé—´ï¼ˆæ•°æ®ï¼‰ï¼Œç»“æ„ä½“å˜é‡æœ¬èº«ä¹Ÿæœ‰ä¸€ä¸ªå†…å­˜åœ°å€ã€‚
åœ¨å•è¿›ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†äº«è¯¥ç»“æ„ä½“åœ°å€æ¥äº¤æ¢æ•°æ®ã€‚ä½†å¦‚æœè¦å°†è¯¥æ•°æ®é€šè¿‡ç½‘ç»œä¼ è¾“ç»™å…¶ä»–æœºå™¨çš„è¿›ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦ç°å°†è¯¥ User å¯¹è±¡ä¸­ä¸åŒçš„å†…å­˜ç©ºé—´ï¼Œç¼–ç æˆä¸€æ®µè¿ç»­äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œæ­¤å³ä¸ºã€Œåºåˆ—åŒ–ã€ã€‚è€Œå¯¹ç«¯æœºå™¨æ”¶åˆ°äº†è¯¥äºŒè¿›åˆ¶æµä»¥åï¼Œè¿˜éœ€è¦èƒ½å¤Ÿè®¤å‡ºè¯¥æ•°æ®ä¸º User å¯¹è±¡ï¼Œè§£æä¸ºç¨‹åºå†…éƒ¨è¡¨ç¤ºï¼Œæ­¤å³ä¸ºã€Œååºåˆ—åŒ–ã€ã€‚
åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå°±æ˜¯å°†åŒä¸€ä»½æ•°æ®ï¼Œåœ¨äººçš„è§†è§’å’Œæœºå™¨çš„è§†è§’ä¹‹é—´ç›¸äº’è½¬æ¢ã€‚
åºåˆ—åŒ–è¿‡ç¨‹ å®šä¹‰æ¥å£æè¿°ï¼ˆIDLï¼‰ ä¸ºäº†ä¼ é€’æ•°æ®æè¿°ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†å¤šäººåä½œçš„è§„èŒƒï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå°†æè¿°ä¿¡æ¯å®šä¹‰åœ¨ä¸€ä¸ªç”± IDL(Interface Description Languages) ç¼–å†™çš„å®šä¹‰æ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ª Protobuf çš„ IDL å®šä¹‰ï¼š
message User { string name = 1; string email = 2; } ç”Ÿæˆ Stub ä»£ç  æ— è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„åºåˆ—åŒ–æ–¹æ³•ï¼Œæœ€ç»ˆçš„ç›®çš„æ˜¯è¦å˜æˆç¨‹åºä¸­é‡Œçš„ä¸€ä¸ªå¯¹è±¡ï¼Œè™½ç„¶åºåˆ—åŒ–æ–¹æ³•å¾€å¾€æ˜¯è¯­è¨€æ— å…³çš„ï¼Œä½†è¿™æ®µå°†å†…å­˜ç©ºé—´ä¸ç¨‹åºå†…éƒ¨è¡¨ç¤ºï¼ˆå¦‚ struct/classï¼‰ç›¸ç»‘å®šçš„è¿‡ç¨‹å´æ˜¯è¯­è¨€ç›¸å…³çš„ï¼Œæ‰€ä»¥å¾ˆå¤šåºåˆ—åŒ–åº“æ‰ä¼šéœ€è¦æä¾›å¯¹åº”çš„ç¼–è¯‘å™¨ï¼Œå°† IDL æ–‡ä»¶ç¼–è¯‘æˆç›®æ ‡è¯­è¨€çš„ Stub ä»£ç ã€‚
Stub ä»£ç å†…å®¹ä¸€èˆ¬åˆ†ä¸ºä¸¤å—ï¼š
ç±»å‹ç»“æ„ä½“ç”Ÿæˆï¼ˆå³ç›®æ ‡è¯­è¨€çš„ Struct[Golang]/Class[Java] ï¼‰ åºåˆ—åŒ–/ååºåˆ—åŒ–ä»£ç ç”Ÿæˆï¼ˆå°†äºŒè¿›åˆ¶æµä¸ç›®æ ‡è¯­è¨€ç»“æ„ä½“ç›¸è½¬æ¢ï¼‰ ä¸‹é¢æ˜¯ä¸€æ®µ Thrift ç”Ÿæˆçš„çš„åºåˆ—åŒ– Stub ä»£ç ï¼š
type User struct { Name string `thrift:"name,1" db:"name" json:"name"` Email string `thrift:"email,2" db:"email" json:"email"` } //å†™å…¥ User struct func (p *User) Write(oprot thrift.TProtocol) error { if err := oprot.WriteStructBegin("User"); err != nil { return thrift.PrependError(fmt.Sprintf("%T write struct begin error: ", p), err) } if p != nil { if err := p.writeField1(oprot); err != nil { return err } if err := p.writeField2(oprot); err != nil { return err } } if err := oprot.WriteFieldStop(); err != nil { return thrift.PrependError("write field stop error: ", err) } if err := oprot.WriteStructEnd(); err != nil { return thrift.PrependError("write struct stop error: ", err) } return nil } // å†™å…¥ name å­—æ®µ func (p *User) writeField1(oprot thrift.TProtocol) (err error) { if err := oprot.WriteFieldBegin("name", thrift.STRING, 1); err != nil { return thrift.PrependError(fmt.Sprintf("%T write field begin error 1:name: ", p), err) } if err := oprot.WriteString(string(p.Name)); err != nil { return thrift.PrependError(fmt.Sprintf("%T.name (1) field write error: ", p), err) } if err := oprot.WriteFieldEnd(); err != nil { return thrift.PrependError(fmt.Sprintf("%T write field end error 1:name: ", p), err) } return err } // å†™å…¥ email å­—æ®µ func (p *User) writeField2(oprot thrift.TProtocol) (err error) { if err := oprot.WriteFieldBegin("email", thrift.STRING, 2); err != nil { return thrift.PrependError(fmt.Sprintf("%T write field begin error 2:email: ", p), err) } if err := oprot.WriteString(string(p.Email)); err != nil { return thrift.PrependError(fmt.Sprintf("%T.email (2) field write error: ", p), err) } if err := oprot.WriteFieldEnd(); err != nil { return thrift.PrependError(fmt.Sprintf("%T write field end error 2:email: ", p), err) } return err } å¯ä»¥çœ‹åˆ°ï¼Œä¸ºäº†æŠŠ User å¯¹è±¡ç»™åºåˆ—åŒ–æˆäºŒè¿›åˆ¶ï¼Œå®ƒ hard code äº†æ•´ä¸ªç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„ç»„ç»‡æ–¹å¼å’Œé¡ºåºï¼Œå¹¶ä¸”åˆ†åˆ«å¯¹æ¯ä¸ªå­—æ®µå»åšå¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚å¦‚æœæˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªå­—æ®µï¼Œå°±éœ€è¦é‡æ–°ç¼–è¯‘ Stub ä»£ç å¹¶è¦æ±‚æ‰€æœ‰ Client è¿›è¡Œå‡çº§æ›´æ–°ï¼ˆå½“ç„¶ä¸éœ€è¦ç”¨åˆ°æ–°å­—æ®µå¯ä»¥ä¸ç”¨æ›´æ–°ï¼‰ã€‚ååºåˆ—åŒ–çš„æ­¥éª¤ä¹Ÿæ˜¯ç±»ä¼¼ã€‚
'><meta name=description content='ä½•ä¸ºåºåˆ— å¯¹äºè®¡ç®—æœºè€Œè¨€ï¼Œä¸€åˆ‡æ•°æ®çš†ä¸ºäºŒè¿›åˆ¶åºåˆ—ã€‚ä½†ç¼–ç¨‹äººå‘˜ä¸ºäº†ä»¥äººç±»å¯è¯»å¯æ§çš„å½¢å¼å¤„ç†è¿™äº›äºŒè¿›åˆ¶æ•°æ®ï¼Œäºæ˜¯å‘æ˜äº†æ•°æ®ç±»å‹å’Œç»“æ„çš„æ¦‚å¿µï¼Œæ•°æ®ç±»å‹ç”¨ä»¥æ ‡æ³¨ä¸€æ®µäºŒè¿›åˆ¶æ•°æ®çš„è§£ææ–¹å¼ï¼Œæ•°æ®ç»“æ„ç”¨ä»¥æ ‡æ³¨å¤šæ®µ(è¿ç»­/ä¸è¿ç»­)äºŒè¿›åˆ¶æ•°æ®çš„ç»„ç»‡æ–¹å¼ã€‚
ä¾‹å¦‚ä»¥ä¸‹ç¨‹åºç»“æ„ä½“ï¼š
type User struct { Name string Email string } Name å’Œ Email åˆ†åˆ«è¡¨ç¤ºä¸¤å—ç‹¬ç«‹(æˆ–è¿ç»­ï¼Œæˆ–ä¸è¿ç»­)çš„å†…å­˜ç©ºé—´ï¼ˆæ•°æ®ï¼‰ï¼Œç»“æ„ä½“å˜é‡æœ¬èº«ä¹Ÿæœ‰ä¸€ä¸ªå†…å­˜åœ°å€ã€‚
åœ¨å•è¿›ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†äº«è¯¥ç»“æ„ä½“åœ°å€æ¥äº¤æ¢æ•°æ®ã€‚ä½†å¦‚æœè¦å°†è¯¥æ•°æ®é€šè¿‡ç½‘ç»œä¼ è¾“ç»™å…¶ä»–æœºå™¨çš„è¿›ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦ç°å°†è¯¥ User å¯¹è±¡ä¸­ä¸åŒçš„å†…å­˜ç©ºé—´ï¼Œç¼–ç æˆä¸€æ®µè¿ç»­äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œæ­¤å³ä¸ºã€Œåºåˆ—åŒ–ã€ã€‚è€Œå¯¹ç«¯æœºå™¨æ”¶åˆ°äº†è¯¥äºŒè¿›åˆ¶æµä»¥åï¼Œè¿˜éœ€è¦èƒ½å¤Ÿè®¤å‡ºè¯¥æ•°æ®ä¸º User å¯¹è±¡ï¼Œè§£æä¸ºç¨‹åºå†…éƒ¨è¡¨ç¤ºï¼Œæ­¤å³ä¸ºã€Œååºåˆ—åŒ–ã€ã€‚
åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå°±æ˜¯å°†åŒä¸€ä»½æ•°æ®ï¼Œåœ¨äººçš„è§†è§’å’Œæœºå™¨çš„è§†è§’ä¹‹é—´ç›¸äº’è½¬æ¢ã€‚
åºåˆ—åŒ–è¿‡ç¨‹ å®šä¹‰æ¥å£æè¿°ï¼ˆIDLï¼‰ ä¸ºäº†ä¼ é€’æ•°æ®æè¿°ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†å¤šäººåä½œçš„è§„èŒƒï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå°†æè¿°ä¿¡æ¯å®šä¹‰åœ¨ä¸€ä¸ªç”± IDL(Interface Description Languages) ç¼–å†™çš„å®šä¹‰æ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ª Protobuf çš„ IDL å®šä¹‰ï¼š
message User { string name = 1; string email = 2; } ç”Ÿæˆ Stub ä»£ç  æ— è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„åºåˆ—åŒ–æ–¹æ³•ï¼Œæœ€ç»ˆçš„ç›®çš„æ˜¯è¦å˜æˆç¨‹åºä¸­é‡Œçš„ä¸€ä¸ªå¯¹è±¡ï¼Œè™½ç„¶åºåˆ—åŒ–æ–¹æ³•å¾€å¾€æ˜¯è¯­è¨€æ— å…³çš„ï¼Œä½†è¿™æ®µå°†å†…å­˜ç©ºé—´ä¸ç¨‹åºå†…éƒ¨è¡¨ç¤ºï¼ˆå¦‚ struct/classï¼‰ç›¸ç»‘å®šçš„è¿‡ç¨‹å´æ˜¯è¯­è¨€ç›¸å…³çš„ï¼Œæ‰€ä»¥å¾ˆå¤šåºåˆ—åŒ–åº“æ‰ä¼šéœ€è¦æä¾›å¯¹åº”çš„ç¼–è¯‘å™¨ï¼Œå°† IDL æ–‡ä»¶ç¼–è¯‘æˆç›®æ ‡è¯­è¨€çš„ Stub ä»£ç ã€‚
Stub ä»£ç å†…å®¹ä¸€èˆ¬åˆ†ä¸ºä¸¤å—ï¼š
ç±»å‹ç»“æ„ä½“ç”Ÿæˆï¼ˆå³ç›®æ ‡è¯­è¨€çš„ Struct[Golang]/Class[Java] ï¼‰ åºåˆ—åŒ–/ååºåˆ—åŒ–ä»£ç ç”Ÿæˆï¼ˆå°†äºŒè¿›åˆ¶æµä¸ç›®æ ‡è¯­è¨€ç»“æ„ä½“ç›¸è½¬æ¢ï¼‰ ä¸‹é¢æ˜¯ä¸€æ®µ Thrift ç”Ÿæˆçš„çš„åºåˆ—åŒ– Stub ä»£ç ï¼š
type User struct { Name string `thrift:"name,1" db:"name" json:"name"` Email string `thrift:"email,2" db:"email" json:"email"` } //å†™å…¥ User struct func (p *User) Write(oprot thrift.TProtocol) error { if err := oprot.WriteStructBegin("User"); err != nil { return thrift.PrependError(fmt.Sprintf("%T write struct begin error: ", p), err) } if p != nil { if err := p.writeField1(oprot); err != nil { return err } if err := p.writeField2(oprot); err != nil { return err } } if err := oprot.WriteFieldStop(); err != nil { return thrift.PrependError("write field stop error: ", err) } if err := oprot.WriteStructEnd(); err != nil { return thrift.PrependError("write struct stop error: ", err) } return nil } // å†™å…¥ name å­—æ®µ func (p *User) writeField1(oprot thrift.TProtocol) (err error) { if err := oprot.WriteFieldBegin("name", thrift.STRING, 1); err != nil { return thrift.PrependError(fmt.Sprintf("%T write field begin error 1:name: ", p), err) } if err := oprot.WriteString(string(p.Name)); err != nil { return thrift.PrependError(fmt.Sprintf("%T.name (1) field write error: ", p), err) } if err := oprot.WriteFieldEnd(); err != nil { return thrift.PrependError(fmt.Sprintf("%T write field end error 1:name: ", p), err) } return err } // å†™å…¥ email å­—æ®µ func (p *User) writeField2(oprot thrift.TProtocol) (err error) { if err := oprot.WriteFieldBegin("email", thrift.STRING, 2); err != nil { return thrift.PrependError(fmt.Sprintf("%T write field begin error 2:email: ", p), err) } if err := oprot.WriteString(string(p.Email)); err != nil { return thrift.PrependError(fmt.Sprintf("%T.email (2) field write error: ", p), err) } if err := oprot.WriteFieldEnd(); err != nil { return thrift.PrependError(fmt.Sprintf("%T write field end error 2:email: ", p), err) } return err } å¯ä»¥çœ‹åˆ°ï¼Œä¸ºäº†æŠŠ User å¯¹è±¡ç»™åºåˆ—åŒ–æˆäºŒè¿›åˆ¶ï¼Œå®ƒ hard code äº†æ•´ä¸ªç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„ç»„ç»‡æ–¹å¼å’Œé¡ºåºï¼Œå¹¶ä¸”åˆ†åˆ«å¯¹æ¯ä¸ªå­—æ®µå»åšå¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚å¦‚æœæˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªå­—æ®µï¼Œå°±éœ€è¦é‡æ–°ç¼–è¯‘ Stub ä»£ç å¹¶è¦æ±‚æ‰€æœ‰ Client è¿›è¡Œå‡çº§æ›´æ–°ï¼ˆå½“ç„¶ä¸éœ€è¦ç”¨åˆ°æ–°å­—æ®µå¯ä»¥ä¸ç”¨æ›´æ–°ï¼‰ã€‚ååºåˆ—åŒ–çš„æ­¥éª¤ä¹Ÿæ˜¯ç±»ä¼¼ã€‚
'><meta property="og:locale" content="cn"><meta property="og:image" content="/logo.png"><style>:root{--bg-color:#ffffff;--text-color:#000000;--link-color:#000000;--border-color:#482936;--secondary-text:#666666;--code-bg:#f6f8fa;--blockquote-color:#57606a;--blockquote-border:#d0d7de;--disqus-bg:white}[data-theme=dark]{--bg-color:#1a1a1a;--text-color:#e0e0e0;--link-color:#b0b0b0;--border-color:#8b5a7a;--secondary-text:#aaaaaa;--code-bg:#2d2d2d;--blockquote-color:#a0a0a0;--blockquote-border:#404040;--disqus-bg:#1a1a1a}body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px;background-color:var(--bg-color);color:var(--text-color)}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:var(--link-color);text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:var(--link-color)}.markdown-body blockquote{margin:0;padding:0 1em;color:var(--blockquote-color);border-left:.25em solid var(--blockquote-border)}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px;background-color:var(--code-bg)}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:var(--code-bg);border-radius:6px}.markdown-body pre>code{padding:0;font-size:100%;background-color:var(--code-bg);border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:var(--secondary-text)}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:var(--border-color);border-style:solid none none none}.lang-switch{font-weight:600}.theme-toggle{background:0 0;border:none;color:var(--link-color);cursor:pointer;font-weight:600;font-size:inherit;padding:0}.theme-toggle:hover{font-weight:800}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:var(--text-color)2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:var(--text-color)2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:6px}.post-content .post-gallery{display:flex;flex-wrap:wrap;gap:6px}.post-content .post-gallery img{margin-right:auto;margin-top:auto;width:calc(50% - 3px)}.related-content{border-width:3px;border-style:solid;border-color:var(--text-color);padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:var(--disqus-bg)}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}.post-content .post-gallery img{width:100%}}@media screen and (max-width:48em){.posts-category{display:none}}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=https://cdn.jsdelivr.net/gh/joway/blog/index.xml rel=alternate type=application/rss+xml title="Random Thoughts"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel=stylesheet><script data-cfasync=false>(function(){const o="theme",e={light:"light",dark:"dark",system:"system"};function t(){return window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function s(){return localStorage.getItem(o)}function n(n){const s=document.documentElement;n===e.system&&(n=t()),n===e.dark?s.setAttribute("data-theme","dark"):s.removeAttribute("data-theme"),i(n)}function i(e){const t=document.getElementById("theme-toggle");t&&(t.textContent=e==="dark"?"â˜€ï¸":"ğŸŒ™")}function a(){const o=s();let i;o?(i=o===e.system?t():o,n(o)):(i=t(),n(e.system))}function r(){const a=s()||e.system;let i;a===e.system?i=t()==="dark"?e.light:e.dark:a===e.dark?i=e.light:i=e.dark,localStorage.setItem(o,i),n(i)}window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){const t=s();(!t||t===e.system)&&n(e.system)}),window.toggleTheme=r,a()})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53624533-8"></script><script src=https://cdn.jsdelivr.net/gh/joway/homepage/analytics.js></script><article class="post ç®€ä½“ä¸­æ–‡" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>Random Thoughts</a></div><div class=header-subtitle>Log something useless, but interesting.</div></header><div class="row end-md header-items"><div class=header-item><a href=https://mailchi.mp/a1a0d59e7a19/joway target=_blank>Subscribe</a></div><div class=header-item><a href=/travel target=_blank>Travel</a></div><div class=header-item><a href=https://joway.io target=_blank>About</a></div><div class=header-item><button id=theme-toggle onclick=toggleTheme() class=theme-toggle>ğŸŒ™</button></div></div><div class=row></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>RPC æ¼«è°ˆï¼šåºåˆ—åŒ–é—®é¢˜</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2021-04-30 00:00:00 UTC">30 Apr 2021</time></div><div class=col-xs-6><div class=post-author><a target=_blank href>@Joway</a></div></div></div></header><div class="post-content markdown-body"><h2 id=ä½•ä¸ºåºåˆ—>ä½•ä¸ºåºåˆ—</h2><p>å¯¹äºè®¡ç®—æœºè€Œè¨€ï¼Œä¸€åˆ‡æ•°æ®çš†ä¸ºäºŒè¿›åˆ¶åºåˆ—ã€‚ä½†ç¼–ç¨‹äººå‘˜ä¸ºäº†ä»¥äººç±»å¯è¯»å¯æ§çš„å½¢å¼å¤„ç†è¿™äº›äºŒè¿›åˆ¶æ•°æ®ï¼Œäºæ˜¯å‘æ˜äº†æ•°æ®ç±»å‹å’Œç»“æ„çš„æ¦‚å¿µï¼Œæ•°æ®ç±»å‹ç”¨ä»¥æ ‡æ³¨ä¸€æ®µäºŒè¿›åˆ¶æ•°æ®çš„è§£ææ–¹å¼ï¼Œæ•°æ®ç»“æ„ç”¨ä»¥æ ‡æ³¨å¤šæ®µ(è¿ç»­/ä¸è¿ç»­)äºŒè¿›åˆ¶æ•°æ®çš„ç»„ç»‡æ–¹å¼ã€‚<p>ä¾‹å¦‚ä»¥ä¸‹ç¨‹åºç»“æ„ä½“ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Email</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Name å’Œ Email åˆ†åˆ«è¡¨ç¤ºä¸¤å—ç‹¬ç«‹(æˆ–è¿ç»­ï¼Œæˆ–ä¸è¿ç»­)çš„å†…å­˜ç©ºé—´ï¼ˆæ•°æ®ï¼‰ï¼Œç»“æ„ä½“å˜é‡æœ¬èº«ä¹Ÿæœ‰ä¸€ä¸ªå†…å­˜åœ°å€ã€‚<p>åœ¨å•è¿›ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†äº«è¯¥ç»“æ„ä½“åœ°å€æ¥äº¤æ¢æ•°æ®ã€‚ä½†å¦‚æœè¦å°†è¯¥æ•°æ®é€šè¿‡ç½‘ç»œä¼ è¾“ç»™å…¶ä»–æœºå™¨çš„è¿›ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦ç°å°†è¯¥ User å¯¹è±¡ä¸­ä¸åŒçš„å†…å­˜ç©ºé—´ï¼Œç¼–ç æˆä¸€æ®µ<strong>è¿ç»­äºŒè¿›åˆ¶</strong>è¡¨ç¤ºï¼Œæ­¤å³ä¸ºã€Œåºåˆ—åŒ–ã€ã€‚è€Œå¯¹ç«¯æœºå™¨æ”¶åˆ°äº†è¯¥äºŒè¿›åˆ¶æµä»¥åï¼Œè¿˜éœ€è¦èƒ½å¤Ÿè®¤å‡ºè¯¥æ•°æ®ä¸º User å¯¹è±¡ï¼Œè§£æä¸ºç¨‹åºå†…éƒ¨è¡¨ç¤ºï¼Œæ­¤å³ä¸ºã€Œååºåˆ—åŒ–ã€ã€‚<p>åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå°±æ˜¯å°†åŒä¸€ä»½æ•°æ®ï¼Œåœ¨äººçš„è§†è§’å’Œæœºå™¨çš„è§†è§’ä¹‹é—´ç›¸äº’è½¬æ¢ã€‚<h2 id=åºåˆ—åŒ–è¿‡ç¨‹>åºåˆ—åŒ–è¿‡ç¨‹</h2><p><img src=../../images/rpc-serialization/overview.png alt><h3 id=å®šä¹‰æ¥å£æè¿°idl>å®šä¹‰æ¥å£æè¿°ï¼ˆIDLï¼‰</h3><p>ä¸ºäº†ä¼ é€’æ•°æ®æè¿°ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†å¤šäººåä½œçš„è§„èŒƒï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå°†æè¿°ä¿¡æ¯å®šä¹‰åœ¨ä¸€ä¸ªç”± IDL(Interface Description Languages) ç¼–å†™çš„å®šä¹‰æ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ª Protobuf çš„ IDL å®šä¹‰ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=kd>message</span> <span class=nc>User</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>name</span>  <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>email</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><h3 id=ç”Ÿæˆ-stub-ä»£ç >ç”Ÿæˆ Stub ä»£ç </h3><p>æ— è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„åºåˆ—åŒ–æ–¹æ³•ï¼Œæœ€ç»ˆçš„ç›®çš„æ˜¯è¦å˜æˆç¨‹åºä¸­é‡Œçš„ä¸€ä¸ªå¯¹è±¡ï¼Œè™½ç„¶åºåˆ—åŒ–æ–¹æ³•å¾€å¾€æ˜¯è¯­è¨€æ— å…³çš„ï¼Œä½†è¿™æ®µå°†å†…å­˜ç©ºé—´ä¸ç¨‹åºå†…éƒ¨è¡¨ç¤ºï¼ˆå¦‚ struct/classï¼‰ç›¸ç»‘å®šçš„è¿‡ç¨‹å´æ˜¯è¯­è¨€ç›¸å…³çš„ï¼Œæ‰€ä»¥å¾ˆå¤šåºåˆ—åŒ–åº“æ‰ä¼šéœ€è¦æä¾›å¯¹åº”çš„ç¼–è¯‘å™¨ï¼Œå°† IDL æ–‡ä»¶ç¼–è¯‘æˆç›®æ ‡è¯­è¨€çš„ Stub ä»£ç ã€‚<p>Stub ä»£ç å†…å®¹ä¸€èˆ¬åˆ†ä¸ºä¸¤å—ï¼š<ol><li>ç±»å‹ç»“æ„ä½“ç”Ÿæˆï¼ˆå³ç›®æ ‡è¯­è¨€çš„ Struct[Golang]/Class[Java] ï¼‰<li>åºåˆ—åŒ–/ååºåˆ—åŒ–ä»£ç ç”Ÿæˆï¼ˆå°†äºŒè¿›åˆ¶æµä¸ç›®æ ‡è¯­è¨€ç»“æ„ä½“ç›¸è½¬æ¢ï¼‰</ol><p>ä¸‹é¢æ˜¯ä¸€æ®µ Thrift ç”Ÿæˆçš„çš„åºåˆ—åŒ– Stub ä»£ç ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span> <span class=kt>string</span> <span class=s>`thrift:&#34;name,1&#34; db:&#34;name&#34; json:&#34;name&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Email</span> <span class=kt>string</span> <span class=s>`thrift:&#34;email,2&#34; db:&#34;email&#34; json:&#34;email&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//å†™å…¥ User struct</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>Write</span><span class=p>(</span><span class=nx>oprot</span> <span class=nx>thrift</span><span class=p>.</span><span class=nx>TProtocol</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>oprot</span><span class=p>.</span><span class=nf>WriteStructBegin</span><span class=p>(</span><span class=s>&#34;User&#34;</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>thrift</span><span class=p>.</span><span class=nf>PrependError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%T write struct begin error: &#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>),</span> <span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>p</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>writeField1</span><span class=p>(</span><span class=nx>oprot</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>err</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>writeField2</span><span class=p>(</span><span class=nx>oprot</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>err</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>oprot</span><span class=p>.</span><span class=nf>WriteFieldStop</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>thrift</span><span class=p>.</span><span class=nf>PrependError</span><span class=p>(</span><span class=s>&#34;write field stop error: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>oprot</span><span class=p>.</span><span class=nf>WriteStructEnd</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>thrift</span><span class=p>.</span><span class=nf>PrependError</span><span class=p>(</span><span class=s>&#34;write struct stop error: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å†™å…¥ name å­—æ®µ</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>writeField1</span><span class=p>(</span><span class=nx>oprot</span> <span class=nx>thrift</span><span class=p>.</span><span class=nx>TProtocol</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>oprot</span><span class=p>.</span><span class=nf>WriteFieldBegin</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=nx>thrift</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>thrift</span><span class=p>.</span><span class=nf>PrependError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%T write field begin error 1:name: &#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>),</span> <span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>oprot</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Name</span><span class=p>));</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>thrift</span><span class=p>.</span><span class=nf>PrependError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%T.name (1) field write error: &#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>),</span> <span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>oprot</span><span class=p>.</span><span class=nf>WriteFieldEnd</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>thrift</span><span class=p>.</span><span class=nf>PrependError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%T write field end error 1:name: &#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>),</span> <span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å†™å…¥ email å­—æ®µ</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>writeField2</span><span class=p>(</span><span class=nx>oprot</span> <span class=nx>thrift</span><span class=p>.</span><span class=nx>TProtocol</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>oprot</span><span class=p>.</span><span class=nf>WriteFieldBegin</span><span class=p>(</span><span class=s>&#34;email&#34;</span><span class=p>,</span> <span class=nx>thrift</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>thrift</span><span class=p>.</span><span class=nf>PrependError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%T write field begin error 2:email: &#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>),</span> <span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>oprot</span><span class=p>.</span><span class=nf>WriteString</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Email</span><span class=p>));</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>thrift</span><span class=p>.</span><span class=nf>PrependError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%T.email (2) field write error: &#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>),</span> <span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>oprot</span><span class=p>.</span><span class=nf>WriteFieldEnd</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>thrift</span><span class=p>.</span><span class=nf>PrependError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%T write field end error 2:email: &#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>),</span> <span class=nx>err</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸ºäº†æŠŠ User å¯¹è±¡ç»™åºåˆ—åŒ–æˆäºŒè¿›åˆ¶ï¼Œå®ƒ hard code äº†æ•´ä¸ªç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„ç»„ç»‡æ–¹å¼å’Œé¡ºåºï¼Œå¹¶ä¸”åˆ†åˆ«å¯¹æ¯ä¸ªå­—æ®µå»åšå¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚å¦‚æœæˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªå­—æ®µï¼Œå°±éœ€è¦é‡æ–°ç¼–è¯‘ Stub ä»£ç å¹¶è¦æ±‚æ‰€æœ‰ Client è¿›è¡Œå‡çº§æ›´æ–°ï¼ˆå½“ç„¶ä¸éœ€è¦ç”¨åˆ°æ–°å­—æ®µå¯ä»¥ä¸ç”¨æ›´æ–°ï¼‰ã€‚ååºåˆ—åŒ–çš„æ­¥éª¤ä¹Ÿæ˜¯ç±»ä¼¼ã€‚<p>ä¸Šè¿°è¿™æ®µå†—é•¿çš„ä»£ç è¿˜åªæ˜¯æˆ‘ä»¬ç”¨äºæ¼”ç¤ºçš„ä¸€ä¸ªæœ€ç®€å•çš„æ¶ˆæ¯ç»“æ„ï¼Œå¯¹äºç”Ÿäº§ç¯å¢ƒä¸­çš„çœŸå®æ¶ˆæ¯ç±»å‹ï¼Œè¿™æ®µ Stub ä»£ç ä¼šæ›´åŠ å¤æ‚ã€‚<p>Stub ä»£ç ç”Ÿæˆåªæ˜¯ä¸ºäº†è§£å†³è·¨è¯­è¨€è°ƒç”¨çš„é—®é¢˜ï¼Œå¹¶ä¸æ˜¯å¿…é¡»é¡¹ã€‚å¦‚æœä½ çš„è°ƒç”¨æ–¹ä¸è¢«è°ƒç”¨æ–¹éƒ½æ˜¯åŒä¸€ç§è¯­è¨€ï¼Œä¸”æœªæ¥ä¸€å®šèƒ½å¤Ÿä¿è¯éƒ½æ˜¯åŒä¸€ç§è¯­è¨€ï¼Œè¿™ç§æƒ…å†µä¹Ÿä¼šé€‰æ‹©ç›´æ¥ç”¨ç›®æ ‡è¯­è¨€å»å†™ IDL å®šä¹‰ï¼Œè·³è¿‡ç¼–è¯‘çš„æ­¥éª¤ï¼Œä¾‹å¦‚ Thrift é‡Œçš„ <a href=https://github.com/airlift/drift>drift</a> é¡¹ç›®å°±æ˜¯åˆ©ç”¨ Java ç›´æ¥å»å†™å®šä¹‰æ–‡ä»¶ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ThriftStruct</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>email</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ThriftConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>User</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>email</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>email</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>email</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ThriftField</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ThriftField</span><span class=p>(</span><span class=n>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getEmail</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>email</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=åºåˆ—åŒ–é—®é¢˜>åºåˆ—åŒ–é—®é¢˜</h2><p>æ—©åœ¨ 1984 å¹´æå‡º <a href=http://web.eecs.umich.edu/~mosharaf/Readings/RPC.pdf>Remote Procedure Calls</a> æ¦‚å¿µæ—¶å€™ï¼Œå°±åŸºæœ¬å®šå‹äº†ä»Šå¤©æ•´ä¸ª RPC çš„æ¡†æ¶ã€‚åäººæ‰€åšçš„å„å¼ä¼˜åŒ–å’Œæ”¹é€ ï¼Œéƒ½æ˜¯åœ¨è¿™å¥—æ¡†æ¶ä¸‹åšå„ç§ trade offï¼Œä»¥è§£å†³ä¸åŒåœºæ™¯ä¸‹é‡åˆ°çš„ä¸åŒé—®é¢˜ã€‚<h3 id=stub-ä»£ç è†¨èƒ€>Stub ä»£ç è†¨èƒ€</h3><p>ä»å‰é¢çš„ <code>User</code> å¯¹è±¡ç”Ÿæˆçš„ Stub ä»£ç ä¸­æˆ‘ä»¬å·²ç»æ„Ÿå—åˆ°äº†è¿™ç§é’ˆå¯¹äºæ¯ä¸ªå­—æ®µåˆ†åˆ« hard code å¤„ç†äº§ç”Ÿçš„ä»£ç è†¨èƒ€é—®é¢˜ã€‚åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå•ä¸ªæœåŠ¡çš„ Stub ä»£ç è¶…è¿‡å‡ ä¸‡è¡Œä¹Ÿæ˜¯éå¸¸å¸¸è§çš„äº‹æƒ…ã€‚è™½ç„¶è¿™ç§æ–¹å¼å¯¹æœåŠ¡æ€§èƒ½å¹¶ä¸ä¼šæœ‰å½±å“ï¼Œä¸”ä¹Ÿæ— éœ€å·¥ç¨‹å¸ˆåšä»»ä½•é¢å¤–å·¥ä½œï¼Œä½†å½“é¡¹ç›®éå¸¸åºå¤§ä»¥åï¼Œä¼šé€ æˆä¸€äº›å¼€å‘ä½“éªŒä¸Šçš„æŸå¤±ã€‚æ¯”å¦‚ IDE åšè¯­æ³•åˆ†æé€Ÿåº¦ä¼šå˜æ…¢ï¼Œé¡¹ç›®æ‰“å¼€å¾ˆå¡ã€‚<p>Protobuf åœ¨å…¶å®˜æ–¹å®ç°ä¸­ï¼Œä½¿ç”¨çš„æ˜¯<strong>åå°„</strong>æ¥å¤„ç†äºŒè¿›åˆ¶ä¸ç¨‹åºå†…éƒ¨è¡¨ç¤ºé—´çš„è½¬æ¢ã€‚<p>åå°„çš„æœ¬è´¨æ˜¯åœ¨è¯­è¨€å±‚é¢æä¾›äº†ä¸€ç§æš´éœ²ç¨‹åºç°æœ‰ç±»å‹å’Œæ•°æ®çš„èƒ½åŠ›ï¼Œåœ¨è¿è¡Œæ—¶æˆ‘ä»¬ä»äºŒè¿›åˆ¶æ•°æ®ä¸­è§£æåˆ°å¯¹åº”å­—æ®µï¼Œç„¶åé€šè¿‡åå°„è·å–åˆ°å¯¹åº”ç¨‹åºå†…ç»“æ„ä½“çš„ Fieldï¼Œå¹¶å¯¹å…¶èµ‹å€¼ã€‚<p>è¿™ç§åšæ³•æ˜¾ç„¶ä¼šæ¯”ç¡¬ç¼–ç çš„æ–¹å¼è¦æ…¢å¾—å¤šï¼Œä¸»è¦éœ€è¦é¢å¤–åšä»¥ä¸‹äº‹æƒ…ï¼š<ol><li>æŸ¥è¯¢å½“å‰ç±»å‹ä¿¡æ¯<li>æ•°æ®ç±»å‹æ ¡éªŒ</ol><p>æ‰€ä»¥é€šè¿‡åå°„æ¥å‡å°‘ Stub ä»£ç é‡è°ˆä¸ä¸Šç®—æ˜¯ä»€ä¹ˆä¼˜åŒ–ï¼Œåªèƒ½è¯´æ˜¯åœ¨æ€§èƒ½å’Œä¾¿åˆ©æ€§æ–¹é¢é€‰æ‹©äº†ä¾¿åˆ©æ€§ã€‚åŒæ—¶ä¹Ÿæ–¹ä¾¿äº† Protobuf å¿«é€Ÿæ”¯æŒå…¶ä»–å¤šç§è¯­è¨€ã€‚<p>æœ‰æ„æ€çš„æ˜¯ï¼Œè™½ç„¶ Protobuf å®˜æ–¹ä½¿ç”¨çš„æ˜¯åå°„å®ç°ï¼Œä½†æ˜¯æœ‰ç›¸å½“ä¸€éƒ¨åˆ†äººä¸ºäº†æ›´é«˜çš„æ€§èƒ½ï¼Œä½¿ç”¨çš„æ˜¯ç¤¾åŒºå¼€æºçš„ <a href=https://github.com/gogo/protobuf>gogo/protobuf</a>ã€‚ä¸‹é¢æ˜¯ä¸€æ®µ gogo protobuf ç¼–è¯‘åçš„ä»£ç ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>MarshalToSizedBuffer</span><span class=p>(</span><span class=nx>dAtA</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>i</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>dAtA</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=p>=</span> <span class=nx>i</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>l</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=p>=</span> <span class=nx>l</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>m</span><span class=p>.</span><span class=nx>XXX_unrecognized</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>i</span> <span class=o>-=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>XXX_unrecognized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>copy</span><span class=p>(</span><span class=nx>dAtA</span><span class=p>[</span><span class=nx>i</span><span class=p>:],</span> <span class=nx>m</span><span class=p>.</span><span class=nx>XXX_unrecognized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// åºåˆ—åŒ– email å­—æ®µ</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>Email</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>i</span> <span class=o>-=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>Email</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>copy</span><span class=p>(</span><span class=nx>dAtA</span><span class=p>[</span><span class=nx>i</span><span class=p>:],</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Email</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>i</span> <span class=p>=</span> <span class=nf>encodeVarintUser</span><span class=p>(</span><span class=nx>dAtA</span><span class=p>,</span> <span class=nx>i</span><span class=p>,</span> <span class=nb>uint64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>Email</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>		<span class=nx>i</span><span class=o>--</span>
</span></span><span class=line><span class=cl>		<span class=nx>dAtA</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=mh>0x12</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// åºåˆ—åŒ– name å­—æ®µ</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>i</span> <span class=o>-=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>copy</span><span class=p>(</span><span class=nx>dAtA</span><span class=p>[</span><span class=nx>i</span><span class=p>:],</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>i</span> <span class=p>=</span> <span class=nf>encodeVarintUser</span><span class=p>(</span><span class=nx>dAtA</span><span class=p>,</span> <span class=nx>i</span><span class=p>,</span> <span class=nb>uint64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>Name</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>		<span class=nx>i</span><span class=o>--</span>
</span></span><span class=line><span class=cl>		<span class=nx>dAtA</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=mh>0xa</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=nx>dAtA</span><span class=p>)</span> <span class=o>-</span> <span class=nx>i</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œgogo/protobuf ä¾ç„¶æ˜¯åœ¨è¯•å›¾ç”¨ç¡¬ç¼–ç æ¥æ›¿æ¢æ‰å®˜æ–¹çš„åå°„å®ç°ï¼Œæ‰€ä»¥æ‰èƒ½å¤Ÿæå‡æ€§èƒ½ã€‚<h3 id=å‡å°‘æ•°æ®ä¼ è¾“å¤§å°>å‡å°‘æ•°æ®ä¼ è¾“å¤§å°</h3><p>å¯¹äºä¸€èˆ¬æ€§çš„ä¸šåŠ¡æœåŠ¡æ¥è¯´ï¼ŒCPU èµ„æºä¼šå…ˆäºå†…å­˜å’Œç½‘ç»œæˆä¸ºä¸€ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆã€‚å¯¹äºè¿™ç±»æœåŠ¡æ¥è¯´ï¼Œæ—¶é—´å¾€å¾€æ¯”ç©ºé—´æ›´åŠ é‡è¦ã€‚ä½†ä¹Ÿæœ‰ä¸€äº›ååé‡æé«˜ï¼Œä¸šåŠ¡é€»è¾‘ç®€å•çš„æœåŠ¡ï¼ˆæ•°æ®åº“/æ¶ˆæ¯é˜Ÿåˆ—/&mldr;ï¼‰ï¼Œç½‘ç»œå¸¦å®½ä¼šä¼˜å…ˆäº CPU èƒ½å¤Ÿåˆ¶çº¦æœåŠ¡æ€§èƒ½çš„ç“¶é¢ˆï¼Œå¯¹äºè¿™ç±»ä¸šåŠ¡æˆ‘ä»¬éœ€è¦ç”¨æ—¶é—´æ¢ç©ºé—´ï¼Œå‹ç¼©æ•°æ®åŒ…ä½“ç§¯ã€‚<h4 id=ç¼–ç å‹ç¼©>ç¼–ç å‹ç¼©</h4><p>åœ¨åŸºæœ¬æ•°æ®ç±»å‹é‡Œï¼Œå­—ç¬¦ä¸²çš„å‹ç¼©æ–¹æ³•å·²ç»æœ‰éå¸¸å¤šå¸¸è§çš„æ–¹æ¡ˆï¼Œå¹¶ä¸”å¾€å¾€æ˜¯ç”±ä¸šåŠ¡æ–¹è‡ªå·±å®ç°ï¼Œæ‰€ä»¥è¿™é‡Œä¸å†èµ˜è¿°ã€‚é™¤äº†å­—ç¬¦ä¸²ä»¥å¤–ï¼Œä¸»è¦å°±æ˜¯ä¸€äº›æ•°å­—ç±»å‹ï¼šint32, int64, doubleã€‚<p>å‡å¦‚ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªä¸šåŠ¡é‡Œæœ‰ä¸€ä¸ªå­—æ®µè¡¨ç¤ºç”¨æˆ·å¯¹æŸæ¡æ¶ˆæ¯çš„ç‚¹èµæ•°ï¼Œå¯¹äºå¤§éƒ¨åˆ†æ¶ˆæ¯æ¥è¯´è¯¥å€¼å¾€å¾€éƒ½å¾ˆå°ï¼Œä½†å› ä¸ºæç«¯æƒ…å†µçš„å­˜åœ¨ï¼Œæˆ‘ä»¬ä¾ç„¶éœ€è¦ä½¿ç”¨ int32 ç±»å‹ï¼Œå¦‚æœæŒ‰ç…§åŸå§‹çš„äºŒè¿›åˆ¶ç¼–ç ï¼Œæ— è®ºå€¼æ˜¯å¤šå°‘éƒ½éœ€è¦ç”¨ 4 bytes å¤§å°çš„ç©ºé—´å ç”¨ã€‚é’ˆå¯¹è¿™ç§ä½¿ç”¨æƒ…å†µï¼Œå¸¸è§çš„æ€æƒ³æ˜¯ï¼Œç”¨ä¸€å¥—ç¼–ç çº¦å®šï¼Œä½¿å¾—å¯ä»¥æ ¹æ® int å€¼å¤§å°è¿›è¡ŒåŠ¨æ€æ‰©å±•ç¼–ç é•¿åº¦ã€‚<h5 id=varint-ç¼–ç >Varint ç¼–ç </h5><p>Varint çš„æ€æƒ³å¾ˆç®€å•ï¼Œæ¯ä¸€ä¸ªå­—èŠ‚æœ‰ 8 ä½ï¼Œæœ€é«˜ä½è¡¨ç¤ºä¸‹ä¸€ä¸ªå­—èŠ‚æ˜¯å¦è¿˜æ˜¯è¯¥æ•°å­—çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä½™ 7 ä½ç”¨åŸç è¡¥é½ã€‚ä¾‹å¦‚ï¼š<p><img src=../../images/rpc-serialization/varuint.png alt><p>ä½†æ˜¯å¯¹äºè´Ÿæ•°è€Œè¨€ï¼Œæœ€é«˜ä½ä¸€å®šæ˜¯ 1ï¼Œæ‰€ä»¥ varint ç¼–ç ä¸€å®šä¼šå˜æˆ 5 ä¸ªå­—èŠ‚ï¼Œåè€Œå¢åŠ äº†å¤§å°ã€‚<h5 id=zigzag-ç¼–ç >ZigZag ç¼–ç </h5><p>ä¸ºäº†è§£å†³ varint å¯¹è´Ÿæ•°ä¸å‹å¥½çš„é—®é¢˜ï¼Œä¸€ç§æ€æƒ³æ˜¯æŠŠæ•´ä¸ª int32 çš„ç©ºé—´æ˜ å°„åˆ° uint32 çš„ç©ºé—´ï¼Œç¼–ç åªéœ€è¦ uint32 ä¸­è¿›è¡Œï¼Œæœ€ååšä¸€å±‚æ˜ å°„è½¬æ¢ã€‚ZigZag å°±æ˜¯ä½¿ç”¨çš„è¿™ä¸ªæ€æƒ³ã€‚<h4 id=çœç•¥é»˜è®¤å€¼>çœç•¥é»˜è®¤å€¼</h4><p>è¿˜æœ‰ä¸€ç±»åšæ³•æ˜¯é€šè¿‡åŒç«¯å…±è¯†ï¼Œæ¥å‡å°‘ä¸€äº›é»˜è®¤å€¼çš„ä¼ è¾“ã€‚<p>ä¾‹å¦‚ä¸€ä¸ªå­—æ®µ <code>enable: bool</code> åœ¨ IDL æ–‡ä»¶é‡Œå®šä¹‰çš„é»˜è®¤å€¼ä¸º trueï¼Œå¦‚æœæˆ‘ä»¬å½“å‰æ•°æ®åŒ…éœ€è¦ä¼ è¾“çš„å€¼ä¹Ÿæ˜¯ä¸º trueï¼Œé‚£å°±æ²¡æœ‰æ„ä¹‰å»ä¼ è¾“è¿™ä¸ªå­—æ®µã€‚å®¢æˆ·ç«¯æ”¶åˆ°æ•°æ®åŒ…åï¼Œå¯ä»¥ä¾èµ– IDL å®šä¹‰å»è¿˜åŸå‡ºè¿™ä¸ªå€¼ã€‚ä½†æ˜¯è¿™ä¸ªå…±è¯†å®šä¹‰ä»¥åä¸€èˆ¬æ˜¯ä¸èƒ½å˜åŒ–çš„ï¼Œå¦åˆ™ä¼šå‡ºç°ä½ ä»¥ä¸ºä½ ä¼ çš„æ˜¯ trueï¼Œååºåˆ—åŒ–å¾—åˆ°çš„å´æ˜¯ false çš„ç»“æœã€‚é™¤éä½ èƒ½å¤Ÿåšåˆ°åŒæ—¶è®©æ‰€æœ‰æ¶‰åŠåˆ°çš„å‚ä¸æ–¹éƒ½æ›´æ–°é‡Œè‡ªå·±çš„ Stub ä»£ç ã€‚<h3 id=å†…å­˜æ“ä½œè¿‡å¤š>å†…å­˜æ“ä½œè¿‡å¤š</h3><p>å½±å“åºåˆ—åŒ–æ€§èƒ½çš„å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œåœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¼šé¢‘ç¹åˆ›å»ºå†…å­˜ï¼Œä¸€æ¥è¿™å½±å“åˆ°äº†åºåˆ—åŒ–é€Ÿåº¦ï¼ŒäºŒæ¥å¯¹äºæœ‰ GC çš„è¯­è¨€è¿™ä¹Ÿå¢åŠ äº†åƒåœ¾å›æ”¶å‹åŠ›ã€‚<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åºåˆ—åŒ–è¿‡ç¨‹çš„å†…å­˜ç”³è¯·ä¸è½¬æ¢æµç¨‹ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// === åºåˆ—åŒ– ===</span>
</span></span><span class=line><span class=cl><span class=nx>buf</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>1024</span><span class=p>)</span>          <span class=c1>//ç”³è¯·ä¸€æ®µç”¨æˆ·æ€ç¼“å†²åŒº</span>
</span></span><span class=line><span class=cl>      <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=o>||</span>
</span></span><span class=line><span class=cl><span class=nf>Marshal</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>buf</span><span class=p>)</span>                 <span class=c1>//å°† User å¯¹è±¡æ‰€æœ‰å­—æ®µç¼–ç æˆäºŒè¿›åˆ¶æ•°æ®</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=nb>copy</span><span class=p>(</span><span class=nx>buf</span><span class=p>[:],</span> <span class=nf>EncodeString</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=nb>copy</span><span class=p>(</span><span class=nx>buf</span><span class=p>[:],</span> <span class=nf>EncodeString</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>email</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=o>||</span>
</span></span><span class=line><span class=cl><span class=nx>io</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span>                      <span class=c1>//ç³»ç»Ÿè°ƒç”¨ï¼Œä»å†…æ ¸ç¼“å†²åŒºå°†æ•°æ®è¯»å…¥ç”¨æˆ·æ€ç¼“å†²åŒº</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// === ååºåˆ—åŒ– ===</span>
</span></span><span class=line><span class=cl><span class=nx>buf</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>1024</span><span class=p>)</span>          <span class=c1>//ç”³è¯·ä¸€æ®µç”¨æˆ·æ€ç¼“å†²åŒº</span>
</span></span><span class=line><span class=cl>      <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=o>||</span>
</span></span><span class=line><span class=cl><span class=nx>io</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span>                       <span class=c1>//ç³»ç»Ÿè°ƒç”¨ï¼Œä»å†…æ ¸ç¼“å†²åŒºå°†æ•°æ®è¯»å…¥ç”¨æˆ·æ€ç¼“å†²åŒº</span>
</span></span><span class=line><span class=cl>      <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=o>||</span>
</span></span><span class=line><span class=cl><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>buf</span><span class=p>):</span> <span class=nx>User</span>               <span class=c1>//æ ¹æ®ç¼–ç æ ¼å¼ï¼Œå¯¹äºŒè¿›åˆ¶æ•°æ®è¿›è¡Œç±»å‹è½¬æ¢</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=nx>name</span> <span class=o>:=</span> <span class=nf>DecodeString</span><span class=p>(</span><span class=nx>buf</span><span class=p>[:])</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=nx>email</span> <span class=o>:=</span> <span class=nf>DecodeString</span><span class=p>(</span><span class=nx>buf</span><span class=p>[:])</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹å‡ æ¬¡å†…å­˜æ“ä½œï¼š<ol><li>buf := make([]byte)ï¼šæ¯æ¬¡è§£æéƒ½éœ€è¦æœ‰ä¸€æ®µç‹¬å çš„ç”¨æˆ·æ€ç¼“å†²åŒºï¼Œç”¨äºä»å†…æ ¸ç¼“å†²åŒºè¯»å–æ•°æ®ã€‚å¤šæ¬¡è§£æé—´å¯ä»¥é‡ç”¨ã€‚<li>EncodeString/DecodeStringï¼šä»¥ string æ ¼å¼å¤„ç†æ•°æ®ã€‚ç”±äºè¿™é‡Œçš„ buf æ˜¯ä¼šè¢«é‡ç”¨çš„ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸èƒ½ç›´æ¥å¤ç”¨ buf çš„å†…å­˜ï¼Œéœ€è¦ä¸€æ¬¡æ‹·è´ã€‚å¦‚æœè¯¥å­—æ®µæ˜¯ä¸€ä¸ªéå¸¸å¤§çš„ fieldï¼Œä¾‹å¦‚è§†é¢‘æ•°æ®ï¼Œè¿™é‡Œçš„ copy å¼€é”€ä¼šéå¸¸å·¨å¤§ã€‚</ol><p>æœ¬æ–‡å…ˆä¸è€ƒè™‘å¦‚ä½•ä¼˜åŒ–å†…æ ¸æ€åˆ°ç”¨æˆ·æ€çš„æ‹·è´ï¼Œä»…ä»åºåˆ—åŒ–è§’åº¦è€ƒè™‘å¦‚ä½•å‡å°‘ç”¨æˆ·æ€çš„æ‹·è´ã€‚<h4 id=é¿å…å¤§-stringbytes-ç±»å‹çš„æ‹·è´>é¿å…å¤§ string/bytes ç±»å‹çš„æ‹·è´</h4><p>åœ¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥ä¸èƒ½ç›´æ¥ä½¿ç”¨ buf å†…çš„æ•°æ®ï¼Œæ˜¯å› ä¸ºè¿™æ®µæ•°æ®è¿˜è¦è¢«ä¸‹ä¸€æ¬¡åºåˆ—åŒ–/ååºåˆ—åŒ–é‡ç”¨ã€‚å¦‚æœæˆ‘ä»¬ä¸å†è€ƒè™‘é‡ç”¨ï¼Œæ¯ä¸ª buf éƒ½æ˜¯ä¸€æ¬¡è§£æå®Œæ•´ç”Ÿå‘½å‘¨æœŸç‹¬å çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥èµ‹å€¼è€Œä¸ç”¨æ‹·è´ã€‚å½“ç„¶è¿™ç§åšæ³•ä¸»è¦æ˜¯é’ˆå¯¹äº string å’Œ bytes ç±»å‹ï¼ˆä¹Ÿåªæœ‰è¿™ä¸¤ç§ç±»å‹ä¼šå‡ºç°è¶…å¤§ä¸å®šé•¿çš„å†…å­˜å ç”¨ï¼‰ï¼Œint/boolç­‰å…¶ä»–åŸºæœ¬ç±»å‹åœ¨åˆ›å»ºç»“æ„ä½“æ—¶ä¾¿å·²ç»ç”³è¯·äº†ç©ºé—´ã€‚<p>è¿™å—å¯ä»¥å‚è€ƒå­—èŠ‚è·³åŠ¨åœ¨å…¶ KiteX ä¸­æ‰€å®ç°çš„ <a href=https://www.infoq.cn/article/fea7chf9moohbxbtyres>Linkbuffer</a> ç»“æ„ã€‚åŸºæœ¬æ€è·¯æ˜¯æ¯æ¬¡è§£æå‰ï¼Œå…ˆç”³è¯·å¥½ä¸€å— Buffer åœ°å€ï¼ˆå¯ä»¥æ˜¯å…¶ä»–è§£æè¿‡ç¨‹é‡Šæ”¾çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–°å»ºçš„ï¼‰ï¼Œç„¶åæ•´ä¸ªç”Ÿå‘½å‘¨æœŸéƒ½ä½¿ç”¨è¿™ä¸€å—åœ°å€ã€‚ä½¿ç”¨ç»“æŸåé‡Šæ”¾(æ ‡è®° freeï¼Œå¹¶ä¸é‡Šæ”¾å†…å­˜) Bufferï¼Œç„¶åå¯ä»¥äº¤ç»™ä¸‹ä¸€æ¬¡åºåˆ—åŒ–ä½¿ç”¨ã€‚<h4 id=é¢„è®¡ç®—-buffer-å¤§å°>é¢„è®¡ç®— Buffer å¤§å°</h4><p>åœ¨æˆ‘ä»¬å»åšåºåˆ—åŒ–å‰ï¼Œæˆ‘ä»¬ä¾¿å·²ç»å¯ä»¥å¾—çŸ¥æœ€ç»ˆåºåˆ—åŒ–å®Œæˆæ—¶çš„ buffer å¤§å°ã€‚ç”šè‡³å¯¹äºé‚£äº›åªå«æœ‰åŸºæœ¬å®šé•¿æ•°æ®ç±»å‹çš„ç»“æ„ï¼Œæˆ‘ä»¬ç”šè‡³åœ¨ç¼–è¯‘æ—¶å°±èƒ½é¢„çŸ¥æœ€ç»ˆå¤§å°ã€‚å¯¹äºè¿™ç±»èƒ½å¤Ÿäº‹å…ˆçŸ¥é“ä½“ç§¯çš„ç»“æ„ï¼Œæˆ‘ä»¬åœ¨åºåˆ—åŒ–å‰ä¾¿å¯ä»¥åˆ›å»ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„ bufferï¼Œä»è€Œè®©æ•´ä¸ªåºåˆ—åŒ–è¿‡ç¨‹åªæœ‰ä¸€æ¬¡ mallocã€‚<h4 id=ç›´æ¥æ“ä½œ-buffer>ç›´æ¥æ“ä½œ Buffer</h4><p>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–æ˜¯å°†äºŒè¿›åˆ¶æ•°æ®ä¸ç¨‹åºå†…éƒ¨è¡¨ç¤ºç›´æ¥ç›¸è½¬æ¢ï¼Œæ‰å¼•èµ·åé¢çš„é‚£ä¹ˆå¤šé—®é¢˜ã€‚ä¸€ä¸ªæ›´åŠ ç›´æ¥è§£å†³é—®é¢˜çš„æ–¹å¼å°±æ˜¯æˆ‘ä»¬å¹²è„†å°±åˆ«åºåˆ—åŒ–äº†ï¼Œç›´æ¥æ“ä½œäºŒè¿›åˆ¶ã€‚æ­£æ‰€è°“ä¸è§£å†³é—®é¢˜ï¼Œè§£å†³æå‡ºé—®é¢˜çš„äººã€‚<p>Protobuf V2 çš„ä½œè€…ä» Google å‡ºæ¥åï¼Œå¼€å‘äº† <a href=https://capnproto.org/>Cap&rsquo;n Proto</a>ã€‚æœ‰è¶£çš„æ˜¯ï¼Œåæ¥ Google è‡ªå·±å†…éƒ¨åˆå¼€æºäº† <a href=https://google.github.io/flatbuffers/index.html>Flatbuffers</a>ã€‚è¿™ä¸¤ä¸ªé¡¹ç›®åŸºæœ¬æ€è·¯æ˜¯ä¸€æ ·çš„ï¼ŒStub ç”Ÿæˆä»£ç ç”¨ä»¥ç”Ÿæˆæ“ä½œæ•°æ®çš„æ¥å£ï¼Œè€Œè¿™äº›æ¥å£åº•å±‚ä¸æ˜¯åœ¨è¯»å†™æŸä¸ªç»“æ„ä½“ï¼Œè€Œæ˜¯ç›´æ¥æ“ä½œçš„æœ€ç»ˆåºåˆ—åŒ–çš„äºŒè¿›åˆ¶æ•°æ®ã€‚è¿™æ ·åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç›¸å½“äºéƒ½åœ¨åŒä¸€ä¸ªäºŒè¿›åˆ¶æ•°æ®ä¸Šè¿›è¡Œï¼Œå½“ç„¶ä¹Ÿå°±å¯ä»¥è®¤ä¸ºåºåˆ—åŒ–æ—¶é—´ä¸º 0ï¼Œæ€§èƒ½å¯ä»¥è¶…è¿‡ä»»ä½•åºåˆ—åŒ–æ¡†æ¶ã€‚<p>ä»¥ä¸‹æ˜¯ Cap&rsquo;n Proto ç”Ÿæˆçš„ä¸€æ®µä»£ç ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span><span class=p>{</span> <span class=nx>capnp</span><span class=p>.</span><span class=nx>Struct</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>User</span><span class=p>)</span> <span class=nf>Name</span><span class=p>()</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Struct</span><span class=p>.</span><span class=nf>Ptr</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nf>Text</span><span class=p>(),</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>User</span><span class=p>)</span> <span class=nf>SetName</span><span class=p>(</span><span class=nx>v</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Struct</span><span class=p>.</span><span class=nf>SetText</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>User</span><span class=p>)</span> <span class=nf>Email</span><span class=p>()</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Struct</span><span class=p>.</span><span class=nf>Ptr</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nf>Text</span><span class=p>(),</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>User</span><span class=p>)</span> <span class=nf>SetEmail</span><span class=p>(</span><span class=nx>v</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Struct</span><span class=p>.</span><span class=nf>SetText</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>ä»¥ä¸‹æ˜¯ Flatbuffers ç”Ÿæˆçš„ä¸€æ®µä»£ç ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>_tab</span> <span class=nx>flatbuffers</span><span class=p>.</span><span class=nx>Table</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rcv</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>Name</span><span class=p>()</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>o</span> <span class=o>:=</span> <span class=nx>flatbuffers</span><span class=p>.</span><span class=nf>UOffsetT</span><span class=p>(</span><span class=nx>rcv</span><span class=p>.</span><span class=nx>_tab</span><span class=p>.</span><span class=nf>Offset</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>o</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>rcv</span><span class=p>.</span><span class=nx>_tab</span><span class=p>.</span><span class=nf>ByteVector</span><span class=p>(</span><span class=nx>o</span> <span class=o>+</span> <span class=nx>rcv</span><span class=p>.</span><span class=nx>_tab</span><span class=p>.</span><span class=nx>Pos</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rcv</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>Email</span><span class=p>()</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>o</span> <span class=o>:=</span> <span class=nx>flatbuffers</span><span class=p>.</span><span class=nf>UOffsetT</span><span class=p>(</span><span class=nx>rcv</span><span class=p>.</span><span class=nx>_tab</span><span class=p>.</span><span class=nf>Offset</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>o</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>rcv</span><span class=p>.</span><span class=nx>_tab</span><span class=p>.</span><span class=nf>ByteVector</span><span class=p>(</span><span class=nx>o</span> <span class=o>+</span> <span class=nx>rcv</span><span class=p>.</span><span class=nx>_tab</span><span class=p>.</span><span class=nx>Pos</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>UserAddName</span><span class=p>(</span><span class=nx>builder</span> <span class=o>*</span><span class=nx>flatbuffers</span><span class=p>.</span><span class=nx>Builder</span><span class=p>,</span> <span class=nx>name</span> <span class=nx>flatbuffers</span><span class=p>.</span><span class=nx>UOffsetT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>builder</span><span class=p>.</span><span class=nf>PrependUOffsetTSlot</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>flatbuffers</span><span class=p>.</span><span class=nf>UOffsetT</span><span class=p>(</span><span class=nx>name</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>UserAddEmail</span><span class=p>(</span><span class=nx>builder</span> <span class=o>*</span><span class=nx>flatbuffers</span><span class=p>.</span><span class=nx>Builder</span><span class=p>,</span> <span class=nx>email</span> <span class=nx>flatbuffers</span><span class=p>.</span><span class=nx>UOffsetT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>builder</span><span class=p>.</span><span class=nf>PrependUOffsetTSlot</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nx>flatbuffers</span><span class=p>.</span><span class=nf>UOffsetT</span><span class=p>(</span><span class=nx>email</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ä¸¤ç§æ–¹å¼ç”Ÿæˆçš„ä»£ç éå¸¸ç›¸ä¼¼ï¼Œå¹¶ä¸”ç”Ÿæˆçš„ User struct æ²¡æœ‰åƒä¹‹å‰çš„åºåˆ—åŒ–æ¡†æ¶é‚£æ ·å¸¦ä¸Š <code>Name</code> å’Œ <code>Email</code> å­—æ®µï¼Œè€Œæ˜¯é€šè¿‡å‡½æ•°çš„æ–¹å¼è¯»å†™èƒ½åŠ›ã€‚<p>æˆ‘ä»¬å‰é¢è¯´äº†ï¼Œåºåˆ—åŒ–æœ¬èº«çš„æ„ä¹‰å°±åœ¨äºæä¾›äººå’Œæœºå™¨è§†è§’å¯¹æ•°æ®è®¤è¯†çš„ä¸€ç§è½¬æ¢ã€‚ä¼ ç»Ÿçš„æ€è·¯æ˜¯é€šè¿‡ä¸€ä¸ªä¸­é—´ç»“æ„ä½“ï¼Œè€Œè¿™ç±»æ–¹å¼æ˜¯é€šè¿‡æä¾›æ“ä½œå‡½æ•°ã€‚<p>ä¸è¿‡è¿™ç±»æ–¹å¼æœ‰ä¸€ä¸ªé€šç—…å°±æ˜¯ä»…ä»…åªæ˜¯æä¾›äº†æ“ä½œæ•°æ®çš„èƒ½åŠ›ï¼Œä½†æ˜¯ç‰ºç‰²äº†ç¨‹åºç¼–å†™è€…è‡ªå·±å»ç®¡ç†æ•°æ®çš„ä¾¿åˆ©æ€§ã€‚æ¯”å¦‚å¦‚æœæˆ‘ä»¬æƒ³çŸ¥é“è¿™ä¸ª User ç»“æ„æœ‰å“ªäº›å­—æ®µï¼Œé™¤éåºåˆ—åŒ–ç¼–è¯‘åçš„ä»£ç æä¾›ç»™äº†ä½ è¿™ä¸ªèƒ½åŠ›ï¼Œå¦åˆ™ä½ å°†å¯¹ä¸€ä¸²äºŒè¿›åˆ¶æ— ä»ä¸‹æ‰‹ã€‚æ¯”å¦‚ä½ æƒ³ç›´æ¥æŠŠè¿™ä¸ª User å¯¹è±¡å’Œä¸€äº› ORM å·¥å…·ç»„åˆå­˜è¿›æ•°æ®åº“ï¼Œä½ å¿…é¡»è‡ªå·±æ‰‹å†™ä¸€ä¸ªæ–°çš„ User structï¼Œç„¶åæŒ¨ä¸ªå­—æ®µèµ‹å€¼ã€‚<p>è¿™ç±»åºåˆ—åŒ–æ¡†æ¶å¤§å¤šç”¨åœ¨é‚£äº›æ•°æ®å®šä¹‰ä¸æ€ä¹ˆå˜åŒ–çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½æœåŠ¡ï¼Œä¾‹å¦‚æ•°æ®åº“ï¼Œæ¶ˆæ¯é˜Ÿåˆ—è¿™ç±»ã€‚å¦‚æœç”¨åœ¨æ—¥å¸¸ä¸šåŠ¡å¼€å‘ï¼Œæˆ–è®¸æ€§ä»·æ¯”ä¸æ˜¯å¾ˆé«˜ã€‚<h2 id=æœ€å>æœ€å</h2><p>æˆ‘ä»¬ç»å¸¸å¬åˆ°ç½‘ä¸Šæœ‰äººè®¨è®ºï¼Œå“ªä¸ªåºåˆ—åŒ–åè®®æ€§èƒ½æ›´å¥½ã€‚å…¶å®å¦‚æœæˆ‘ä»¬çœŸçš„è®¤çœŸå»ç ”ç©¶å„ç±»åºåˆ—åŒ–æ–¹æ¡ˆï¼Œå¾ˆå®¹æ˜“ä¼šå‘ç°ï¼Œåºåˆ—åŒ–åè®®æœ¬èº«åªæ˜¯ä¸€ä»½æ–‡æ¡£ï¼Œå®ƒçš„æ€§èƒ½ä¼˜åŠ£å–å†³äºä½ æ€ä¹ˆå»å®ç°ã€‚ä¸åŒè¯­è¨€å®ç°ï¼ŒåŒè¯­è¨€ä¸åŒæ–¹å¼æ–¹æ³•çš„å®ç°ï¼Œéƒ½ä¼šå¯¹æœ€ç»ˆçš„æ˜“ç”¨æ€§å’Œæ€§èƒ½äº§ç”Ÿå·¨å¤§çš„å½±å“ã€‚ä½ å®Œå…¨å¯ä»¥æŠŠ Protobuf çš„åè®®ç”¨ Flatbuffer çš„æ–¹å¼å»å®ç°ï¼Œèƒ½å¤Ÿæå‡éå¸¸å¤šçš„æ€§èƒ½ï¼Œä½†æœªå¿…å°±æ˜¯ä½ æƒ³è¦çš„ã€‚<p>ä¸æ€§èƒ½ç›¸æ¯”æ›´ä¸ºé‡è¦çš„æ˜¯å…ˆå¼„æ¸…æ¥šæˆ‘ä»¬åœ¨åºåˆ—åŒ–çš„å„ç§é—®é¢˜ä¸­ï¼Œå¸Œæœ›è§£å†³å“ªäº›ï¼Œæ„¿æ„æ”¾å¼ƒå“ªäº›ï¼Œæœ‰äº†æ˜ç¡®çš„éœ€æ±‚æ‰èƒ½é€‰æ‹©åˆ°é€‚åˆçš„åºåˆ—åŒ–æ–¹æ¡ˆï¼Œå¹¶ä¸”çœŸçš„é‡åˆ°é—®é¢˜æ—¶ä¹Ÿèƒ½å¿«é€ŸçŸ¥é“è¿™ä¸ªé—®é¢˜æ˜¯å¦æ˜¯å¯è§£çš„ï¼Œå¦‚ä½•è§£ã€‚</div><div class="row middle-xs"><div class=col-xs-12><div class=post-tags><a href=/tags/rpc/>RPC</a></div><div class=post-tags><a href=/tags/service-mesh/>Service Mesh</a></div></div></div><div class=row><div class=col-xs-12><br><br><p>Subscribeï¼š<a target=_blank href=https://mailchi.mp/a1a0d59e7a19/joway><b>Mailchimp</b></a></p><br><a rel=license href=http://creativecommons.org/licenses/by-nc-nd/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://blog.joway.io/images/cc.png></a></div></div><div class=related-content><h3>Related Posts</h3><ul><li><a href=/posts/deep-into-rpc-ratelimiter/>RPC æ¼«è°ˆï¼š é™æµé—®é¢˜</a></ul></div><div style=height:50px></div><div class=post-comments><div id=disqus_thread></div><script>window.addEventListener("load",()=>{(function(){var e=document,t=e.createElement("script");t.src="https://joway.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()})</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><div class=site-footer></div></div></div></article><script src=https://cdn.jsdelivr.net/gh/joway/blog/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("disqus_thread");if(!e)return;const t=new MutationObserver(function(n){n.forEach(function(){const n=e.getElementsByTagName("iframe");if(n.length>1){const s=n[1];for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(s),t.disconnect()}})});t.observe(e,{childList:!0,subtree:!0})})</script>