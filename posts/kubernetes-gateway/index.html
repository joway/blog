<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.148.2"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Joway"><meta property="og:url" content="https://blog.joway.io/posts/kubernetes-gateway/"><link rel=canonical href=https://blog.joway.io/posts/kubernetes-gateway/><link rel=dns-prefetch href=https://cdn.jsdelivr.net/gh/joway/blog><link rel=apple-touch-icon href=/logo.png><link rel=icon href=/logo.png><link rel=shortcut href=/logo.png><link rel=alternate type=application/atom+xml href=https://blog.joway.io/index.xml title="Random Thoughts"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.joway.io\/"},"articleSection":"posts","name":"Kubernetes ä¸­ä½¿ç”¨ API Gateway æ›¿ä»£ Ingress","headline":"Kubernetes ä¸­ä½¿ç”¨ API Gateway æ›¿ä»£ Ingress","description":"èƒŒæ™¯ æœ€è¿‘åœ¨æ„æ€åŸºäº Kubernetes å»ºç«‹ä¸€ä¸ªä¸ªäººçš„å¼€æ”¾äº‘å¹³å° , å¬èµ·æ¥æœ‰ç‚¹ä¸è‡ªé‡åŠ› , ä¸è¿‡ä½œä¸ºä¸ªäººä¸šä½™å°ç©æ„è¿˜æ˜¯è›®å¥½ç©çš„ã€‚æœ€ç»ˆçš„æˆå“å¸Œæœ›æ˜¯ç”¨æˆ·èƒ½å¤Ÿè½»æ¾åœ°åœ¨å¹³å°ä¸Šè·‘ä¸€äº›ç®€å•çš„æ— çŠ¶æ€æœåŠ¡ å’Œ cronjob ã€‚\nåœ¨æ­å»ºå¹³å°çš„æ—¶å€™é‡åˆ°çš„ç¬¬ä¸€ä¸ªå›°éš¾æ˜¯éœ€è¦æœ‰ä¸€ä¸ªå¥½ç”¨ä¸”åŠŸèƒ½å…¨é¢çš„ API Gateway , ä¸»æµçš„ç½‘å…³æœåŠ¡å¤§å¤šæ˜¯åŸºäº OpenResty åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘ , æ‰€éœ€è¦å®Œæˆçš„å·¥ä½œæ— éæ˜¯è´Ÿè½½å‡è¡¡ï¼Œå’Œ API ç®¡ç†, åŠ ä¸Šä¸€äº›é›¶é›¶ç¢ç¢çš„å°åŠŸèƒ½ã€‚\nè´Ÿè½½å‡è¡¡ è´Ÿè½½å‡è¡¡åˆ†ä¸ºå››å±‚å’Œä¸ƒå±‚ä¸¤ç§ , ä»¥å¤§å®¶æ‰€ç†ŸçŸ¥çš„ Nginx ä¸ºä¾‹ , åœ¨å®ƒçš„ conf æ–‡ä»¶ä¸­ , æœ‰ http {} å’Œ stream {} ä¸¤ç§ block ã€‚\n# å››å±‚è´Ÿè½½å‡è¡¡ stream { server { listen 80; proxy_pass app; } upstream app { server 172.31.0.1:8000; } } # ä¸ƒå±‚è´Ÿè½½å‡è¡¡ http { upstream app { server 192.168.0.1:8000; server 192.168.0.1:8001; } server { listen 80; location \/ { proxy_pass http:\/\/app; } } } å››å±‚è´Ÿè½½å‡è¡¡ å››å±‚è´Ÿè½½å‡è¡¡åªæ˜¯ä»èƒŒåé€‰æ‹©ä¸€ä¸ª server , è®©å…¶ä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ , å…¶æœ¬èº«å¹¶ä¸å‚ä¸è¿æ¥, åªæ˜¯ä½œä¸ºä¸€ä¸ªè·¯ç”±è½¬å‘ã€‚å¥½å¤„æ˜¯è¿™æ ·åšå®ƒçš„æ€§èƒ½ä¼šéå¸¸å¥½ï¼Œåå¤„æ˜¯å®ƒä¹Ÿä»…ä»…åªèƒ½ä½œä¸ºä¸€ä¸ªè´Ÿè½½å‡è¡¡å­˜åœ¨ï¼Œä½ æ— æ³•å¯¹å®ƒåšæ›´åŠ é«˜å±‚çš„å¤„ç†ï¼Œä¾‹å¦‚å›¾ç‰‡ä¼˜åŒ– , gzip å‹ç¼©ç­‰ã€‚å¹¶ä¸”ç”±äºå®ƒç›´æ¥å°†åç«¯æœåŠ¡æš´éœ²ç»™äº†å®¢æˆ·ç«¯, å½“é¢ä¸´ DDoS ç­‰æ”»å‡»æ—¶, åç«¯å°†ç›´æ¥æ‰¿å—å·¨é¢æµé‡ã€‚\n","inLanguage":"en-US","author":"Joway","creator":"Joway","publisher":"Joway","accountablePerson":"Joway","copyrightHolder":"Joway","copyrightYear":"2017","datePublished":"2017-09-12 00:00:00 \u002b0000 UTC","dateModified":"2017-09-12 00:00:00 \u002b0000 UTC","url":"https:\/\/blog.joway.io\/posts\/kubernetes-gateway\/","keywords":[]}</script><title>Kubernetes ä¸­ä½¿ç”¨ API Gateway æ›¿ä»£ Ingress</title><meta property="og:title" content="Kubernetes ä¸­ä½¿ç”¨ API Gateway æ›¿ä»£ Ingress"><meta property="og:type" content="article"><meta property="og:description" content="èƒŒæ™¯ æœ€è¿‘åœ¨æ„æ€åŸºäº Kubernetes å»ºç«‹ä¸€ä¸ªä¸ªäººçš„å¼€æ”¾äº‘å¹³å° , å¬èµ·æ¥æœ‰ç‚¹ä¸è‡ªé‡åŠ› , ä¸è¿‡ä½œä¸ºä¸ªäººä¸šä½™å°ç©æ„è¿˜æ˜¯è›®å¥½ç©çš„ã€‚æœ€ç»ˆçš„æˆå“å¸Œæœ›æ˜¯ç”¨æˆ·èƒ½å¤Ÿè½»æ¾åœ°åœ¨å¹³å°ä¸Šè·‘ä¸€äº›ç®€å•çš„æ— çŠ¶æ€æœåŠ¡ å’Œ cronjob ã€‚
åœ¨æ­å»ºå¹³å°çš„æ—¶å€™é‡åˆ°çš„ç¬¬ä¸€ä¸ªå›°éš¾æ˜¯éœ€è¦æœ‰ä¸€ä¸ªå¥½ç”¨ä¸”åŠŸèƒ½å…¨é¢çš„ API Gateway , ä¸»æµçš„ç½‘å…³æœåŠ¡å¤§å¤šæ˜¯åŸºäº OpenResty åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘ , æ‰€éœ€è¦å®Œæˆçš„å·¥ä½œæ— éæ˜¯è´Ÿè½½å‡è¡¡ï¼Œå’Œ API ç®¡ç†, åŠ ä¸Šä¸€äº›é›¶é›¶ç¢ç¢çš„å°åŠŸèƒ½ã€‚
è´Ÿè½½å‡è¡¡ è´Ÿè½½å‡è¡¡åˆ†ä¸ºå››å±‚å’Œä¸ƒå±‚ä¸¤ç§ , ä»¥å¤§å®¶æ‰€ç†ŸçŸ¥çš„ Nginx ä¸ºä¾‹ , åœ¨å®ƒçš„ conf æ–‡ä»¶ä¸­ , æœ‰ http {} å’Œ stream {} ä¸¤ç§ block ã€‚
# å››å±‚è´Ÿè½½å‡è¡¡ stream { server { listen 80; proxy_pass app; } upstream app { server 172.31.0.1:8000; } } # ä¸ƒå±‚è´Ÿè½½å‡è¡¡ http { upstream app { server 192.168.0.1:8000; server 192.168.0.1:8001; } server { listen 80; location / { proxy_pass http://app; } } } å››å±‚è´Ÿè½½å‡è¡¡ å››å±‚è´Ÿè½½å‡è¡¡åªæ˜¯ä»èƒŒåé€‰æ‹©ä¸€ä¸ª server , è®©å…¶ä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ , å…¶æœ¬èº«å¹¶ä¸å‚ä¸è¿æ¥, åªæ˜¯ä½œä¸ºä¸€ä¸ªè·¯ç”±è½¬å‘ã€‚å¥½å¤„æ˜¯è¿™æ ·åšå®ƒçš„æ€§èƒ½ä¼šéå¸¸å¥½ï¼Œåå¤„æ˜¯å®ƒä¹Ÿä»…ä»…åªèƒ½ä½œä¸ºä¸€ä¸ªè´Ÿè½½å‡è¡¡å­˜åœ¨ï¼Œä½ æ— æ³•å¯¹å®ƒåšæ›´åŠ é«˜å±‚çš„å¤„ç†ï¼Œä¾‹å¦‚å›¾ç‰‡ä¼˜åŒ– , gzip å‹ç¼©ç­‰ã€‚å¹¶ä¸”ç”±äºå®ƒç›´æ¥å°†åç«¯æœåŠ¡æš´éœ²ç»™äº†å®¢æˆ·ç«¯, å½“é¢ä¸´ DDoS ç­‰æ”»å‡»æ—¶, åç«¯å°†ç›´æ¥æ‰¿å—å·¨é¢æµé‡ã€‚
"><meta name=description content="èƒŒæ™¯ æœ€è¿‘åœ¨æ„æ€åŸºäº Kubernetes å»ºç«‹ä¸€ä¸ªä¸ªäººçš„å¼€æ”¾äº‘å¹³å° , å¬èµ·æ¥æœ‰ç‚¹ä¸è‡ªé‡åŠ› , ä¸è¿‡ä½œä¸ºä¸ªäººä¸šä½™å°ç©æ„è¿˜æ˜¯è›®å¥½ç©çš„ã€‚æœ€ç»ˆçš„æˆå“å¸Œæœ›æ˜¯ç”¨æˆ·èƒ½å¤Ÿè½»æ¾åœ°åœ¨å¹³å°ä¸Šè·‘ä¸€äº›ç®€å•çš„æ— çŠ¶æ€æœåŠ¡ å’Œ cronjob ã€‚
åœ¨æ­å»ºå¹³å°çš„æ—¶å€™é‡åˆ°çš„ç¬¬ä¸€ä¸ªå›°éš¾æ˜¯éœ€è¦æœ‰ä¸€ä¸ªå¥½ç”¨ä¸”åŠŸèƒ½å…¨é¢çš„ API Gateway , ä¸»æµçš„ç½‘å…³æœåŠ¡å¤§å¤šæ˜¯åŸºäº OpenResty åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘ , æ‰€éœ€è¦å®Œæˆçš„å·¥ä½œæ— éæ˜¯è´Ÿè½½å‡è¡¡ï¼Œå’Œ API ç®¡ç†, åŠ ä¸Šä¸€äº›é›¶é›¶ç¢ç¢çš„å°åŠŸèƒ½ã€‚
è´Ÿè½½å‡è¡¡ è´Ÿè½½å‡è¡¡åˆ†ä¸ºå››å±‚å’Œä¸ƒå±‚ä¸¤ç§ , ä»¥å¤§å®¶æ‰€ç†ŸçŸ¥çš„ Nginx ä¸ºä¾‹ , åœ¨å®ƒçš„ conf æ–‡ä»¶ä¸­ , æœ‰ http {} å’Œ stream {} ä¸¤ç§ block ã€‚
# å››å±‚è´Ÿè½½å‡è¡¡ stream { server { listen 80; proxy_pass app; } upstream app { server 172.31.0.1:8000; } } # ä¸ƒå±‚è´Ÿè½½å‡è¡¡ http { upstream app { server 192.168.0.1:8000; server 192.168.0.1:8001; } server { listen 80; location / { proxy_pass http://app; } } } å››å±‚è´Ÿè½½å‡è¡¡ å››å±‚è´Ÿè½½å‡è¡¡åªæ˜¯ä»èƒŒåé€‰æ‹©ä¸€ä¸ª server , è®©å…¶ä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ , å…¶æœ¬èº«å¹¶ä¸å‚ä¸è¿æ¥, åªæ˜¯ä½œä¸ºä¸€ä¸ªè·¯ç”±è½¬å‘ã€‚å¥½å¤„æ˜¯è¿™æ ·åšå®ƒçš„æ€§èƒ½ä¼šéå¸¸å¥½ï¼Œåå¤„æ˜¯å®ƒä¹Ÿä»…ä»…åªèƒ½ä½œä¸ºä¸€ä¸ªè´Ÿè½½å‡è¡¡å­˜åœ¨ï¼Œä½ æ— æ³•å¯¹å®ƒåšæ›´åŠ é«˜å±‚çš„å¤„ç†ï¼Œä¾‹å¦‚å›¾ç‰‡ä¼˜åŒ– , gzip å‹ç¼©ç­‰ã€‚å¹¶ä¸”ç”±äºå®ƒç›´æ¥å°†åç«¯æœåŠ¡æš´éœ²ç»™äº†å®¢æˆ·ç«¯, å½“é¢ä¸´ DDoS ç­‰æ”»å‡»æ—¶, åç«¯å°†ç›´æ¥æ‰¿å—å·¨é¢æµé‡ã€‚
"><meta property="og:locale" content="cn"><meta property="og:image" content="/logo.png"><style>:root{--bg-color:#ffffff;--text-color:#000000;--link-color:#000000;--border-color:#482936;--secondary-text:#666666;--code-bg:#f6f8fa;--blockquote-color:#57606a;--blockquote-border:#d0d7de;--disqus-bg:white}[data-theme=dark]{--bg-color:#1a1a1a;--text-color:#e0e0e0;--link-color:#b0b0b0;--border-color:#8b5a7a;--secondary-text:#aaaaaa;--code-bg:#2d2d2d;--blockquote-color:#a0a0a0;--blockquote-border:#404040;--disqus-bg:#1a1a1a}body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px;background-color:var(--bg-color);color:var(--text-color)}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:var(--link-color);text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:var(--link-color)}.markdown-body blockquote{margin:0;padding:0 1em;color:var(--blockquote-color);border-left:.25em solid var(--blockquote-border)}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px;background-color:var(--code-bg)}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:var(--code-bg);border-radius:6px}.markdown-body pre>code{padding:0;font-size:100%;background-color:var(--code-bg);border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:var(--secondary-text)}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:var(--border-color);border-style:solid none none none}.lang-switch{font-weight:600}.theme-toggle{background:0 0;border:none;color:var(--link-color);cursor:pointer;font-weight:600;font-size:inherit;padding:0}.theme-toggle:hover{font-weight:800}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:var(--text-color)2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:var(--text-color)2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:6px}.post-content .post-gallery{display:flex;flex-wrap:wrap;gap:6px}.post-content .post-gallery img{margin-right:auto;margin-top:auto;width:calc(50% - 3px)}.related-content{border-width:3px;border-style:solid;border-color:var(--text-color);padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:var(--disqus-bg)}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}.post-content .post-gallery img{width:100%}}@media screen and (max-width:48em){.posts-category{display:none}}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=https://cdn.jsdelivr.net/gh/joway/blog/index.xml rel=alternate type=application/rss+xml title="Random Thoughts"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53624533-8"></script><script src=https://cdn.jsdelivr.net/gh/joway/homepage/analytics.js></script><article class="post ç®€ä½“ä¸­æ–‡" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>Random Thoughts</a></div><div class=header-subtitle>Log something useless, but interesting.</div></header><div class="row end-md header-items"><div class=header-item><a href=https://mailchi.mp/a1a0d59e7a19/joway target=_blank>Subscribe</a></div><div class=header-item><a href=/travel target=_blank>Travel</a></div><div class=header-item><a href=https://joway.io target=_blank>About</a></div><div class=header-item><button id=theme-toggle onclick=toggleTheme() class=theme-toggle>ğŸŒ™</button></div></div><div class=row></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>Kubernetes ä¸­ä½¿ç”¨ API Gateway æ›¿ä»£ Ingress</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2017-09-12 00:00:00 UTC">12 Sep 2017</time></div><div class=col-xs-6><div class=post-author><a target=_blank href>@Joway</a></div></div></div></header><div class="post-content markdown-body"><h2 id=èƒŒæ™¯>èƒŒæ™¯</h2><p>æœ€è¿‘åœ¨æ„æ€åŸºäº Kubernetes å»ºç«‹ä¸€ä¸ªä¸ªäººçš„å¼€æ”¾äº‘å¹³å° , å¬èµ·æ¥æœ‰ç‚¹ä¸è‡ªé‡åŠ› , ä¸è¿‡ä½œä¸ºä¸ªäººä¸šä½™å°ç©æ„è¿˜æ˜¯è›®å¥½ç©çš„ã€‚æœ€ç»ˆçš„æˆå“å¸Œæœ›æ˜¯ç”¨æˆ·èƒ½å¤Ÿè½»æ¾åœ°åœ¨å¹³å°ä¸Šè·‘ä¸€äº›ç®€å•çš„æ— çŠ¶æ€æœåŠ¡ å’Œ cronjob ã€‚<p>åœ¨æ­å»ºå¹³å°çš„æ—¶å€™é‡åˆ°çš„ç¬¬ä¸€ä¸ªå›°éš¾æ˜¯éœ€è¦æœ‰ä¸€ä¸ªå¥½ç”¨ä¸”åŠŸèƒ½å…¨é¢çš„ API Gateway , ä¸»æµçš„ç½‘å…³æœåŠ¡å¤§å¤šæ˜¯åŸºäº OpenResty åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘ , æ‰€éœ€è¦å®Œæˆçš„å·¥ä½œæ— éæ˜¯è´Ÿè½½å‡è¡¡ï¼Œå’Œ API ç®¡ç†, åŠ ä¸Šä¸€äº›é›¶é›¶ç¢ç¢çš„å°åŠŸèƒ½ã€‚<h2 id=è´Ÿè½½å‡è¡¡>è´Ÿè½½å‡è¡¡</h2><p>è´Ÿè½½å‡è¡¡åˆ†ä¸ºå››å±‚å’Œä¸ƒå±‚ä¸¤ç§ , ä»¥å¤§å®¶æ‰€ç†ŸçŸ¥çš„ Nginx ä¸ºä¾‹ , åœ¨å®ƒçš„ conf æ–‡ä»¶ä¸­ , æœ‰ http {} å’Œ stream {} ä¸¤ç§ block ã€‚<pre><code># å››å±‚è´Ÿè½½å‡è¡¡
stream {
    server {
        listen 80;
        proxy_pass app;
    }

    upstream app {
        server 172.31.0.1:8000;
    }
}

# ä¸ƒå±‚è´Ÿè½½å‡è¡¡
http {
  upstream app {
    server 192.168.0.1:8000;
    server 192.168.0.1:8001;
  }

  server {
    listen          80;
    location / {
      proxy_pass      http://app;
    }
  }
}
</code></pre><h3 id=å››å±‚è´Ÿè½½å‡è¡¡>å››å±‚è´Ÿè½½å‡è¡¡</h3><p>å››å±‚è´Ÿè½½å‡è¡¡åªæ˜¯ä»èƒŒåé€‰æ‹©ä¸€ä¸ª server , è®©å…¶ä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ , å…¶æœ¬èº«å¹¶ä¸å‚ä¸è¿æ¥, åªæ˜¯ä½œä¸ºä¸€ä¸ªè·¯ç”±è½¬å‘ã€‚å¥½å¤„æ˜¯è¿™æ ·åšå®ƒçš„æ€§èƒ½ä¼šéå¸¸å¥½ï¼Œåå¤„æ˜¯å®ƒä¹Ÿä»…ä»…åªèƒ½ä½œä¸ºä¸€ä¸ªè´Ÿè½½å‡è¡¡å­˜åœ¨ï¼Œä½ æ— æ³•å¯¹å®ƒåšæ›´åŠ é«˜å±‚çš„å¤„ç†ï¼Œä¾‹å¦‚å›¾ç‰‡ä¼˜åŒ– , gzip å‹ç¼©ç­‰ã€‚å¹¶ä¸”ç”±äºå®ƒç›´æ¥å°†åç«¯æœåŠ¡æš´éœ²ç»™äº†å®¢æˆ·ç«¯, å½“é¢ä¸´ DDoS ç­‰æ”»å‡»æ—¶, åç«¯å°†ç›´æ¥æ‰¿å—å·¨é¢æµé‡ã€‚<h3 id=ä¸ƒå±‚è´Ÿè½½å‡è¡¡>ä¸ƒå±‚è´Ÿè½½å‡è¡¡</h3><p>ä¸ƒå±‚è´Ÿè½½å‡è¡¡å°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„åå‘ä»£ç†ï¼Œç›´æ¥å‚ä¸è¿æ¥ï¼Œæ˜¯æ¶åœ¨åç«¯æœåŠ¡å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ¡¥æ¢ã€‚å®ƒèƒ½å¤ŸçŸ¥é“ä»»ä½•å®¢æˆ·ç«¯èƒ½å¤ŸçŸ¥é“çš„ä»»ä½•ä¿¡æ¯ï¼Œå®ŒæˆåŒ…æ‹¬ cookie å¤„ç†, é‰´æƒç­‰ç­‰æ“ä½œã€‚ä»£ä»·æ˜¯å®ƒçš„æ€§èƒ½ä¼šæ¯”å››å±‚è´Ÿè½½å‡è¡¡ä½ï¼Œä½†ç”±äºå®¢æˆ·ç«¯ä¸ç›´æ¥ä¸ä»»ä½•åç«¯æœåŠ¡æ¥è§¦ï¼Œå®ƒèƒ½å¤Ÿè½»æ˜“åœ°è¿›è¡Œåç«¯æœåŠ¡è¿ç§»ï¼Œé™çº§ç­‰æ“ä½œã€‚<h3 id=kuberntes-ingress>kuberntes Ingress</h3><p>Kubernets çš„ Service å°±æ˜¯å±äºå››å±‚è´Ÿè½½å‡è¡¡ , ä½† Service ä¸Šçš„ ip éƒ½æ˜¯é›†ç¾¤å†…ç½‘çš„åœ°å€ , éœ€è¦åœ¨ Service ä¹‹ä¸Šå†å»ºç«‹ä¸€ä¸ªåå‘ä»£ç†æŠŠ Service æš´éœ²åˆ°å¤–ç½‘ ã€‚Kubernets è‡ªå¸¦ä¸€ä¸ª Ingress åŠŸèƒ½ , ä¸å…¶è¯´åŠŸèƒ½ï¼Œä¸å¦‚è¯´å°±æ˜¯æä¾›äº†ä¸€ä¸ªç±»ä¼¼ ConfigMap çš„æ¥å£åŠŸèƒ½ ï¼Œç”¨æˆ·å¯ä»¥ä»¥ <code>[ host - paths -> services ]</code> çš„å½¢å¼ , åœ¨ Ingress é‡Œå»ºç«‹ä¸€ä¸ªä¸ªæ˜ å°„è§„åˆ™ , ç„¶åå¯åŠ¨ä¸€ä¸ª Ingress Controller , Ingress Controller å°†è®¢é˜… Ingress é‡Œçš„é…ç½®è§„åˆ™å¹¶è½¬åŒ–æˆ Nginx çš„é…ç½® , ç„¶åå¯¹å¤–éƒ¨æä¾›æœåŠ¡ã€‚åœ¨å¯¹å¤–ç½‘æš´éœ²åœ°å€çš„æ—¶å€™, åªéœ€è¦æš´éœ² Ingress Controller è‡ªèº«å°±è¡Œäº†, æ‰€æœ‰æœåŠ¡å¯ä»¥è¢«éš”ç¦»åœ¨é›†ç¾¤å†…éƒ¨ã€‚<p>ä¸€èˆ¬åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šç»™ Ingress Controller çš„ Service æŒ‡å®šä¸€ä¸ª NodePort , è¿™æ ·æ¯å°æœºå™¨éƒ½èƒ½æœ‰ä¸€ä¸ªç«¯å£æ¥ä½œä¸º Ingress Controller çš„å…¥å£æ¥ä½¿ç”¨ , ç„¶åå†åœ¨ AWS æˆ– Google Cloud ä¸Šå»ºç«‹ä¸€ä¸ªè´Ÿè½½å‡è¡¡æŠŠæµé‡å¯¼å‘è¿™äº›æœºå™¨ä¸Šçš„ç«¯å£ , ä»è€Œä½¿ Ingress Controller çš„æµé‡è¢«åˆ†æ‘Šåˆ°æ¯å°æœºå™¨ä¸Š ã€‚è¯´èµ·æ¥å¾ˆç»• , ç›¸å½“äºä¸€ä¸ªè¯·æ±‚ç»è¿‡å±‚å±‚è·¯ç”±å™¨å , æœ€åæ‰“åˆ°ä½ æœåŠ¡å™¨ä¸Šï¼Œè¿˜è¦å†ç»è¿‡ä¸‰ä¸ªè´Ÿè½½å‡è¡¡å™¨ ã€‚<p>Ingress Controller å¹¶ä¸ä»…ä»…å±€é™äº Nginx ã€‚Kubernetes å®˜æ–¹æä¾›äº†è®¸å¤šç§é€‰æ‹©æ–¹æ¡ˆã€‚ä¾‹å¦‚ä½¿ç”¨ HAProxy æ¥æ›¿ä»£ Nginx : <a href=https://github.com/kubernetes/ingress/blob/master/examples/deployment/haproxy/README.md>haproxy ingress</a> ã€‚äº‹å®ä¸Šåªè¦è‡ªå·± watch å¥½ K8S Ingress çš„å˜åŒ–ï¼Œç„¶åç”Ÿæˆå¥½å¯¹åº”çš„ä»£ç†è§„åˆ™å®Œå…¨å¯ä»¥å®ç°ä¸€ä¸ªè‡ªå·±å®šåˆ¶çš„ Ingress Controller ã€‚<p>ä½†è¿™é‡Œæœ‰ä¸€ä¸ªå‘æ˜¯ Ingress çš„ spec å­—æ®µåªå…è®¸ä½ å†™å®ƒè§„åˆ™é‡Œçš„é…ç½®é¡¹, å¦‚æœä½ æƒ³åŠ å…¥åˆ«çš„å­—æ®µå°±ä¼šéå¸¸è›‹ç–¼äº†ã€‚è¿™ç§æƒ…å†µä¸‹ ï¼Œæˆ‘çœ‹åˆ°è¿‡çš„é¡¹ç›®ä¸€èˆ¬ä¼šæœ‰ä¸‰ç§æ–¹æ¡ˆ:<ol><li>ä¸€ç§æ˜¯ä½¿ç”¨ metadata.annotations å­—æ®µæ¥å†™é…ç½® , è¿™ä¸ªå­—æ®µå¯ä»¥éšæ„å†™ï¼Œä½†æ˜¯å¦‚æœä½ è¦é’ˆå¯¹ path åšé™å®šæ¡ä»¶ï¼Œè¿™ä¸ªæ–¹æ¡ˆå°±éå¸¸è›‹ç–¼äº†ã€‚<li>è¿˜æœ‰ä¸€ç§æ˜¯åœ¨æ‰€æœ‰é…ç½®éƒ½åœ¨ ConfigMap é‡Œå†™ , ä¸å†éœ€è¦ watch Ingress äº†ã€‚è¿™ç§åšæ³•å…¶å®å°±ä¸ç®—æ˜¯åœ¨å®ç° Ingress Controller äº† ï¼Œå› ä¸ºå®Œå…¨è„±ç¦»äº† Ingress è‡ªå·±çš„ä½¿ç”¨è§„èŒƒï¼Œä½†æ˜¯å¼‚å¸¸å¥½ç”¨ã€‚<li>ç¬¬ä¸‰ç§ä¹Ÿæ˜¯æœ€ä¸ºçµæ´»çš„è¿˜æ˜¯ç›´æ¥å†™è‡ªå·±çš„æ•°æ®åº“é‡Œï¼Œå®Œå…¨å’Œ k8s è„±ç¦»ã€‚Ingress è¿™ä¸ªé¡¹ç›®ä»¥ç›®å‰çš„è¶‹åŠ¿çœ‹ï¼Œé¡¶å¤šæˆä¸ºä¸€ä¸ª Demo ç±»å‹çš„äº§å“ï¼Œç¦»æˆä¸ºä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„ç½‘å…³æœåŠ¡è¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°ã€‚ä¾ç…§å®ƒçš„è§„èŒƒæ¥å»ºç«‹ç½‘å…³æœåŠ¡é™¤äº†è®©èƒ½å¤Ÿä½¿ç”¨ç°æˆçš„æ¥å£å’Œå‘½ä»¤è¡Œå·¥å…·å¤–ï¼Œçœ‹ä¸åˆ°ä»»ä½•çš„ä¼˜åŠ¿ã€‚</ol><h2 id=api-gatewat-é€‰å‹>API Gatewat é€‰å‹</h2><h3 id=åˆæ­¥éœ€æ±‚>åˆæ­¥éœ€æ±‚</h3><p>åœ¨äº†è§£æ¸…æ¥šäº†è¿™ä¸ªèƒŒæ™¯å¹¶ä¸”ç¡®è®¤äº† kubernets è‡ªèº«çŸ­æœŸå†…å¾ˆéš¾å†ä¸ºç¤¾åŒºæä¾›ä¸€ä¸ªå†…ç½®çš„ API Gateway ä»¥å ï¼Œå°±éœ€è¦ä» k8s ç”Ÿæ€å¤–éƒ¨å¯»æ±‚æ›´åŠ ä¼˜ç§€çš„è§£å†³æ–¹æ¡ˆè¿›è¡Œæ”¹é€ äº†ã€‚<p>æˆ‘å¯¹äº API Gateway çš„éœ€æ±‚æ˜¯ :<ul><li>èƒ½å¤Ÿæœ‰ä¸€ä¸ªç°æˆå¹¶ä¸”æ´»è·ƒçš„ç¤¾åŒº<li>èƒ½å¤Ÿå®ŒæˆåŸºæœ¬çš„ä¸ƒå±‚è´Ÿè½½å‡è¡¡éœ€æ±‚<li>èƒ½å¤Ÿæœ‰ä¸€ä¸ªä¼˜ç§€çš„ UI ç•Œé¢ç®¡ç† API<li>èƒ½å¤Ÿæ”¯æŒå¯¹éƒ¨åˆ† API è¿›è¡Œé‰´æƒ<li>ç”±äºæ˜¯ä¸šä½™æŠ˜è…¾æ‰€éœ€ï¼Œæ‰€ä»¥æˆ‘å¸Œæœ›å®‰è£…å’Œä½¿ç”¨è¶³å¤Ÿç®€å•ï¼Œä¸éœ€è¦åæœŸæŠ˜è…¾</ul><p>æ•´ä¸ªæµé‡çš„é“¾è·¯æ˜¯:<pre><code>å¤–éƒ¨æµé‡ 
-&gt; aws / google cloud load balance
-&gt; api gateway node port 
-&gt; servicename.namepsace 
-&gt; pod ip 
</code></pre><p>åŸºäºä¸Šè¿°ç›®çš„ï¼Œæœå¯»äº†ä¸€åœˆä»¥åï¼Œå‘ç°äº†ä¸¤ä¸ªä¸é”™çš„é¡¹ç›® : <a href=https://getkong.org/>Kong</a> å’Œ <a href=http://orange.sumory.com/docs/>Orange</a> ã€‚<h3 id=orange>Orange</h3><p>Orange åŸºäº Openresty å¼€å‘ï¼Œä»¿ç…§äº† Kong çš„æ€æƒ³ , ä½¿ç”¨äº†æ›´åŠ ç®€æ´å’Œç»Ÿä¸€è®¾è®¡ ã€‚ä½†å®ƒåªæ”¯æŒ mysql ä½œä¸ºæ•°æ®åº“ ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå®ƒçš„ API éƒ¨åˆ†ä½¿ç”¨äº†ä½œè€…å¦å¤–ç ”å‘çš„ä¸€å¥—æ¡†æ¶ Lor ï¼Œå¦å¤–å®ƒè¿˜å†…ç½®äº†ä¸€ä¸ªéå¸¸æ¼‚äº®ç®€æ´çš„ Dashboard ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå½“ä¸€ä¸ªè¯·æ±‚è¿›æ¥ä»¥åï¼Œä¼šæ ¹æ®å…¶ç‰¹å¾ï¼Œç»è¿‡å±‚å±‚è§„åˆ™ç­›é€‰ï¼Œæœ€ååŒ¹é…åˆ°ä¸€ä¸ªåç«¯æœåŠ¡ã€‚è§„åˆ™ä¼šç¼“å­˜åœ¨ share dict ä¸­ , æ‰€ä»¥å®ƒçš„æ€§èƒ½å’Œæ˜¯å¦ä»€ä¹ˆæ•°æ®åº“æ²¡æœ‰ä»€ä¹ˆå…³ç³» ã€‚<p>ä½†æŒ‰ç›®å‰ Orange çš„è®¾è®¡ä»¥åŠç¤¾åŒºçš„ä½¿ç”¨æƒ…å†µæ¥çœ‹ï¼Œå®ƒå¹¶æ²¡æœ‰æˆç†Ÿçš„ Kubernetes æ¶æ„ä¸‹ä½¿ç”¨çš„ä¾‹å­ï¼Œä¸è¿‡ Kuberntes ä¹Ÿå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„ä¸œè¥¿ï¼Œåˆ«çš„æ¶æ„èƒ½ç”¨è¿™é‡Œåº”è¯¥ä¹Ÿå·®ä¸å¤šï¼Œæ‰€ä»¥æˆ‘è¿˜æ˜¯æ–—èƒ†å°äº†ç¬¬ä¸€å£èƒèŸ¹ ã€‚<p>æ€»ä½“ç”¨ä¸‹æ¥ , åŸºæœ¬åŠŸèƒ½æ˜¯å¯ä»¥å®ç° , ä½†æ˜¯é™¤æ­¤ä¹‹å¤–å¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆåˆ«çš„é«˜é˜¶èƒ½åŠ›äº† ã€‚ä¸è¿‡å®ƒçš„ Dashboard çš„ç¡®å†™å¾—ä¸é”™ ï¼ŒåŸºäºæ¡ä»¶é…ç½®æ¯”åŸºäºè¡¨å•é…ç½®è¦å¥½å¾—å¤šã€‚æˆ‘åœ¨å…¬å¸å†…éƒ¨å°è¯•è¿‡ç»™æˆ‘ä»¬è‡ªå·±çš„ API Gateway å†™é…ç½®å‰ç«¯ï¼Œå†™å¾—å¼‚å¸¸ç—›è‹¦ï¼Œç”¨çš„äººæƒ³å¿…ä¹Ÿå¼‚å¸¸ç—›è‹¦ã€‚ä½†å½“æ—¶ä¹Ÿæƒ³ä¸åˆ°ä»€ä¹ˆå¥½çš„æ–¹æ³•ï¼Œå› ä¸ºæŠŠä¸€ä¸ªæœ‰å¾ˆé•¿æ·±åº¦çš„ json æ ‘ç»™æŠ½è±¡åˆ°è¡¨å•ä¸Šå»é…ç½®æœ¬èº«å°±æ˜¯ä¸€ä¸ªè´¼éº»çƒ¦çš„äº‹æƒ…ï¼Œåƒ AWS å¯¹äºè¿™äº›é…ç½®å‰ç«¯å®åœ¨æ²¡åŠæ³•åšäº†å¹²è„†å°±ç›´æ¥ç»™ä½ ä¸€ä¸ª json ç¼–è¾‘å™¨è®©ä½ æ‰‹å†™äº†ã€‚Orange ä¸åŒçš„æ˜¯ï¼Œå®ƒç›´æ¥ä»ç›®çš„å‡ºå‘ï¼Œæ—¢ç„¶ä½ æœ€ç»ˆæƒ³è¦çš„æ˜¯ä¸€ä¸ªè·¯ç”±è§„åˆ™ï¼Œé‚£æˆ‘å°±ä¸ç”¨ json å»ç”Ÿæˆè§„åˆ™ï¼Œè€Œæ˜¯ç›´æ¥è®©ä½ è‡ªå·±å»å†™è§„åˆ™ã€‚<p>ä¾‹å¦‚ ï¼Œæˆ‘åŸå…ˆéœ€è¦è¿™æ ·ä¸€ä¸ªè¡¨å• :<p><img src="https://ik.imagekit.io/elsetech/blog/images/old-blog/1505148736.png?tr=w-1024" alt><p>å®ƒæœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ , æˆ‘éœ€è¦äººè‚‰æŠŠä¸€ä¸ªè¡¨å•åœ¨å¤§è„‘å†…ç¼–è¯‘æˆä¸€ä¸ª nginx çš„é…ç½®è§„åˆ™ï¼Œ å¦‚æœä½ çš„ä¸€ä¸ªåŸŸååé¢æœ‰100ä¸ªåç«¯æœåŠ¡ï¼Œä½ è¿™ä¸ªè¡¨å•å°±éœ€è¦å†™100æ¬¡ï¼Œä¸”æ— æ³•å¤ç”¨è¡¨å•ã€‚<p>ä½†æ˜¯åœ¨ Orange é‡Œ , è¿™ä¸ªè¡¨å•å°±æ˜¯ :<pre><code>if host == xxx.joway.io 
if urls == /static
â€¦

then proxy : http://service-name:port
</code></pre><p><img src="https://ik.imagekit.io/elsetech/blog/images/old-blog/1505148844.png?tr=w-1024" alt><p>ä½ åªè¦åœ¨è¿™é‡Œé¢ä¸åœæ·»åŠ è§„åˆ™å°±è¡Œäº† , å¦‚æœä¸¤ä¸ªåç«¯æœåŠ¡åªæœ‰ä¸€ä¸ªæ¡ä»¶æ˜¯ä¸åŒçš„ï¼Œä½ åªè¦å†™ä¸€ä¸ª OR å°±è¡Œäº† , å¯ä»¥éå¸¸å®Œç¾çš„å¤ç”¨é…ç½® ã€‚<p>å½“ç„¶ Orange è¿˜æ˜¯æœ‰å¾ˆå¤šå‘çš„ã€‚æœ‰ä¸€ä¸ªå‘æ˜¯æˆ‘éœ€è¦æ‰‹åŠ¨åœ¨ orange çš„ nginx.conf æ–‡ä»¶é‡ŒæŠŠ resolver æ”¹æˆæˆ‘ Pod ä¸Šçš„ nameserver åœ°å€ ï¼Œå¦åˆ™å®ƒè§£æä¸åˆ°æˆ‘ k8s é‡Œçš„ service name ã€‚k8s è‡ªå·±ä¼šè·‘ä¸€ä¸ª kube-dns æ¥è§£ææ‰€æœ‰å†…å¤–ç½‘çš„åŸŸå , æ‰€ä»¥æˆ‘ä¸éœ€è¦å•ç‹¬ç»™å®ƒæŒ‡å®šç±»ä¼¼ 8.8.8.8 çš„åœ°å€ã€‚<p>è¿˜æœ‰ä¸€ä¸ªå‘æ˜¯ï¼Œå®ƒå®˜æ–¹æ¨èçš„é•œåƒæ¯ä¸€æ¬¡é‡å¯å®¹å™¨éƒ½ä¼šåˆå§‹åŒ–æ•°æ®åº“ â€¦â€¦ è¿™å¯¼è‡´æˆ‘ä¸€åº¦ä»¥ä¸ºè¿™ç©æ„çš„é…ç½®éƒ½æ˜¯å­˜åœ¨å†…å­˜é‡Œçš„ã€‚<p>æˆ‘æ”¹äº†ä¸‹å®˜æ–¹çš„æ¨èé•œåƒï¼Œç§»é™¤äº†å®ƒè‡ªå¸¦çš„ dnsmasq , é•œåƒåœ°å€åœ¨ <a href=https://github.com/joway/docker-orange-kubernetes>joway/docker-orange-kubernetes</a> ã€‚ ç¬¬ä¸€æ¬¡æŒ‡å®š <code>ORANGE_DB_SETUP</code> ç¯å¢ƒå˜é‡å°±èƒ½åˆå§‹åŒ–æ•°æ®åº“ã€‚<h3 id=kong>Kong</h3><p>Kong æ˜¯å¦å¤–ä¸€ä¸ªéå¸¸æ´»è·ƒçš„é¡¹ç›® , ä¸“é—¨é’ˆå¯¹å¾®æœåŠ¡è®¾è®¡çš„ï¼Œæ”¯æŒ cassandra å’Œ postgres ä¸¤ç§æ•°æ®åº“ã€‚å®ƒæœ‰ç€æœºå™¨ä¸°å¯Œçš„æ’ä»¶ ï¼Œ å¹¶ä¸”å·²ç»æœ‰éå¸¸å¤šçš„ kubernetes ç”Ÿäº§ç¯å¢ƒå®è·µä¾‹å­ã€‚å®ƒæ²¡æœ‰å®˜æ–¹è‡ªå¸¦çš„ dashboard , ä½†æœ‰ç¬¬ä¸‰æ–¹çš„é¡¹ç›®æä¾› UI ç•Œé¢ã€‚<p>æˆ‘ä½¿ç”¨çš„æ˜¯ konga (<a href=https://github.com/pantsel/konga>https://github.com/pantsel/konga</a>) è¿™ä¸ªé¡¹ç›®ã€‚ä» UI ä¸Šè®²ä¹Ÿæ˜¯éå¸¸ç¾è§‚çš„ï¼Œä½†æ˜¯åŠŸèƒ½ä¸Šè¿˜æ˜¯æ¯” Orange è¦å¤æ‚å’Œéš¾ç”¨ã€‚ä½†æ˜¯ç”±äº kong æ•´ä¸ªç¤¾åŒºçš„èƒŒä¹¦ï¼Œæˆ‘æœ€ç»ˆè¿˜æ˜¯é€‰æ‹©äº†å®ƒã€‚<p><img src="https://ik.imagekit.io/elsetech/blog/images/old-blog/1505150036.png?tr=w-1024" alt><p><img src="https://ik.imagekit.io/elsetech/blog/images/old-blog/1505150092.png?tr=w-1024" alt><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œkong æ”¯æŒé‡è¯•ç­–ç•¥ ï¼Œè¿™ä¸ªåŠŸèƒ½æœ‰åˆ©æœ‰å¼Šï¼Œå¥½å¤„æ˜¯å½“åç«¯æœåŠ¡ä¸ç¨³å®šçš„æ—¶å€™ï¼Œæ¯”å¦‚è®¿é—®100æ¬¡æœ‰5æ¬¡è¶…æ—¶ï¼Œè¿™ä¸ªæ—¶å€™å¯¹å®¢æˆ·ç«¯è€Œè¨€é¡¶å¤šæœ‰å‡ ä¸ªæœåŠ¡æ…¢äº†ä¸€äº›æ—¶é—´è€Œå·²ï¼Œä¸è‡³äºå¤±è´¥ã€‚ä½†åå¤„æ˜¯ï¼Œä¸€æ—¦æµé‡æ¥äº†ä¸€æ³¢é«˜å³°ï¼Œå¯¼è‡´åç«¯æœåŠ¡è¢«å‹è·¨äº†ä¸€éƒ¨åˆ†ï¼Œä½†å®ƒè¿˜åœ¨ä¸åœé‡è¯•ï¼Œå¯¼è‡´æµé‡è¢«æ”¾å¤§ï¼Œä»è€Œåç«¯æœåŠ¡æ›´åŠ æ— æ³•æ¢å¤è¿‡æ¥ï¼Œæœ€åé›ªå´©ã€‚å…³äºè¿™ä¸ªæˆ‘å¹¶æ²¡æœ‰åœ¨ Kong é‡Œæ‰¾åˆ°ç›¸åº”åº”å¯¹æªæ–½é…ç½®ï¼Œä½†å¦‚æœæ˜¯è‡ªå·±å†™çš„è¯ï¼Œå…¶å®å¯ä»¥åšä¸€ä¸ªä¸€å®šæ—¶é—´å…¨å±€æœ€å¤§é‡è¯•æ¬¡æ•°æ¥åŠ ä»¥æ§åˆ¶ã€‚</div><div class="row middle-xs"><div class=col-xs-12></div></div><div class=row><div class=col-xs-12><br><br><p>Subscribeï¼š<a target=_blank href=https://mailchi.mp/a1a0d59e7a19/joway><b>Mailchimp</b></a></p><br><a rel=license href=http://creativecommons.org/licenses/by-nc-nd/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://blog.joway.io/images/cc.png></a></div></div><div style=height:50px></div><div class=post-comments><div id=disqus_thread></div><script>window.addEventListener("load",()=>{(function(){var e=document,t=e.createElement("script");t.src="https://joway.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()})</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><div class=site-footer></div></div></div></article><script src=https://cdn.jsdelivr.net/gh/joway/blog/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script><script>(function(){const o="theme",e={light:"light",dark:"dark",system:"system"};function t(){return window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function s(){return localStorage.getItem(o)}function n(n){const s=document.documentElement;n===e.system&&(n=t()),n===e.dark?s.setAttribute("data-theme","dark"):s.removeAttribute("data-theme"),i(n)}function i(e){const t=document.getElementById("theme-toggle");t&&(t.textContent=e==="dark"?"â˜€ï¸":"ğŸŒ™")}function a(){const o=s();let i;o?(i=o===e.system?t():o,n(o)):(i=t(),n(e.system))}function r(){const a=s()||e.system;let i;a===e.system?i=t()==="dark"?e.light:e.dark:a===e.dark?i=e.light:i=e.dark,localStorage.setItem(o,i),n(i)}window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){const t=s();(!t||t===e.system)&&n(e.system)}),window.toggleTheme=r,a()})()</script><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("disqus_thread");if(!e)return;const t=new MutationObserver(function(n){n.forEach(function(){const n=e.getElementsByTagName("iframe");if(n.length>1){const s=n[1];for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(s),t.disconnect()}})});t.observe(e,{childList:!0,subtree:!0})})</script>